<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 8.0.1" />
    <title>Blood_Flow_1D.Topology API documentation</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2264%22%20height%3D%2264%22%20viewBox%3D%2244.5%202.5%2015%2015%22%3E%3Cpath%20d%3D%22M49.351%2021.041c-.233-.721-.546-2.408-.772-4.076-.042-.09-.067-.187-.046-.288-.166-1.347-.277-2.625-.241-3.351-1.378-1.008-2.271-2.586-2.271-4.362%200-.976.272-1.935.788-2.774.057-.094.122-.18.184-.268-.033-.167-.052-.339-.052-.516%200-1.477%201.202-2.679%202.679-2.679.791%200%201.496.352%201.987.9a6.3%206.3%200%200%201%201.001.029c.492-.564%201.207-.929%202.012-.929%201.477%200%202.679%201.202%202.679%202.679a2.65%202.65%200%200%201-.269%201.148c.383.747.595%201.572.595%202.41%200%202.311-1.507%204.29-3.635%205.107.037.699.147%202.27.423%203.294l.137.461c.156%202.136-4.612%205.166-5.199%203.215zm.127-4.919a4.78%204.78%200%200%200%20.775-.584c-.172-.115-.505-.254-.88-.378zm.331%202.302l.828-.502c-.202-.143-.576-.328-.984-.49zm.45%202.157l.701-.403c-.214-.115-.536-.249-.891-.376l.19.779zM49.13%204.141c0%20.152.123.276.276.276s.275-.124.275-.276-.123-.276-.276-.276-.275.124-.275.276zm.735-.389a1.15%201.15%200%200%201%20.314.783%201.16%201.16%200%200%201-1.162%201.162c-.457%200-.842-.27-1.032-.653-.026.117-.042.238-.042.362a1.68%201.68%200%200%200%201.679%201.679%201.68%201.68%200%200%200%201.679-1.679c0-.843-.626-1.535-1.436-1.654zm3.076%201.654a1.68%201.68%200%200%200%201.679%201.679%201.68%201.68%200%200%200%201.679-1.679c0-.037-.009-.072-.011-.109-.21.3-.541.508-.935.508a1.16%201.16%200%200%201-1.162-1.162%201.14%201.14%200%200%201%20.474-.912c-.015%200-.03-.005-.045-.005-.926.001-1.679.754-1.679%201.68zm1.861-1.265c0%20.152.123.276.276.276s.275-.124.275-.276-.123-.276-.276-.276-.275.124-.275.276zm1.823%204.823c0-.52-.103-1.035-.288-1.52-.466.394-1.06.64-1.717.64-1.144%200-2.116-.725-2.499-1.738-.383%201.012-1.355%201.738-2.499%201.738-.867%200-1.631-.421-2.121-1.062-.307.605-.478%201.267-.478%201.942%200%202.486%202.153%204.51%204.801%204.51s4.801-2.023%204.801-4.51zm-3.032%209.156l-.146-.492c-.276-1.02-.395-2.457-.444-3.268a6.11%206.11%200%200%201-1.18.115%206.01%206.01%200%200%201-2.536-.562l.006.175c.802.215%201.848.612%202.021%201.25.079.295-.021.601-.274.837l-.598.501c.667.304%201.243.698%201.311%201.179.02.144.022.507-.393.787l-.564.365c1.285.521%201.361.96%201.381%201.126.018.142.011.496-.427.746l-.854.489c.064-1.19%201.985-2.585%202.697-3.248zM49.34%209.925c0-.667%201-.667%201%200%200%20.653.818%201.205%201.787%201.205s1.787-.552%201.787-1.205c0-.667%201-.667%201%200%200%201.216-1.25%202.205-2.787%202.205s-2.787-.989-2.787-2.205zm-.887-7.633c-.093.077-.205.114-.317.114a.5.5%200%200%201-.318-.886L49.183.397a.5.5%200%200%201%20.703.068.5.5%200%200%201-.069.703zm7.661-.065c-.086%200-.173-.022-.253-.068l-1.523-.893c-.575-.337-.069-1.2.506-.863l1.523.892a.5.5%200%200%201%20.179.685c-.094.158-.261.247-.432.247z%22%20fill%3D%22%233bb300%22/%3E%3C/svg%3E"/>


<style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
<style>/*! pygments syntax highlighting */pre{line-height:125%;}td.linenos pre{color:#000000; background-color:#f0f0f0; padding-left:5px; padding-right:5px;}span.linenos{color:#000000; background-color:#f0f0f0; padding-left:5px; padding-right:5px;}td.linenos pre.special{color:#000000; background-color:#ffffc0; padding-left:5px; padding-right:5px;}span.linenos.special{color:#000000; background-color:#ffffc0; padding-left:5px; padding-right:5px;}.pdoc .hll{background-color:#ffffcc}.pdoc{background:#f8f8f8;}.pdoc .c{color:#408080; font-style:italic}.pdoc .err{border:1px solid #FF0000}.pdoc .k{color:#008000; font-weight:bold}.pdoc .o{color:#666666}.pdoc .ch{color:#408080; font-style:italic}.pdoc .cm{color:#408080; font-style:italic}.pdoc .cp{color:#BC7A00}.pdoc .cpf{color:#408080; font-style:italic}.pdoc .c1{color:#408080; font-style:italic}.pdoc .cs{color:#408080; font-style:italic}.pdoc .gd{color:#A00000}.pdoc .ge{font-style:italic}.pdoc .gr{color:#FF0000}.pdoc .gh{color:#000080; font-weight:bold}.pdoc .gi{color:#00A000}.pdoc .go{color:#888888}.pdoc .gp{color:#000080; font-weight:bold}.pdoc .gs{font-weight:bold}.pdoc .gu{color:#800080; font-weight:bold}.pdoc .gt{color:#0044DD}.pdoc .kc{color:#008000; font-weight:bold}.pdoc .kd{color:#008000; font-weight:bold}.pdoc .kn{color:#008000; font-weight:bold}.pdoc .kp{color:#008000}.pdoc .kr{color:#008000; font-weight:bold}.pdoc .kt{color:#B00040}.pdoc .m{color:#666666}.pdoc .s{color:#BA2121}.pdoc .na{color:#7D9029}.pdoc .nb{color:#008000}.pdoc .nc{color:#0000FF; font-weight:bold}.pdoc .no{color:#880000}.pdoc .nd{color:#AA22FF}.pdoc .ni{color:#999999; font-weight:bold}.pdoc .ne{color:#D2413A; font-weight:bold}.pdoc .nf{color:#0000FF}.pdoc .nl{color:#A0A000}.pdoc .nn{color:#0000FF; font-weight:bold}.pdoc .nt{color:#008000; font-weight:bold}.pdoc .nv{color:#19177C}.pdoc .ow{color:#AA22FF; font-weight:bold}.pdoc .w{color:#bbbbbb}.pdoc .mb{color:#666666}.pdoc .mf{color:#666666}.pdoc .mh{color:#666666}.pdoc .mi{color:#666666}.pdoc .mo{color:#666666}.pdoc .sa{color:#BA2121}.pdoc .sb{color:#BA2121}.pdoc .sc{color:#BA2121}.pdoc .dl{color:#BA2121}.pdoc .sd{color:#BA2121; font-style:italic}.pdoc .s2{color:#BA2121}.pdoc .se{color:#BB6622; font-weight:bold}.pdoc .sh{color:#BA2121}.pdoc .si{color:#BB6688; font-weight:bold}.pdoc .sx{color:#008000}.pdoc .sr{color:#BB6688}.pdoc .s1{color:#BA2121}.pdoc .ss{color:#19177C}.pdoc .bp{color:#008000}.pdoc .fm{color:#0000FF}.pdoc .vc{color:#19177C}.pdoc .vg{color:#19177C}.pdoc .vi{color:#19177C}.pdoc .vm{color:#19177C}.pdoc .il{color:#666666}</style>
<style>/*! pdoc */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f7f7f7;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}body{background-color:var(--pdoc-background);}html, body{width:100%;height:100%;}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}.git-button{display:none !important;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}#navtoggle{display:none;}}#togglestate{display:none;}nav.pdoc{--pad:1.75rem;--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc li{display:block;margin:0;padding:.2rem 0 .2rem var(--indent);transition:all 100ms;}nav.pdoc > div > ul > li{padding-left:0;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}html, main{scroll-behavior:smooth;}.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{background-color:var(--code);border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.pdoc details{--shift:-40px;text-align:right;margin-top:var(--shift);margin-bottom:calc(0px - var(--shift));clear:both;filter:opacity(1);}.pdoc details:not([open]){height:0;overflow:visible;}.pdoc details > summary{font-size:.75rem;cursor:pointer;color:var(--muted);border-width:0;padding:0 .7em;display:inline-block;display:inline list-item;user-select:none;}.pdoc details > summary:focus{outline:0;}.pdoc details > div{margin-top:calc(0px - var(--shift) / 2);text-align:left;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc > section:first-of-type > .docstring{margin-bottom:3rem;}.pdoc .docstring pre{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc .headerlink{position:absolute;width:0;margin-left:-1.5rem;line-height:1.4rem;font-size:1.5rem;font-weight:normal;transition:all 100ms ease-in-out;opacity:0;}.pdoc .attr > .headerlink{margin-left:-2.5rem;}.pdoc *:hover > .headerlink,.pdoc *:target > .attr > .headerlink{opacity:1;}.pdoc .attr{display:block;color:var(--text);margin:1rem 0 .5rem;padding:.4rem 5rem .4rem 1rem;background-color:var(--accent);}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{white-space:pre-wrap;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}</style>
</head>
<body>        <nav class="pdoc">
            <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
            <input id="togglestate" type="checkbox">
            <div>
                        <a class="pdoc-button module-list-button" href="../Blood_Flow_1D.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                            &nbsp;Blood_Flow_1D</a>


                        <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                               pattern=".+" required>



                    <h2>API Documentation</h2>
                        <ul class="memberlist">
            <li>
                    <a class="class" href="#Topology">Topology</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Topology.__init__">Topology</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.MapbifurcationstoVessels">MapbifurcationstoVessels</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.MapNodesToVesselID">MapNodesToVesselID</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.NodeVesselDict">NodeVesselDict</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.VesselGraph">VesselGraph</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.GetVesselNameFromNode">GetVesselNameFromNode</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.UpdateNodeType">UpdateNodeType</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.UpdateM2Names">UpdateM2Names</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.UpdateVesselAtlas">UpdateVesselAtlas</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.UpdateTopology">UpdateTopology</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.WriteNodesCSV">WriteNodesCSV</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.WriteVesselCSV">WriteVesselCSV</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.BifurcationDict">BifurcationDict</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.UpdateNumbers">UpdateNumbers</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.SetThickness">SetThickness</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.CheckConnectivity">CheckConnectivity</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.SaveVesselAtlas">SaveVesselAtlas</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.LoadSegmentedVessels_old">LoadSegmentedVessels_old</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.LoadSegmentedVessels">LoadSegmentedVessels</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.LoadBFSimFiles">LoadBFSimFiles</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.LoadTopFile">LoadTopFile</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.LoadParFile">LoadParFile</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.LoadRunFile">LoadRunFile</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.LoadClotFile">LoadClotFile</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.LoadVTPFile">LoadVTPFile</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.Load1DAnatomy">Load1DAnatomy</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.NumberNodes">NumberNodes</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.GetDownstreamVessels">GetDownstreamVessels</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.ReorderGens">ReorderGens</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.DownStreamResistance">DownStreamResistance</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.sumresvessels">sumresvessels</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.RedefineDirection">RedefineDirection</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.GetVesselsFromType">GetVesselsFromType</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.ReadNodesFromTopFile">ReadNodesFromTopFile</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.Read3DNodesFromTopFile">Read3DNodesFromTopFile</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.LoadVesselAtlas">LoadVesselAtlas</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.SetInletNodes">SetInletNodes</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.SetOutletNodes">SetOutletNodes</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.SetBifurcationNodes">SetBifurcationNodes</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.FindBifurcationNodes">FindBifurcationNodes</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.FindOutletNodes">FindOutletNodes</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.FindlargestInlets">FindlargestInlets</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.ApplyTransformation">ApplyTransformation</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.AnatomyToVessels">AnatomyToVessels</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.removebifurcation">removebifurcation</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.TopologyToVTP">TopologyToVTP</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.GetMapping">GetMapping</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.CalculateMaximumTimestep">CalculateMaximumTimestep</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.GetAdjacencyMatrix">GetAdjacencyMatrix</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.GetAdjacencyMatrix2">GetAdjacencyMatrix2</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.GetVesselResistance">GetVesselResistance</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.SegmentConductance">SegmentConductance</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.TopologyToGraph">TopologyToGraph</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.Get1DsteadyNetwork">Get1DsteadyNetwork</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.addCollateralsToTopology">addCollateralsToTopology</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.SteadyStateNonLinear">SteadyStateNonLinear</a>
                        </li>
                        <li>
                                <a class="function" href="#Topology.nonlinearmodel">nonlinearmodel</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Tree">Tree</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Tree.__init__">Tree</a>
                        </li>
                        <li>
                                <a class="variable" href="#Tree.NumberOfGenerations">NumberOfGenerations</a>
                        </li>
                        <li>
                                <a class="variable" href="#Tree.Direction">Direction</a>
                        </li>
                        <li>
                                <a class="variable" href="#Tree.InitialNode">InitialNode</a>
                        </li>
                        <li>
                                <a class="variable" href="#Tree.StartingTreeNodes">StartingTreeNodes</a>
                        </li>
                        <li>
                                <a class="variable" href="#Tree.EndNodes">EndNodes</a>
                        </li>
                        <li>
                                <a class="variable" href="#Tree.Nodes">Nodes</a>
                        </li>
                        <li>
                                <a class="variable" href="#Tree.Vessels">Vessels</a>
                        </li>
                        <li>
                                <a class="variable" href="#Tree.BifurcationNodes">BifurcationNodes</a>
                        </li>
                        <li>
                                <a class="variable" href="#Tree.LengthRadiusRatio">LengthRadiusRatio</a>
                        </li>
                        <li>
                                <a class="function" href="#Tree.GenerateTree">GenerateTree</a>
                        </li>
                        <li>
                                <a class="function" href="#Tree.ConnectTree">ConnectTree</a>
                        </li>
                </ul>

            </li>
    </ul>



                    <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev">
                        built with <span class="visually-hidden">pdoc</span><img
                            alt="pdoc logo"
                            src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
                    </a>
            </div>
        </nav>
    <main class="pdoc">
            <section>
                    <h1 class="modulename">
<a href="./../Blood_Flow_1D.html">Blood_Flow_1D</a><wbr>.Topology    </h1>

                        <div class="docstring"><p>Contains the Topology object class.</p>
</div>

                        <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="ch">#!/usr/bin/python3</span>
<span class="c1"># -*- coding:utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Contains the Topology object class.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">multiprocessing.pool</span> <span class="kn">import</span> <span class="n">ThreadPool</span> <span class="k">as</span> <span class="n">Pool</span>

<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span>
<span class="kn">import</span> <span class="nn">vtk</span>
<span class="kn">from</span> <span class="nn">vtk.util.numpy_support</span> <span class="kn">import</span> <span class="n">vtk_to_numpy</span>

<span class="kn">from</span> <span class="nn">Blood_Flow_1D</span> <span class="kn">import</span> <span class="n">BloodFlowEquations</span><span class="p">,</span> <span class="n">GeneralFunctions</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">Vessel</span>


<span class="k">class</span> <span class="nc">Topology</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coarse_collaterals_effective_radius</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coarse_collaterals_number</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coarse_collaterals_threshold</span> <span class="o">=</span> <span class="mi">25</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coarse_collaterals_After_WKNodes</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># set to true for coupled model with estimated coupling resistance.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfVessels</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfNodes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Clots</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Graph</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NodeDict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">MapbifurcationstoVessels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For each bifurcation in topology (self.BifurcationNodes),</span>
<span class="sd">        the VesselConnections is created with the connected vessels.</span>
<span class="sd">        :return: None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># vesseldist = {item: sublist for sublist in self.Vessels for item in sublist.Nodes}</span>
        <span class="n">vesseldist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NodeVesselDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="n">bif</span><span class="o">.</span><span class="n">VesselConnections</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">vesseldist</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">MapNodesToVesselID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a dictionary of nodes to major vessel ID</span>
<span class="sd">        :return: dict with keys the nodes and values their major vessel ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nodedict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)):</span>
            <span class="p">[</span><span class="n">nodedict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">nodedict</span>

    <span class="k">def</span> <span class="nf">NodeVesselDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a dict that maps nodes to the vessel.</span>
<span class="sd">        Sets self.NodeDict</span>
<span class="sd">        :return: dictionary of nodes to vessels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NodeDict</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="n">vessel</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">NodeDict</span>

    <span class="k">def</span> <span class="nf">VesselGraph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vertices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">GetProximalBifurcation</span><span class="p">()</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">GetDistalBifurcation</span><span class="p">()</span>
            <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">vessel</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">edges</span>

    <span class="k">def</span> <span class="nf">GetVesselNameFromNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Name</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Node not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">UpdateNodeType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">SetType</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Type</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Type</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">:</span>
            <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Type</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">UpdateM2Names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the vessel names of the m2 vessels.</span>
<span class="sd">        Smaller branch:inferior branch</span>
<span class="sd">        Larger branch: superior branch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateVesselAtlas</span><span class="p">()</span>

        <span class="c1"># find both sides</span>
        <span class="n">sides</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;R. MCA&quot;</span><span class="p">,</span> <span class="s2">&quot;L. MCA&quot;</span><span class="p">]</span>
        <span class="n">new_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;M2 sup&quot;</span><span class="p">,</span> <span class="s2">&quot;M2 inf&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="n">sides</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">gens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetDownstreamVessels</span><span class="p">(</span><span class="n">side</span><span class="p">)</span>
            <span class="c1"># assuming vessels exist</span>
            <span class="n">downstream1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetDownstreamVessels</span><span class="p">(</span><span class="n">gens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">downstream2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetDownstreamVessels</span><span class="p">(</span><span class="n">gens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># sup branch has more downstream vessels?</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">downstream1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">downstream2</span><span class="p">):</span>
                <span class="n">gens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">side</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">new_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">gens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">side</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">new_names</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">side</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">new_names</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">gens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">side</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">new_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateVesselAtlas</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">UpdateVesselAtlas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an dictionary keyed to vessel name and vessel id.</span>
<span class="sd">        Value returned from the dictionary is the vessel.</span>
<span class="sd">        :return: None, self.VesselAtlas is updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">]</span> <span class="o">=</span> <span class="n">vessel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">vessel</span>

    <span class="k">def</span> <span class="nf">UpdateTopology</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">]</span>
        <span class="c1"># [vessel.SetID(id) for id, vessel in enumerate(self.Vessels)]</span>
        <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">UpdateVessel</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateVesselAtlas</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateNumbers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateNodeType</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberNodes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CheckConnectivity</span><span class="p">()</span>
        <span class="c1"># self.FindOutletNodes()</span>

    <span class="k">def</span> <span class="nf">WriteNodesCSV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ID,VesselID,Connectivity,Position,Radius,LengthAlongVessel,Elasticity,R1,R2,C,Thickness,Type</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">VesselID</span><span class="p">)</span>
                <span class="n">othernodes</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Connections</span><span class="p">)])</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">othernodes</span><span class="p">)</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">Position</span><span class="p">])</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">pos</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">YoungsModules</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">R1</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">R1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">R2</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">R2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">C</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">C</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">Thickness</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">WriteVesselCSV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Name,ID,Radius(mm),Length(mm),YoungsModules(pa),MeanThickness(mm),Type,Nodes</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">CalculateMeanRadius</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">vessel</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanRadius</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">vessel</span><span class="o">.</span><span class="n">YoungsModules</span><span class="p">)</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">CalculateMeanThickness</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanThickness</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>
                <span class="n">Nodes</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)])</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Nodes</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">BifurcationDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a dictionary of the bifurcation nodes.</span>
<span class="sd">        Keys are the nodes of the system and return value is the linked bifurcation node</span>
<span class="sd">        :return: dict{node:bifnode}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">duplicatenodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">):</span>
                <span class="n">duplicatenodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">bif</span>
        <span class="k">return</span> <span class="n">duplicatenodes</span>

    <span class="k">def</span> <span class="nf">UpdateNumbers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfVessels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfNodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span>
        <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">UpdateNodeNumber</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">SetThickness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Thickness</span> <span class="o">=</span> <span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">thickness</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">CheckConnectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking for disconnected nodes.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Disconnected node detected at node number </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">index</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;None Found.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">SaveVesselAtlas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;Mapping.csv&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No Atlas defined.&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing the vessel Atlas to file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>
        <span class="c1"># check if there are nodes without a number.</span>
        <span class="c1"># if so, renumber all nodes.</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">NumberNodes</span><span class="p">()</span>
                <span class="k">break</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">):</span>
                <span class="n">vesselname</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Name</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
                <span class="n">nodelist</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">vesselname</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">,&quot;</span> <span class="o">+</span> <span class="n">nodelist</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadSegmentedVessels_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputfolder</span><span class="p">):</span>
        <span class="c1"># temp solution</span>

        <span class="n">finalfile</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="s2">&quot;1-D_Anatomy_Patient.txt&quot;</span>
        <span class="n">readfile</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="s2">&quot;Feature_Vessel.csv&quot;</span>
        <span class="n">readfile2</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="s2">&quot;Image_info.txt&quot;</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="nb">float</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">readfile2</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="s2">&quot;1-D_Anatomy.txt&quot;</span>

        <span class="n">vesselscsv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">readfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
            <span class="n">readCSV</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">readCSV</span><span class="p">:</span>
                <span class="n">vesselscsv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="n">vessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vesselscsv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">vesseldata</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;vessel&#39;</span><span class="p">,</span> <span class="s1">&#39;ID Length Radius&#39;</span><span class="p">)</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">ID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">Length</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">Radius</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vesseldata</span><span class="p">)</span>

        <span class="n">anatomy</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>

        <span class="c1"># mapping between anatomy and patient segmented vessels</span>
        <span class="c1"># VesselID segmentation, name from segmentation, ID in 1-D anatomy</span>
        <span class="n">MapSegmentation</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;ICA L&quot;</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;ICA R&quot;</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;M1 L&quot;</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;M1 R&quot;</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;M2 L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;M2 R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;A1 L&quot;</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;A1 R&quot;</span><span class="p">,</span> <span class="mi">26</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="s2">&quot;A2 L&quot;</span><span class="p">,</span> <span class="mi">29</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;A2 R&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="s2">&quot;AComm&quot;</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;M3 L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="s2">&quot;M3 R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="s2">&quot;VA L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># 17</span>
                           <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;VA R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># 14</span>
                           <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s2">&quot;BA&quot;</span><span class="p">,</span> <span class="mi">22</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="s2">&quot;P1 L&quot;</span><span class="p">,</span> <span class="mi">27</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="s2">&quot;P1 R&quot;</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="s2">&quot;P2 L&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;P2 R&quot;</span><span class="p">,</span> <span class="mi">33</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="s2">&quot;PComm L&quot;</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="s2">&quot;PComm R&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="s2">&quot;OA L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="s2">&quot;OA R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">]</span>

        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">MapSegmentation</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vessel</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">vessel</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
            <span class="n">mapped</span> <span class="o">=</span> <span class="n">MapSegmentation</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">finalfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">anatomy</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadSegmentedVessels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputfolder</span><span class="p">,</span> <span class="n">CoWFile</span><span class="o">=</span><span class="s2">&quot;1-D_Anatomy.txt&quot;</span><span class="p">):</span>
        <span class="c1"># temp solution</span>

        <span class="n">finalfile</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="s2">&quot;1-D_Anatomy_Patient.txt&quot;</span>
        <span class="n">readfile</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="s2">&quot;Feature_Vessel.csv&quot;</span>
        <span class="n">readfile2</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="s2">&quot;Image_info.txt&quot;</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="nb">float</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">readfile2</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">file</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="n">CoWFile</span>
        <span class="n">anatomy</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>

        <span class="n">vesselscsv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">readfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
            <span class="n">readCSV</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">readCSV</span><span class="p">:</span>
                <span class="n">vesselscsv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="n">vessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vesselscsv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">vesseldata</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;vessel&#39;</span><span class="p">,</span> <span class="s1">&#39;ID Length Radius Startmark Endmark vesselnumber StartPos EndPos&#39;</span><span class="p">)</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">ID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">StartPos</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">6</span><span class="p">]))</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">EndPos</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">7</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">8</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">9</span><span class="p">]))</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">Length</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="c1"># The field called A_diameter is actually the radius of the vessel in voxel units - Praneeta</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">Radius</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">Startmark</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">Endmark</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vesseldata</span><span class="p">)</span>

        <span class="c1"># mapping between anatomy and patient segmented vessels</span>
        <span class="c1"># VesselID segmentation, name from segmentation, ID in 1-D anatomy</span>
        <span class="n">MapSegmentation</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;ICA L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;ICA R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;M1 L&quot;</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;M1 R&quot;</span><span class="p">,</span> <span class="mi">22</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;M2 L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># not in default anatomy</span>
                           <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;M2 R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># not in default anatomy</span>
                           <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;A1 L&quot;</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;A1 R&quot;</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="s2">&quot;A2 L&quot;</span><span class="p">,</span> <span class="mi">27</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;A2 R&quot;</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="s2">&quot;AComm&quot;</span><span class="p">,</span> <span class="mi">29</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;M3 L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># not in default anatomy</span>
                           <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="s2">&quot;M3 R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># not in default anatomy</span>
                           <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="s2">&quot;VA L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># 17  # not part of the scan region but is not missing either.</span>
                           <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;VA R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># 14 # not part of the scan region but is not missing either.</span>
                           <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s2">&quot;BA&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># split into 5!</span>
                           <span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="s2">&quot;P1 L&quot;</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="s2">&quot;P1 R&quot;</span><span class="p">,</span> <span class="mi">26</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="s2">&quot;P2 L&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;P2 R&quot;</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="s2">&quot;PComm L&quot;</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="s2">&quot;PComm R&quot;</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="s2">&quot;OA L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># not part of the scan region but is not missing either.</span>
                           <span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="s2">&quot;OA R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">]</span>  <span class="c1"># not part of the scan region but is not missing either.</span>

        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">vesselnumber</span> <span class="o">=</span> <span class="n">MapSegmentation</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># set missing vessels to zero</span>
        <span class="c1"># some vessels are excluded as they have to be present but are not in the scans.</span>
        <span class="c1"># example, aortic arch (23,24)</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">MapSegmentation</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">vessel</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># overwrite default anatomy</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
            <span class="n">mapped</span> <span class="o">=</span> <span class="n">MapSegmentation</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>

        <span class="c1"># remove the inlet vessels as these are cut off during imaging (incorrect length)</span>
        <span class="n">vessels</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">])]</span>

        <span class="c1"># add vessels not present in default anatomy</span>
        <span class="c1"># &quot;M2 L&quot;  # not in default anatomy</span>
        <span class="c1"># &quot;M2 R&quot;  # not in default anatomy</span>
        <span class="c1"># &quot;M3 L&quot;  # not in default anatomy</span>
        <span class="c1"># &quot;M3 R&quot;  # not in default anatomy</span>
        <span class="c1"># assumption is that these always come in pairs</span>
        <span class="n">extravessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">newvessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
            <span class="n">mapped</span> <span class="o">=</span> <span class="n">MapSegmentation</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># print(vessel)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">mapped</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">extravessels</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;,2&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">extravessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;,1&quot;</span>
                <span class="n">length</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                <span class="n">youngsmodulus</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mf">1.6</span><span class="p">)</span>
                <span class="n">newves</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">youngsmodulus</span><span class="p">],</span> <span class="n">vessel</span><span class="p">]</span>
                <span class="n">newvessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newves</span><span class="p">)</span>

        <span class="c1"># add vessels to the anatomy</span>
        <span class="n">numberoldvessels</span> <span class="o">=</span> <span class="n">anatomy</span><span class="o">.</span><span class="n">index</span><span class="p">([</span><span class="s1">&#39;Bifurcations&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newvessels</span><span class="p">):</span>
            <span class="n">vessel</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">numberoldvessels</span> <span class="o">+</span> <span class="n">index</span><span class="p">)</span>
            <span class="n">vessel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">vesselnumber</span> <span class="o">=</span> <span class="n">numberoldvessels</span> <span class="o">+</span> <span class="n">index</span>
            <span class="n">anatomy</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">numberoldvessels</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># extract ends</span>
        <span class="n">endspos</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">StartPos</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">EndPos</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">]</span>
        <span class="n">ends</span> <span class="o">=</span> <span class="p">[</span><span class="n">end</span> <span class="k">for</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">endspos</span><span class="p">))]</span>
        <span class="n">marks</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">list</span><span class="p">(</span><span class="n">end</span><span class="p">),</span> <span class="p">[],</span> <span class="p">[]]</span> <span class="k">for</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">ends</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ends</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">vessel</span><span class="o">.</span><span class="n">StartPos</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>
                    <span class="n">marks</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">vessel</span><span class="o">.</span><span class="n">EndPos</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>
                    <span class="n">marks</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>

        <span class="c1"># extract bifurcations</span>
        <span class="n">bifurcations</span> <span class="o">=</span> <span class="p">[</span><span class="n">mark</span> <span class="k">for</span> <span class="n">mark</span> <span class="ow">in</span> <span class="n">marks</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mark</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">mark</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># assign numbers</span>
        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">bifurcations</span><span class="p">:</span>
            <span class="n">numbers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">bif</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">numbers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Startmark</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">bif</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">numbers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Endmark</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error in segmentation. Bifurcation has more than one ID.&quot;</span><span class="p">)</span>
            <span class="n">bif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">numbers</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># list the new bifurcations in the 1-D anatomy format</span>
        <span class="n">possiblenewvesselsbif</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">]</span>
        <span class="n">candidatebif</span> <span class="o">=</span> <span class="p">[</span><span class="n">bif</span> <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">bifurcations</span> <span class="k">if</span> <span class="n">bif</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="n">possiblenewvesselsbif</span><span class="p">]</span>

        <span class="c1"># we assume a certain direction, the segmentation do not seem to follow the same.</span>
        <span class="c1"># M1 R, 4-&gt;8, 4</span>
        <span class="c1"># M2 R, 8-&gt;14, 6</span>
        <span class="c1"># M3 R, 14-&gt;26, 13</span>
        <span class="c1"># M1 L, 3-&gt;7, 3</span>
        <span class="c1"># M2 L, 7-&gt;13, 5</span>
        <span class="c1"># M3 L, 13-&gt;25, 12</span>
        <span class="n">bifends</span> <span class="o">=</span> <span class="p">{</span><span class="mi">7</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                   <span class="mi">8</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
                   <span class="mi">13</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
                   <span class="mi">14</span><span class="p">:</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span>
                   <span class="mi">25</span><span class="p">:</span> <span class="p">(</span><span class="mi">12</span><span class="p">,),</span>
                   <span class="mi">26</span><span class="p">:</span> <span class="p">(</span><span class="mi">13</span><span class="p">,)}</span>

        <span class="n">newbifs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">inout</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">bif</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">candidatebif</span><span class="p">):</span>
            <span class="c1"># ends = [str(i.vesselnumber) + &quot;i&quot; for i in bif[0]]</span>
            <span class="c1"># ends += [str(i.vesselnumber) + &quot;o&quot; for i in bif[1]]</span>
            <span class="n">ends</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">endlist</span> <span class="o">=</span> <span class="n">bifends</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">bif</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">endlist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
                <span class="n">ends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">vesselnumber</span><span class="p">)</span> <span class="o">+</span> <span class="n">inout</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">bif</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">endlist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
                <span class="n">ends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">vesselnumber</span><span class="p">)</span> <span class="o">+</span> <span class="n">inout</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
            <span class="n">newbifs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ends</span><span class="p">))</span>

        <span class="n">endsbiflist</span> <span class="o">=</span> <span class="n">anatomy</span><span class="o">.</span><span class="n">index</span><span class="p">([</span><span class="s1">&#39;Boundary Nodes&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">newbif</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newbifs</span><span class="p">):</span>
            <span class="n">anatomy</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">endsbiflist</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span> <span class="p">[</span><span class="n">newbif</span><span class="p">])</span>

        <span class="n">ends</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Outlets Brain:&quot;</span><span class="p">]</span>
        <span class="n">nodesinbif</span> <span class="o">=</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">}</span>  <span class="c1"># only possible extra ones atm</span>
        <span class="n">startbiflist</span> <span class="o">=</span> <span class="n">anatomy</span><span class="o">.</span><span class="n">index</span><span class="p">([</span><span class="s1">&#39;Bifurcations&#39;</span><span class="p">])</span>
        <span class="n">endsbiflist</span> <span class="o">=</span> <span class="n">anatomy</span><span class="o">.</span><span class="n">index</span><span class="p">([</span><span class="s1">&#39;Boundary Nodes&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">anatomy</span><span class="p">[</span><span class="n">startbiflist</span><span class="p">:</span><span class="n">endsbiflist</span><span class="p">]:</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="p">[</span><span class="n">nodesinbif</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span> <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;o&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">startbiflist</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nodesinbif</span><span class="p">:</span>
                <span class="n">ends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
        <span class="n">anatomy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ends</span><span class="p">)]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">finalfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">anatomy</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadBFSimFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadTopFile</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;System.top&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadParFile</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;System.par&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadRunFile</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;Run.txt&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadVesselAtlas</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;Mapping.csv&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadClotFile</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;Clots.txt&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadTopFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading topology file.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ReadNodesFromTopFile</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CheckConnectivity</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">LoadParFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading parameter file.&quot;</span><span class="p">)</span>
        <span class="n">pardata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">pardata</span><span class="p">:</span>
            <span class="n">nodenumber</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">nodenumber</span><span class="p">]</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">:])</span> <span class="o">*</span> <span class="mf">1e9</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">:])</span> <span class="o">*</span> <span class="mf">1e9</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">:])</span> <span class="o">*</span> <span class="mf">1e-12</span>
            <span class="n">node</span><span class="o">.</span><span class="n">SetWK</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadRunFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading run file.&quot;</span><span class="p">)</span>
        <span class="n">rundata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>
        <span class="n">inletdata</span> <span class="o">=</span> <span class="n">rundata</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">11</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">inlet</span> <span class="ow">in</span> <span class="n">inletdata</span><span class="p">:</span>
            <span class="n">nodenumber</span><span class="p">,</span> <span class="n">inletfile</span> <span class="o">=</span> <span class="n">inlet</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nodenumber</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="n">inletfile</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadClotFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading clot file.&quot;</span><span class="p">)</span>
        <span class="n">clotdata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">clotdata</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotdata</span><span class="p">]</span>
        <span class="n">Clotids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotdata</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">clotid</span> <span class="ow">in</span> <span class="n">Clotids</span><span class="p">:</span>
            <span class="n">clotnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotdata</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">clotid</span><span class="p">]</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotnodes</span><span class="p">]</span>
            <span class="n">par1</span> <span class="o">=</span> <span class="n">clotnodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">par2</span> <span class="o">=</span> <span class="n">clotnodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Clots</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">nodes</span><span class="p">,</span> <span class="n">par1</span><span class="p">,</span> <span class="n">par2</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">LoadVTPFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vtpfile</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">vtpfile</span><span class="p">)</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">vtpfile</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

        <span class="n">pos_vtk</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetData</span><span class="p">()</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">pos_vtk</span><span class="p">)</span>

        <span class="n">VesselAtlas</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">vesselids</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">narray</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetNumberOfArrays</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">narray</span><span class="p">):</span>
            <span class="n">arrayname</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArrayName</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;MaximumInscribedSphereRadius&quot;</span> <span class="ow">or</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Radius&quot;</span><span class="p">:</span>
                <span class="n">radius_vtk</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Type&quot;</span><span class="p">:</span>
                <span class="c1">#  load in the vessel atlas</span>
                <span class="n">VesselAtlas</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="n">narray</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetNumberOfArrays</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">narray</span><span class="p">):</span>
            <span class="n">arrayname</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArrayName</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Vessel Ids&quot;</span><span class="p">:</span>
                <span class="c1">#  load in the vessel atlas</span>
                <span class="n">vesselids</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Major Vessel Ids&quot;</span><span class="p">:</span>
                <span class="c1">#  load in the vessel atlas</span>
                <span class="n">VesselAtlas</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="n">radius</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">radius_vtk</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)):</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">radius</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">node</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="n">NumberOfVessels</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetNumberOfCells</span><span class="p">()</span>
        <span class="n">vesselnodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NumberOfVessels</span><span class="p">):</span>
            <span class="n">numberofnodes</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCell</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCell</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">GetPointIds</span><span class="p">()</span>
            <span class="n">vesselnodes</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">ids</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numberofnodes</span><span class="p">)])</span>
            <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">SetVesselID</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vesselnodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="c1"># these include the bifurcations</span>

        <span class="c1"># Connections</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vesselnodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">currentnode</span> <span class="o">=</span> <span class="n">vessel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">neighbour</span> <span class="o">=</span> <span class="n">vessel</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">currentnode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">neighbour</span><span class="p">)</span>
                <span class="n">neighbour</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">currentnode</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">VesselAtlas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">VesselAtlas</span><span class="p">):</span>
                <span class="n">vessel</span> <span class="o">=</span> <span class="n">vesselnodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">=</span> <span class="nb">id</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">vesselids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vesselids</span><span class="p">):</span>
                <span class="n">vessel</span> <span class="o">=</span> <span class="n">vesselnodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">VesselID</span> <span class="o">=</span> <span class="nb">id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">FindBifurcationNodes</span><span class="p">()</span>

        <span class="c1"># extract bifurcations from the vessels</span>
        <span class="c1"># redefine nodes</span>
        <span class="n">bifurcations</span> <span class="o">=</span> <span class="p">[</span><span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">))]</span>
        <span class="p">[</span><span class="n">bifurcations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">))]</span>
        <span class="p">[</span><span class="n">bif</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">bifurcations</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vessel</span><span class="o">.</span><span class="n">Vessel</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vesselnodes</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vesselnodes</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="n">vessel</span>

        <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">InterpolateVessel3Dto1D</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">number</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vesselnodes</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">bifurcations</span><span class="p">[</span><span class="n">number</span><span class="p">]</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bifurcations</span><span class="p">[</span><span class="n">number</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">bifurcations</span><span class="p">[</span><span class="n">number</span><span class="p">]</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bifurcations</span><span class="p">[</span><span class="n">number</span><span class="p">])</span>

        <span class="p">[</span><span class="n">bifurcation</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">Radius</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bifurcation</span><span class="o">.</span><span class="n">Connections</span><span class="p">]))</span> <span class="k">for</span> <span class="n">bifurcation</span> <span class="ow">in</span> <span class="n">bifurcations</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="n">bifurcations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FindlargestInlets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CheckConnectivity</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateNodeType</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">Load1DAnatomy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading anatomy from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">bfdata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>
        <span class="n">BifurcationsIndex</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;Bifurcations&quot;</span><span class="p">)</span>
        <span class="n">BCIndex</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;Boundary Nodes&quot;</span><span class="p">)</span>

        <span class="n">vessels</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">BifurcationsIndex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="n">bifurcations</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">[</span><span class="n">BifurcationsIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">BCIndex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="n">BC</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">[</span><span class="n">BCIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]]</span>

        <span class="c1"># remove zero length vessels from further processing</span>
        <span class="n">NoVessel</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vessels</span> <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vessel</span><span class="o">.</span><span class="n">Vessel</span><span class="p">()</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetID</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vessels</span><span class="p">)]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vessels</span><span class="p">)]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">GenerateVessel</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
                                            <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vessels</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateVesselAtlas</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateNumbers</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">bifurcationnode</span><span class="p">(</span><span class="n">info</span><span class="p">):</span>
            <span class="n">bifurcationnode</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
            <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">nodedata</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">bifurcationinfo</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">element</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">nodedata</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">NoVessel</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">NoIds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">NoVessel</span><span class="p">]</span>
                <span class="n">bifurcationinfo</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bifurcationinfo</span> <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NoIds</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bifurcationinfo</span><span class="p">:</span>
                <span class="n">vessel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span>  <span class="c1"># note that vessel ids start at 1</span>
                <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;o&quot;</span><span class="p">:</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="n">vessel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
                    <span class="n">link</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bifurcationnode</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="n">vessel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
                    <span class="n">link</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bifurcationnode</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>

            <span class="n">radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">Radius</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">Connections</span><span class="p">])</span>
            <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">bifurcationnode</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">bifurcationnode</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">bifurcations</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">bcnodes</span><span class="p">(</span><span class="n">info</span><span class="p">):</span>
            <span class="n">inlets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">outlets</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">inletdata</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">inletinfo</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">element</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">inletdata</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">NoVessel</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">NoIds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">NoVessel</span><span class="p">]</span>
                <span class="n">inletinfo</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">inletinfo</span> <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NoIds</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">inletinfo</span><span class="p">:</span>
                <span class="n">vessel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span>  <span class="c1"># note that vessel ids start at 1</span>
                <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;o&quot;</span><span class="p">:</span>
                    <span class="n">inlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
                    <span class="n">inlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="o">-</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                <span class="n">outletdata</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">outletinfo</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">element</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">outletdata</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">NoVessel</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">NoIds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">NoVessel</span><span class="p">]</span>
                    <span class="n">outletinfo</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">outletinfo</span> <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NoIds</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">outletinfo</span><span class="p">:</span>
                    <span class="n">vessel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span>  <span class="c1"># note that vessel ids start at 1</span>
                    <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;o&quot;</span><span class="p">:</span>
                        <span class="n">outlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
                        <span class="n">outlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="o">-</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">inlets</span><span class="p">,</span> <span class="n">outlets</span>

        <span class="n">inletnodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">=</span> <span class="n">bcnodes</span><span class="p">(</span><span class="n">BC</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">inlet</span><span class="p">,</span> <span class="s2">&quot;Aorta.txt&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">inlet</span> <span class="ow">in</span> <span class="n">inletnodes</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">==</span> <span class="p">[])]</span>

        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberNodes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetThickness</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfNodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfVessels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CheckConnectivity</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateNodeType</span><span class="p">()</span>
        <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">UpdateNodeVesselID</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">CalculateMeanThickness</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">CalculateMeanRadius</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">SetType</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">NumberNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Assigning numbers to the nodes.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">number</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="o">=</span> <span class="n">number</span>
                <span class="n">number</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">GetDownstreamVessels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputvessel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get upstream vessels and bifurcation nodes.</span>
<span class="sd">        Note that this follows the positive directon of the vessels.</span>
<span class="sd">        If vessels are excluded that should be included, check the direction of those vessels.</span>

<span class="sd">        The code finds the relevent bifucations and then checks which vessels are connected.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(&quot;Finding the upstream vessels.&quot;)</span>
        <span class="c1"># initiation</span>
        <span class="n">bifset</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bifurcations</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputvessel</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">vesselindex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span><span class="p">[</span><span class="n">inputvessel</span><span class="p">]</span>
            <span class="n">vessel</span> <span class="o">=</span> <span class="n">vesselindex</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vessel</span> <span class="o">=</span> <span class="n">inputvessel</span>
        <span class="c1"># the current vessel and the starting bifurcation</span>
        <span class="n">vesselend</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vesselend</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
                <span class="n">bifset</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>
                <span class="n">bifurcations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="n">gens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">gens</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">vessel</span><span class="p">])</span>
        <span class="n">alreadylisted</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="p">]</span>
        <span class="c1"># Continue until we have all upstream vessels</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">bifset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">connectedvessels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">bifurcationnode</span> <span class="ow">in</span> <span class="n">bifset</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                    <span class="n">connectedvessels</span> <span class="o">+=</span> <span class="p">[</span><span class="n">vessel</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
            <span class="n">nbifset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">connectedvessels</span><span class="p">:</span>
                <span class="n">ves</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ves</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="ow">and</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bifurcations</span><span class="p">:</span>
                        <span class="n">nbifset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                        <span class="n">bifurcations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">newgen</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">connectedvessels</span> <span class="k">if</span> <span class="n">vessel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">alreadylisted</span><span class="p">]</span>
            <span class="n">gens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newgen</span><span class="p">)</span>
            <span class="n">alreadylisted</span> <span class="o">+=</span> <span class="n">connectedvessels</span>
            <span class="n">bifset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nbifset</span><span class="p">)</span>

        <span class="c1"># only vessels that are connected with the first node should be included.</span>
        <span class="c1"># this ensures that we only get the upstream vessels</span>
        <span class="n">vessels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">vessels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">bifurcations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                <span class="p">[</span><span class="n">vessels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span> <span class="ow">and</span> <span class="n">vessel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">]</span>

        <span class="c1"># export the names of the upstream vessels</span>
        <span class="n">vesselnames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">match</span> <span class="o">==</span> <span class="n">vessel</span><span class="p">:</span>
                    <span class="n">vesselnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>

        <span class="c1"># reorder</span>
        <span class="n">sortedvessels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">vessels</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">sortedvessels</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">bifurcations</span><span class="p">),</span> <span class="n">vesselnames</span><span class="p">,</span> <span class="n">gens</span>

    <span class="k">def</span> <span class="nf">ReorderGens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gens</span><span class="p">):</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">generation</span> <span class="ow">in</span> <span class="n">gens</span><span class="p">:</span>
            <span class="n">lengthgen</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">generation</span><span class="p">:</span>
                <span class="n">v</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="n">ng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetDownstreamVessels</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
                <span class="n">lengthgen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ng</span><span class="p">))</span>
            <span class="n">ordering</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lengthgen</span><span class="p">)</span>

        <span class="n">newgens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">gen</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gens</span><span class="p">):</span>
            <span class="n">newgens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">ordering</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">gen</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">g</span><span class="p">)]))</span>
        <span class="k">return</span> <span class="n">newgens</span>

    <span class="k">def</span> <span class="nf">DownStreamResistance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputvessel</span><span class="p">,</span> <span class="n">visc</span><span class="p">,</span> <span class="n">density</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stdout</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">vessels</span><span class="p">,</span> <span class="n">bifurcations</span><span class="p">,</span> <span class="n">vesselnames</span><span class="p">,</span> <span class="n">gens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetDownstreamVessels</span><span class="p">(</span><span class="n">inputvessel</span><span class="p">)</span>

        <span class="n">C</span> <span class="o">=</span> <span class="n">gens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">C</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">gens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">R1</span> <span class="o">+</span> <span class="n">gens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">R2</span>
        <span class="n">gens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ResetWK</span><span class="p">()</span>

        <span class="n">vesselres</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">VesselResistance</span><span class="p">(</span><span class="n">visc</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">]</span>
        <span class="n">vesselres</span><span class="p">[</span><span class="n">vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">gens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># only get the downstream resistance</span>

        <span class="n">vesselcomp</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">VesselCompliance</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">]</span>
        <span class="n">vesselcomp</span><span class="p">[</span><span class="n">vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">gens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># only get the downstream resistance</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gens</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">gens</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vesselmatch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">vesselmatch</span> <span class="o">==</span> <span class="n">vessel</span><span class="p">:</span>
                        <span class="n">vesselnames</span> <span class="o">=</span> <span class="n">vesselmatch</span><span class="o">.</span><span class="n">Name</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stdout</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                    <span class="n">vesselstemp</span><span class="p">,</span> <span class="n">bifurcationstemp</span><span class="p">,</span> <span class="n">vesselnamestemp</span><span class="p">,</span> <span class="n">genstemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetDownstreamVessels</span><span class="p">(</span><span class="n">vesselnames</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">genstemp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">downstreamres</span> <span class="o">=</span> <span class="p">[</span><span class="n">vesselres</span><span class="p">[</span><span class="n">vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vesselt</span><span class="p">)]</span> <span class="k">for</span> <span class="n">vesselt</span> <span class="ow">in</span> <span class="n">genstemp</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="n">vesselres</span><span class="p">[</span><span class="n">vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vessel</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sumresvessels</span><span class="p">(</span><span class="n">vesselres</span><span class="p">[</span><span class="n">vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vessel</span><span class="p">)],</span>
                                                                          <span class="n">downstreamres</span><span class="p">)</span>
                    <span class="c1"># vesselc = sum([vesselcomp[vessels.index(vesselt)] for vesselt in genstemp[1]])</span>
                    <span class="c1"># if vesselcomp[vessels.index(vessel)] &gt; 0:</span>
                    <span class="c1">#     vesselcomp[vessels.index(vessel)] = 1/(1/vesselc + 1/vesselcomp[vessels.index(vessel)])</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     vesselcomp[vessels.index(vessel)] = vesselc</span>

        <span class="n">outlets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                    <span class="n">outlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">rcubed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="mf">1e-3</span>
        <span class="n">RT</span> <span class="o">=</span> <span class="n">R</span> <span class="o">-</span> <span class="n">vesselres</span><span class="p">[</span><span class="n">vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">gens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span>
        <span class="c1"># Ct = 1/(1/C - 1/vesselcomp[vessels.index(gens[0][0])])</span>
        <span class="k">if</span> <span class="n">RT</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found RT to be negative!?&quot;</span><span class="p">)</span>
            <span class="n">RT</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">R</span>
        <span class="c1"># RT = R</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resistance scaled: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RT</span> <span class="o">/</span> <span class="n">R</span><span class="p">))</span>
        <span class="c1"># print(&quot;Compliance scaled: %f&quot; % (Ct / C))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outlets</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">rcubed</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">C1D</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
            <span class="c1"># mean radius and thickness</span>
            <span class="n">lengthvessel</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Length</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">meanradius</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanRadius</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">meanh</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanThickness</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">C1D</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">meanradius</span> <span class="o">*</span> <span class="n">meanradius</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">lengthvessel</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">vessel</span><span class="o">.</span><span class="n">YoungsModules</span> <span class="o">*</span> <span class="n">meanh</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outlets</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">CalculateThickness</span><span class="p">()</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">rt</span> <span class="o">=</span> <span class="n">RT</span> <span class="o">*</span> <span class="n">rcubed</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="o">.</span><span class="n">YoungsModules</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="n">A</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">density</span><span class="p">)))</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="p">(</span><span class="n">density</span> <span class="o">/</span> <span class="n">A</span><span class="p">)</span> <span class="o">*</span> <span class="n">c0</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">rt</span> <span class="o">-</span> <span class="n">r1</span>
            <span class="k">if</span> <span class="n">r2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">r2</span> <span class="o">=</span> <span class="mf">0.1e9</span>
                <span class="n">r1</span> <span class="o">=</span> <span class="n">rt</span> <span class="o">-</span> <span class="n">r2</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">C</span> <span class="o">-</span> <span class="n">C1D</span><span class="p">)</span> <span class="o">*</span> <span class="n">RT</span> <span class="o">/</span> <span class="n">rt</span><span class="p">)</span>
            <span class="n">i</span><span class="o">.</span><span class="n">SetWK</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

    <span class="c1"># def UpstreamResistancesyms(self, inputvessel, visc, density):</span>
    <span class="c1">#     rt = sympy.symbols(&quot;rt&quot;)</span>
    <span class="c1">#     vessels,  bifurcations, vesselnames, gens = self.GetUpstreamVessels(inputvessel)</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1">#     C = gens[0][0][-1].C</span>
    <span class="c1">#     R = gens[0][0][-1].R1 + gens[0][0][-1].R2</span>
    <span class="c1">#     gens[0][0][-1].ResetWK()</span>
    <span class="c1">#</span>
    <span class="c1">#     vesselres = [VesselResistance(vessel, visc) for vessel in vessels]</span>
    <span class="c1">#     # vesselres[vessels.index(gens[0][0])] = 0 #assumption that the major vessels do not have meaningful resistance.</span>
    <span class="c1">#</span>
    <span class="c1">#     # add resistance of the outlets</span>
    <span class="c1">#     outlets = []</span>
    <span class="c1">#     for vessel in vessels:</span>
    <span class="c1">#         for out in self.OutletNodes:</span>
    <span class="c1">#             if out in vessel:</span>
    <span class="c1">#                 outlets.append(out)</span>
    <span class="c1">#     rcubed = 0</span>
    <span class="c1">#     scaling = 1e-3</span>
    <span class="c1">#     for i in outlets:</span>
    <span class="c1">#         radius = i.Radius * scaling</span>
    <span class="c1">#         rcubed += math.pow(radius, 3)</span>
    <span class="c1">#</span>
    <span class="c1">#     for vessel in vessels:</span>
    <span class="c1">#         for out in self.OutletNodes:</span>
    <span class="c1">#             if out in vessel:</span>
    <span class="c1">#                 vesselres[vessels.index(vessel)] += rt*rcubed / math.pow(out.Radius*scaling, 3)</span>
    <span class="c1">#</span>
    <span class="c1">#     for i in range(len(gens)-1,-1,-1):</span>
    <span class="c1">#         for vessel in gens[i]:</span>
    <span class="c1">#             for index, vesselmatch in enumerate(self.Vessels):</span>
    <span class="c1">#                 if vesselmatch == vessel:</span>
    <span class="c1">#                     vesselnames = self.VesselAtlas[index]</span>
    <span class="c1">#             with contextlib.redirect_stdout(None):</span>
    <span class="c1">#                 vesselstemp, bifurcationstemp, vesselnamestemp, genstemp = self.GetUpstreamVessels(vesselnames)</span>
    <span class="c1">#             if len(genstemp)&gt;1:</span>
    <span class="c1">#                 downstreamres = [vesselres[vessels.index(vesselt)] for vesselt in genstemp[1]]</span>
    <span class="c1">#                 vesselres[vessels.index(vessel)] = self.sumresvessels(vesselres[vessels.index(vessel)],downstreamres)</span>
    <span class="c1">#</span>
    <span class="c1">#     expression =sympy.lambdify(rt, R - vesselres[vessels.index(gens[0][0])],&#39;numpy&#39;)</span>
    <span class="c1">#     RT = float(fsolve(expression,expression(0)))</span>
    <span class="c1">#     # print((RT)/R)</span>
    <span class="c1">#</span>
    <span class="c1">#     C1D = 0</span>
    <span class="c1">#     for vessel in vessels:</span>
    <span class="c1">#         # mean radius and thickness</span>
    <span class="c1">#         lengthvessel = max([vessel[0].Position, vessel[-1].Position]) * scaling</span>
    <span class="c1">#         meanradius = numpy.trapz([i.Radius * scaling for i in vessel],</span>
    <span class="c1">#                                  [i.Position * scaling for i in vessel]) / lengthvessel</span>
    <span class="c1">#         meanh = numpy.trapz([thickness(i.Radius * scaling) for i in vessel],</span>
    <span class="c1">#                                  [i.Position * scaling for i in vessel]) / lengthvessel</span>
    <span class="c1">#         C1D += 2 * numpy.power(numpy.pi * meanradius * meanradius, 1.5) * lengthvessel / (</span>
    <span class="c1">#                 (4 / 3) * numpy.sqrt(numpy.pi) * vessel[0].E * meanh)</span>
    <span class="c1">#</span>
    <span class="c1">#     for i in outlets:</span>
    <span class="c1">#         radius = i.Radius * scaling</span>
    <span class="c1">#         h = thickness(radius)</span>
    <span class="c1">#         rt = RT * rcubed / math.pow(radius, 3)</span>
    <span class="c1">#         A = math.pi * math.pow(radius, 2)</span>
    <span class="c1">#         beta = (4 / 3) * math.sqrt(math.pi) * i.E * h / A</span>
    <span class="c1">#         c0 = abs(math.sqrt(beta / (2 * density))) * math.pow(A, 0.25)</span>
    <span class="c1">#         r1 = (density / A) * c0</span>
    <span class="c1">#         r2 = rt - r1</span>
    <span class="c1">#         if r2 &lt; 0:</span>
    <span class="c1">#             r2 = 0.1e9</span>
    <span class="c1">#             r1 = rt - r2</span>
    <span class="c1">#         c = (C-C1D) * RT / rt</span>
    <span class="c1">#         i.set_WK(r1, r2, c)</span>

    <span class="k">def</span> <span class="nf">sumresvessels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upstream</span><span class="p">,</span> <span class="n">downstream</span><span class="p">):</span>
        <span class="n">parallelvesselsres</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="o">/</span> <span class="n">vesselres</span> <span class="k">for</span> <span class="n">vesselres</span> <span class="ow">in</span> <span class="n">downstream</span><span class="p">])</span>
        <span class="n">serialvesselres</span> <span class="o">=</span> <span class="n">upstream</span>
        <span class="n">totalres</span> <span class="o">=</span> <span class="n">parallelvesselsres</span> <span class="o">+</span> <span class="n">serialvesselres</span>
        <span class="k">return</span> <span class="n">totalres</span>

    <span class="k">def</span> <span class="nf">RedefineDirection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Redefining the direction of the vessels.&quot;</span><span class="p">)</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">inlet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">direction</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">vessel</span><span class="o">.</span><span class="n">GenerationNumber</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="n">inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vessel reversed.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">nodenumber</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">nodenumber</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span> <span class="o">-</span> <span class="n">nodenumber</span><span class="p">:</span>
                            <span class="c1"># self.Vessels[index].Nodes[nodenumber].Position, self.Vessels[index].Nodes[</span>
                            <span class="c1">#     -1 - nodenumber].Position = \</span>
                            <span class="c1">#     self.Vessels[index].Nodes[-1 - nodenumber].Position, self.Vessels[index].Nodes[</span>
                            <span class="c1">#         nodenumber].Position</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span>
                                <span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">=</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span>
                                    <span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span>
                    <span class="n">direction</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">inletvessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">inlet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">inletvessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span>

        <span class="n">bifs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">inves</span> <span class="ow">in</span> <span class="n">inletvessels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">inves</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
                    <span class="n">bifs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bif</span><span class="p">)</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">bifs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">newbifs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">bifs</span><span class="p">:</span>
                <span class="n">vessels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">if</span>
                           <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span> <span class="ow">or</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">]</span>
                <span class="n">vesselundef</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span> <span class="k">if</span> <span class="n">direction</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vesselundef</span><span class="p">:</span>
                    <span class="c1"># print(self.VesselAtlas[vessel])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                        <span class="n">direction</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vessel reversed.&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                        <span class="k">for</span> <span class="n">nodenumber</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">nodenumber</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span> <span class="o">-</span> <span class="n">nodenumber</span><span class="p">:</span>
                                <span class="c1"># self.Vessels[vessel].Nodes[nodenumber].Position, self.Vessels[vessel].Nodes[</span>
                                <span class="c1">#     -1 - nodenumber].Position = \</span>
                                <span class="c1">#     self.Vessels[vessel].Nodes[-1 - nodenumber].Position, self.Vessels[vessel].Nodes[</span>
                                <span class="c1">#         nodenumber].Position</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span>
                                    <span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">=</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">,</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span>
                                        <span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span>
                        <span class="n">direction</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

                    <span class="n">newcandidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">bift</span> <span class="k">for</span> <span class="n">bift</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Connections</span> <span class="k">if</span>
                                     <span class="n">bift</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">newcandidates</span><span class="p">:</span>
                        <span class="n">newbifs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">newcandidates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">bifs</span> <span class="o">=</span> <span class="n">newbifs</span>

    <span class="k">def</span> <span class="nf">GetVesselsFromType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputtype</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting all vessels of a type.&quot;</span><span class="p">)</span>
        <span class="c1"># return all vessels that are labelled with the input type</span>
        <span class="n">vessels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">inputtype</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">vessels</span>

    <span class="k">def</span> <span class="nf">ReadNodesFromTopFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load nodes from topology file.&quot;</span><span class="p">)</span>
        <span class="n">bfdata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>
        <span class="n">bonds_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;Bonds:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">bonds_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>

        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetNodeFromTopLine</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bfdata</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">bonds_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])]</span>

        <span class="n">links</span> <span class="o">=</span> <span class="n">bfdata</span><span class="p">[</span><span class="n">bonds_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">bfdata</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="n">i</span><span class="p">])])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
             <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">link</span><span class="p">))]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">Read3DNodesFromTopFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load nodes from topology file.&quot;</span><span class="p">)</span>
        <span class="n">bfdata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>
        <span class="n">bonds_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;Bonds:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">bonds_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bfdata</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">bonds_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetNumber</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">([</span><span class="mf">1e3</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">:]),</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">:]),</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">:])])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">2</span><span class="p">:]))</span>

        <span class="n">links</span> <span class="o">=</span> <span class="n">bfdata</span><span class="p">[</span><span class="n">bonds_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">bfdata</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="n">i</span><span class="p">])])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
             <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">link</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">LoadVesselAtlas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading vessel atlas from file.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">file</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">vesselatlas</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">vessel</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">]</span>
                <span class="n">vesselatlas</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vessel</span><span class="p">]</span>
                <span class="n">vesselnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vessel</span><span class="p">]</span>
                <span class="p">[</span><span class="n">vesselatlas</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vesselnames</span><span class="p">)]</span>

        <span class="c1"># vesselatlas = [i.strip(&#39;\n&#39;).split(&#39;\t&#39;) for i in open(file)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vessel</span><span class="o">.</span><span class="n">Vessel</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vesselatlas</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vesselatlas</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetID</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">nodenumbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nodenumbers</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetLength</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">,</span> <span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetGridSize</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">-</span> <span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetNodes</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">UpdateVessel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">CalculateMeanRadius</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">CalculateMeanThickness</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateVesselAtlas</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">SetInletNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inlets</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting inlet nodes.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span> <span class="o">=</span> <span class="n">inlets</span>

    <span class="k">def</span> <span class="nf">SetOutletNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outlets</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting outlet nodes.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">=</span> <span class="n">outlets</span>

    <span class="k">def</span> <span class="nf">SetBifurcationNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bifurcationnodes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting bifurcation nodes.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bifurcationnodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FindBifurcationNodes</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="n">bifurcationnodes</span>

    <span class="k">def</span> <span class="nf">FindBifurcationNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding the bifurcation nodes.&quot;</span><span class="p">)</span>
        <span class="n">bifurcationnodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">bifurcationnodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="n">bifurcationnodes</span>

    <span class="k">def</span> <span class="nf">FindOutletNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding the outlet nodes.&quot;</span><span class="p">)</span>
        <span class="n">InletNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">]</span>
        <span class="n">OutletsNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">InletNodes</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetOutletNodes</span><span class="p">(</span><span class="n">OutletsNodes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">FindlargestInlets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">InletNumber</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding the largest </span><span class="si">%d</span><span class="s2"> inlets.&quot;</span> <span class="o">%</span> <span class="n">InletNumber</span><span class="p">)</span>
        <span class="c1"># InletNodes = [i.strip(&#39;\n&#39;).split(&#39;,&#39;) for i in open(inletfilename)]</span>
        <span class="n">Ends</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">InletNodes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Ends</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">Ends</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">inletnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;left_carotid_inlet.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;right_carotid_inlet.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;basilar.txt&quot;</span><span class="p">]</span>
        <span class="n">Inlets</span> <span class="o">=</span> <span class="p">[(</span><span class="n">Ends</span><span class="p">[</span><span class="n">line</span><span class="p">],</span> <span class="n">inletnames</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">InletNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">InletNumber</span><span class="p">]]</span>  <span class="c1"># Dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetInletNodes</span><span class="p">(</span><span class="n">Inlets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FindOutletNodes</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">ApplyTransformation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">Position</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>
            <span class="n">posnew</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">posnew</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">AnatomyToVessels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get vessels from topology data</span>
<span class="sd">        start at an end point</span>
<span class="sd">        get the neighbour, if connection of neighbour is 2 then get next neighbour and repeat.</span>
<span class="sd">        If connection is 1, stop. If connection is more than 2, stop and start new vessel.</span>
<span class="sd">        repeat for every end point, keep track of nodes that are already assigned to a vesse (except bif nodes)</span>
<span class="sd">        bifurcation nodes are nodes with more than 2 connections</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting vessels from topology data.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FindBifurcationNodes</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FindOutletNodes</span><span class="p">()</span>

        <span class="n">ProcessedNodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Note: gives an error is there are no vessel nodes</span>
        <span class="k">for</span> <span class="n">BifurcationNode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="c1"># check connected vessels</span>
            <span class="n">newvessels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">BifurcationNode</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">ProcessedNodes</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">newvessels</span><span class="p">:</span>
                <span class="n">vessel</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BifurcationNode</span><span class="p">)</span>
                <span class="n">ProcessedNodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BifurcationNode</span><span class="p">)</span>
                <span class="n">currentnode</span> <span class="o">=</span> <span class="n">node</span>
                <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">numberconnection</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">currentnode</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">numberconnection</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">vessel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentnode</span><span class="p">)</span>
                        <span class="n">ProcessedNodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentnode</span><span class="p">)</span>
                        <span class="n">currentnode</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">currentnode</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">vessel</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">numberconnection</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">vessel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentnode</span><span class="p">)</span>
                        <span class="n">ProcessedNodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentnode</span><span class="p">)</span>
                        <span class="n">vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vessel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentnode</span><span class="p">)</span>
                        <span class="n">ProcessedNodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentnode</span><span class="p">)</span>
                        <span class="n">vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
                        <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vessel</span><span class="o">.</span><span class="n">Vessel</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vessels</span><span class="p">))]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetNodes</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">elements</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vessels</span><span class="p">)]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span>
         <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateNodeType</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">removebifurcation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span>
            <span class="n">linked</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                        <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">node</span><span class="p">)]</span> <span class="o">=</span> <span class="n">bif</span>
                <span class="n">othernodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span>
                <span class="p">[</span><span class="n">linked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">othernodes</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">n</span> <span class="ow">is</span> <span class="n">bif</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">lastmostvesselend</span> <span class="ow">in</span> <span class="n">othernodes</span><span class="p">:</span>
                    <span class="n">lastmostvesselend</span><span class="o">.</span><span class="n">RemoveConnection</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">linked</span><span class="p">:</span>
                <span class="n">bif</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
                <span class="n">link</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bif</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">TopologyToVTP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the network to a .vtp file.</span>
<span class="sd">        This only works with 3-D coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NumberNodes</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing topology to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPoints</span><span class="p">()</span>
        <span class="n">vessels</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellArray</span><span class="p">()</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>

        <span class="n">radius</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">radius</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Radius&quot;</span><span class="p">)</span>

        <span class="n">nodetype</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkIntArray</span><span class="p">()</span>
        <span class="n">nodetype</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Node Type &quot;</span><span class="p">)</span>

        <span class="c1"># Add radius and position to data array</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
            <span class="n">radius</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Radius</span><span class="p">))</span>
            <span class="n">nodetype</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>

        <span class="c1"># Add vessels to cell array</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkLine</span><span class="p">()</span>
            <span class="n">line</span><span class="o">.</span><span class="n">GetPointIds</span><span class="p">()</span><span class="o">.</span><span class="n">SetNumberOfIds</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)):</span>
                <span class="n">line</span><span class="o">.</span><span class="n">GetPointIds</span><span class="p">()</span><span class="o">.</span><span class="n">SetId</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
            <span class="n">vessels</span><span class="o">.</span><span class="n">InsertNextCell</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># Create a polydata to store everything in</span>
        <span class="n">VesselsPolyData</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">()</span>

        <span class="c1"># Add the nodes to the polydata</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">SetPoints</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

        <span class="c1"># Add the vessels to the polydata</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">SetLines</span><span class="p">(</span><span class="n">vessels</span><span class="p">)</span>

        <span class="c1"># Assign radii to the nodes</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">SetScalars</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">nodetype</span><span class="p">)</span>

        <span class="n">atlas</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkIntArray</span><span class="p">()</span>
        <span class="p">[</span><span class="n">atlas</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)]</span>
        <span class="n">atlas</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Vessel Ids&quot;</span><span class="p">)</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">atlas</span><span class="p">)</span>

        <span class="n">majoratlas</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkIntArray</span><span class="p">()</span>
        <span class="p">[</span><span class="n">majoratlas</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)]</span>
        <span class="n">majoratlas</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Major Vessel Ids&quot;</span><span class="p">)</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">majoratlas</span><span class="p">)</span>

        <span class="c1"># Save everyting in a vtp file</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">VesselsPolyData</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">GetMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Vessel</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Vessel&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Vesselname&#39;</span><span class="p">,</span> <span class="s1">&#39;Numberofnodes&#39;</span><span class="p">,</span> <span class="s1">&#39;Startnode&#39;</span><span class="p">,</span> <span class="s1">&#39;Endnode&#39;</span><span class="p">])</span>
        <span class="n">vessellist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vessellist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Vessel</span><span class="p">(</span><span class="n">Vesselname</span><span class="o">=</span><span class="s1">&#39;System&#39;</span><span class="p">,</span>
                                     <span class="n">Numberofnodes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">),</span>
                                     <span class="n">Startnode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                     <span class="n">Endnode</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span><span class="p">):</span>
                <span class="n">vessellist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Vessel</span><span class="p">(</span><span class="n">Vesselname</span><span class="o">=</span><span class="n">vessel</span><span class="p">,</span>
                                         <span class="n">Numberofnodes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]),</span>
                                         <span class="n">Startnode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span>
                                         <span class="n">Endnode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">vessellist</span>

    <span class="k">def</span> <span class="nf">CalculateMaximumTimestep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">density</span><span class="p">):</span>
        <span class="n">wavespeed</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vessel</span><span class="o">.</span><span class="n">CalculateMaxWaveSpeed</span><span class="p">(</span><span class="n">density</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="n">gridsize</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">GridSize</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="n">CourantNumber</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">timestep</span> <span class="o">=</span> <span class="p">[</span><span class="n">CourantNumber</span> <span class="o">*</span> <span class="n">gridsize</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">speed</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">speed</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wavespeed</span><span class="p">)]</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">timestep</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Maximum timestep: </span><span class="si">%1.1e</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="n">dt</span><span class="p">)</span>
        <span class="c1"># newgridsize = [1e3 * speed * dt / CourantNumber for speed in wavespeed]  # minimum gridsize, there is no max</span>
        <span class="c1"># max gridsize is set by the vessel length and by the need for detail</span>
        <span class="k">return</span> <span class="n">dt</span>

    <span class="k">def</span> <span class="nf">GetAdjacencyMatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the adjacency matrix of the network</span>

<span class="sd">        :return: scipy sparse matrix, nodes in order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># for each vessel, get the bifurcations at the ends</span>
        <span class="c1"># then check at what parts of other vessels these bifurcations connect.</span>
        <span class="c1"># matrix = numpy.zeros((len(self.Vessels),len(self.Vessels)))</span>
        <span class="c1">#</span>
        <span class="c1"># for index, vessel in enumerate(self.Vessels):</span>
        <span class="c1">#     bif = vessel.GetDistalBifurcation()</span>
        <span class="c1">#     if not (bif is None):</span>
        <span class="c1">#         vesselsnumbers = bif.GetConnectedVesselIDs()</span>
        <span class="c1">#         vesselsnumbers.remove(vessel.ID)</span>
        <span class="c1">#         for number in vesselsnumbers:</span>
        <span class="c1">#             matrix[vessel.ID][number] = 1</span>
        <span class="c1">#</span>
        <span class="c1">#     bif = vessel.GetProximalBifurcation()</span>
        <span class="c1">#     if not (bif is None):</span>
        <span class="c1">#         vesselsnumbers = bif.GetConnectedVesselIDs()</span>
        <span class="c1">#         vesselsnumbers.remove(vessel.ID)</span>
        <span class="c1">#         for number in vesselsnumbers:</span>
        <span class="c1">#             matrix[vessel.ID][number] = -1</span>

        <span class="n">network</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="n">inlets</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">]</span>
        <span class="n">bifs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span>
        <span class="n">outlets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span>  <span class="c1"># vessel ends</span>
        <span class="n">newoutletnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">]</span>
        <span class="n">allnodes</span> <span class="o">=</span> <span class="n">inlets</span> <span class="o">+</span> <span class="n">bifs</span> <span class="o">+</span> <span class="n">outlets</span> <span class="o">+</span> <span class="n">newoutletnodes</span>

        <span class="n">network</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">allnodes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">GetVesselResistance</span><span class="p">(</span><span class="n">bloodvisc</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[[</span><span class="n">vessel</span><span class="o">.</span><span class="n">GetEndNodes</span><span class="p">(),</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Resistance</span><span class="p">]</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>

        <span class="n">outletedges</span> <span class="o">=</span> <span class="p">[[[</span><span class="n">node</span><span class="p">,</span> <span class="n">newoutletnodes</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">R1</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">R2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outlets</span><span class="p">)]</span>
        <span class="n">edges</span> <span class="o">+=</span> <span class="n">outletedges</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">network</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">length</span><span class="o">=</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">nodes</span><span class="p">()):</span>
            <span class="n">labels</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>

        <span class="c1"># import matplotlib.pylab as plt</span>
        <span class="c1"># pos = nx.spring_layout(network, weight=&#39;length&#39;)</span>
        <span class="c1"># nx.draw_networkx_nodes(network, pos)</span>
        <span class="c1"># nx.draw_networkx_edges(network, pos)</span>
        <span class="c1"># nx.draw_networkx_labels(network, pos, labels, font_size=16)</span>
        <span class="c1"># plt.show()</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">allnodes</span>

    <span class="k">def</span> <span class="nf">GetAdjacencyMatrix2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the adjacency matrix of the network</span>

<span class="sd">        :return: scipy sparse matrix, nodes in order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">network</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="n">inlets</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">]</span>
        <span class="n">bifs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span>
        <span class="n">outlets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span>  <span class="c1"># vessel ends</span>

        <span class="n">allnodes</span> <span class="o">=</span> <span class="n">inlets</span> <span class="o">+</span> <span class="n">bifs</span> <span class="o">+</span> <span class="n">outlets</span>

        <span class="n">network</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">allnodes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">GetVesselResistance</span><span class="p">(</span><span class="n">bloodvisc</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[[</span><span class="n">vessel</span><span class="o">.</span><span class="n">GetEndNodes</span><span class="p">(),</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Resistance</span><span class="p">]</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">network</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">length</span><span class="o">=</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">nodes</span><span class="p">()):</span>
            <span class="n">labels</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>

        <span class="c1"># import matplotlib.pylab as plt</span>
        <span class="c1"># pos = nx.spring_layout(network, weight=&#39;length&#39;)</span>
        <span class="c1"># nx.draw_networkx_nodes(network, pos)</span>
        <span class="c1"># nx.draw_networkx_edges(network, pos)</span>
        <span class="c1"># nx.draw_networkx_labels(network, pos, labels, font_size=16)</span>
        <span class="c1"># plt.show()</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">allnodes</span>

    <span class="k">def</span> <span class="nf">GetVesselResistance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">):</span>
        <span class="n">resistance</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">VesselResistance</span><span class="p">(</span><span class="n">bloodvisc</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">resistance</span>

    <span class="k">def</span> <span class="nf">SegmentConductance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="o">=</span><span class="mi">22</span><span class="p">):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">node1</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">-</span> <span class="n">node2</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">GeneralFunctions</span><span class="o">.</span><span class="n">distancebetweenpoints</span><span class="p">(</span><span class="n">node1</span><span class="o">.</span><span class="n">Position</span><span class="p">,</span> <span class="n">node2</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>

        <span class="c1"># a = node1.Radius</span>
        <span class="c1"># b = (node2.Radius - node1.Radius) / length</span>
        <span class="c1"># radiusint = scipy.integrate.quad(lambda l: 1 / scipy.power(a + b * l, 4), 0, length)</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="p">(</span><span class="n">node1</span><span class="o">.</span><span class="n">Radius</span> <span class="o">+</span> <span class="n">node2</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">frictionconstant</span><span class="p">):</span>
            <span class="n">friction</span> <span class="o">=</span> <span class="n">frictionconstant</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
            <span class="k">return</span> <span class="mf">1e-9</span> <span class="o">*</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">friction</span> <span class="o">*</span> <span class="n">bloodvisc</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1e-9</span> <span class="o">*</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">frictionconstant</span> <span class="o">*</span> <span class="n">bloodvisc</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span>

        <span class="c1"># G = 1e-9 * (numpy.pi * numpy.power(radius, 4)) / (fictionconstant * bloodvisc * length)</span>
        <span class="c1"># # G = 1e-9 * (numpy.pi * numpy.power(radius, 4)) / (8 * bloodvisc * length)</span>
        <span class="c1"># return G</span>

    <span class="k">def</span> <span class="nf">TopologyToGraph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">network</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)):</span>
                <span class="n">network</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                 <span class="n">weight</span><span class="o">=</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">-</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                <span class="n">network</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">bif</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Graph</span> <span class="o">=</span> <span class="n">network</span>

        <span class="c1"># pos = nx.spring_layout(network)</span>
        <span class="c1"># nx.draw(network, pos)</span>
        <span class="c1"># plt.show()</span>

    <span class="k">def</span> <span class="nf">Get1DsteadyNetwork</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">,</span> <span class="n">clotactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">PressureInlets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">coarseCollaterals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">FlowRateOutlets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="o">=</span><span class="mi">22</span><span class="p">):</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># bloodvisc = patient.ModelParameters[&quot;BLOOD_VISC&quot;]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)):</span>
                <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                              <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">SegmentConductance</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bloodvisc</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="o">=</span><span class="n">frictionconstant</span><span class="p">)])</span>

        <span class="c1"># generate more nodes for the wk elements</span>
        <span class="n">newoutlets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># newcounter = self.NumberOfNodes</span>
        <span class="k">for</span> <span class="n">outlet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">outlet</span><span class="o">.</span><span class="n">R1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">g</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">outlet</span><span class="o">.</span><span class="n">R1</span> <span class="o">+</span> <span class="n">outlet</span><span class="o">.</span><span class="n">R2</span><span class="p">)</span>
                <span class="n">wknode</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                <span class="n">wknode</span><span class="o">.</span><span class="n">OutPressure</span> <span class="o">=</span> <span class="n">outlet</span><span class="o">.</span><span class="n">OutPressure</span>
                <span class="n">wknode</span><span class="o">.</span><span class="n">OutletFlowRate</span> <span class="o">=</span> <span class="n">outlet</span><span class="o">.</span><span class="n">OutletFlowRate</span>
                <span class="c1"># wknode.InputPressure = wknode.OutPressure</span>
                <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">outlet</span><span class="p">,</span> <span class="n">wknode</span><span class="p">,</span> <span class="n">g</span><span class="p">])</span>
                <span class="c1"># outlet.AddConnection(wknode)</span>
                <span class="n">wknode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">outlet</span><span class="p">)</span>
                <span class="n">newoutlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wknode</span><span class="p">)</span>

                <span class="n">outlet</span><span class="o">.</span><span class="n">WKNode</span> <span class="o">=</span> <span class="n">wknode</span>  <span class="c1"># for collaterals</span>
                <span class="n">wknode</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">outlet</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>  <span class="c1"># for collaterals</span>
                <span class="n">wknode</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">outlet</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
                <span class="c1"># newcounter += 1</span>
                <span class="c1"># wknode.SetNumber(newcounter)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newoutlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outlet</span><span class="p">)</span>
        <span class="n">OutletNodes</span> <span class="o">=</span> <span class="n">newoutlets</span>

        <span class="c1"># collaterals</span>
        <span class="n">collateralEdges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># coarseCollaterals = False</span>
        <span class="k">if</span> <span class="n">coarseCollaterals</span><span class="p">:</span>  <span class="c1"># collateral model</span>
            <span class="c1"># add conductance between wknodes of outlets according to collaterals</span>
            <span class="c1"># connections between MCA and PCA/ACA for now</span>
            <span class="c1"># scaling = 1e-12 # guess value? resistance per mm?</span>
            <span class="c1"># n = 0.01  # number</span>
            <span class="c1"># effectiveradius = 0.2  # mm</span>
            <span class="c1"># 1e-9 * (numpy.pi * numpy.power(radius, 4)) / (friction * bloodvisc * length)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_collaterals_number</span>
            <span class="n">effectiveradius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_collaterals_effective_radius</span>
            <span class="n">distance_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_collaterals_threshold</span>

            <span class="c1"># basically 1mm? (assume properties are uniform, like a thin sheet)</span>
            <span class="n">scaling</span> <span class="o">=</span> <span class="mf">1e-9</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">effectiveradius</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">frictionconstant</span> <span class="o">*</span> <span class="n">bloodvisc</span><span class="p">)</span>
            <span class="c1"># print(f&quot;\tScaling factor: {scaling}&quot;)</span>

            <span class="c1"># based on previous found connections</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">othernode</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">connected_cp</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="o">&lt;</span> <span class="n">othernode</span><span class="o">.</span><span class="n">Number</span><span class="p">:</span>  <span class="c1"># prevent duplicates</span>
                        <span class="n">collateral_conductance</span> <span class="o">=</span> <span class="n">scaling</span>
                        <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">WKNode</span><span class="p">,</span> <span class="n">othernode</span><span class="o">.</span><span class="n">WKNode</span><span class="p">,</span> <span class="n">collateral_conductance</span><span class="p">])</span>
                        <span class="n">collateralEdges</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">WKNode</span><span class="p">,</span> <span class="n">othernode</span><span class="o">.</span><span class="n">WKNode</span><span class="p">,</span> <span class="n">collateral_conductance</span><span class="p">])</span>

            <span class="c1"># Identify outlets within distance x</span>
            <span class="c1"># for node in self.OutletNodes:</span>
            <span class="c1">#     if node.MajorVesselID == 2 or node.MajorVesselID == 3 or node.MajorVesselID == 6:  # R SIDE</span>
            <span class="c1">#         othernodes = [othernode for othernode in self.OutletNodes if</span>
            <span class="c1">#                       othernode.MajorVesselID == 2 or othernode.MajorVesselID == 3 or othernode.MajorVesselID == 6]</span>
            <span class="c1">#     elif node.MajorVesselID == 4 or node.MajorVesselID == 5 or node.MajorVesselID == 7:  # L SIDE</span>
            <span class="c1">#         othernodes = [othernode for othernode in self.OutletNodes if</span>
            <span class="c1">#                       othernode.MajorVesselID == 4 or othernode.MajorVesselID == 5 or othernode.MajorVesselID == 7]</span>
            <span class="c1">#     else:</span>
            <span class="c1">#         othernodes = []</span>
            <span class="c1">#     for othernode in othernodes:</span>
            <span class="c1">#</span>
            <span class="c1">#         if self.coarse_collaterals_After_WKNodes:</span>
            <span class="c1">#             if node.Number &lt; othernode.Number:  # prevent duplicates</span>
            <span class="c1">#                 distance = GeneralFunctions.distancebetweenpoints(node.WKNode.Position, othernode.WKNode.Position)</span>
            <span class="c1">#                 # collateral_conductance = scaling/distance</span>
            <span class="c1">#                 if distance &lt; distance_threshold:</span>
            <span class="c1">#                     collateral_conductance = scaling</span>
            <span class="c1">#                     edges.append([node.WKNode, othernode.WKNode, collateral_conductance])</span>
            <span class="c1">#                     collateralEdges.append([node.WKNode, othernode.WKNode, collateral_conductance])</span>
            <span class="c1">#         else:</span>
            <span class="c1">#             if node.Number &lt; othernode.Number:  # prevent duplicates</span>
            <span class="c1">#                 distance = GeneralFunctions.distancebetweenpoints(node.Position, othernode.Position)</span>
            <span class="c1">#                 # collateral_conductance = scaling/distance</span>
            <span class="c1">#                 if distance &lt; distance_threshold:</span>
            <span class="c1">#                     collateral_conductance = scaling</span>
            <span class="c1">#                     edges.append([node, othernode, collateral_conductance])</span>
            <span class="c1">#                     collateralEdges.append([node, othernode, collateral_conductance])</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Collateral vessels: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">collateralEdges</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Collaterals</span> <span class="o">=</span> <span class="n">collateralEdges</span>

        <span class="c1"># modelling clots</span>
        <span class="c1"># we can simply update the edges</span>
        <span class="c1"># set global parameter ClotActive to true</span>
        <span class="c1"># set conductance to zero.</span>
        <span class="c1"># find edge in list of edges, set conductance to zero</span>
        <span class="k">if</span> <span class="n">clotactive</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">clot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Clots</span><span class="p">:</span>
                <span class="n">clotnodes</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># for _ in enumerate(clotnodes[:-1]):</span>
                <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">clotnodes</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">clotnodes</span><span class="p">):</span>
                        <span class="n">node1</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">node2</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                        <span class="n">length</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">node1</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">-</span> <span class="n">node2</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">length</span> <span class="o">=</span> <span class="n">GeneralFunctions</span><span class="o">.</span><span class="n">distancebetweenpoints</span><span class="p">(</span><span class="n">node1</span><span class="o">.</span><span class="n">Position</span><span class="p">,</span> <span class="n">node2</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>

                        <span class="n">permeability</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="c1"># porocity = clot[2]</span>

                        <span class="c1"># permeable, darcy&#39;s law, units m^2 (range (1.0  1e-17) to (1.0  1e-7)?</span>
                        <span class="c1"># input units are mm^2 -&gt; multiply with 1e-6</span>
                        <span class="n">area</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">node1</span><span class="o">.</span><span class="n">RefRadius</span> <span class="o">+</span> <span class="n">node2</span><span class="o">.</span><span class="n">RefRadius</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>
                        <span class="n">G</span> <span class="o">=</span> <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">permeability</span> <span class="o">*</span> <span class="n">area</span><span class="o">/</span><span class="p">(</span><span class="n">bloodvisc</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span>
                        <span class="c1"># todo should we account for segment resistance as well?</span>
                        <span class="n">node1</span><span class="o">.</span><span class="n">Radius</span> <span class="o">=</span> <span class="n">node1</span><span class="o">.</span><span class="n">RefRadius</span>
                        <span class="n">node2</span><span class="o">.</span><span class="n">Radius</span> <span class="o">=</span> <span class="n">node2</span><span class="o">.</span><span class="n">RefRadius</span>
                        <span class="n">segmentConduction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SegmentConductance</span><span class="p">(</span><span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="o">=</span><span class="n">frictionconstant</span><span class="p">)</span>
                        <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">G</span> <span class="o">+</span> <span class="mf">1e-32</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">segmentConduction</span><span class="p">)</span>


                        <span class="c1"># if porocity == 0 and permeability == 0:</span>
                        <span class="c1">#     edge[2] = 1e-32  # zero</span>
                        <span class="c1"># elif permeability == 0:</span>
                        <span class="c1">#     # void fraction, stenosis</span>
                        <span class="c1">#     radius = numpy.sqrt(porocity) * (node1.RefRadius + node2.RefRadius) / 2</span>
                        <span class="c1">#     G = 1e-9 * (numpy.pi * numpy.power(radius, 4)) / (frictionconstant * bloodvisc * length)</span>
                        <span class="c1">#     edge[2] = G + 1e-32</span>
                        <span class="c1">#     node1.Radius = node1.RefRadius*numpy.sqrt(porocity)</span>
                        <span class="c1">#     node2.Radius = node2.RefRadius*numpy.sqrt(porocity)</span>
                        <span class="c1">#</span>
                        <span class="c1"># elif porocity == 0:</span>
                        <span class="c1">#     # permeable, darcy&#39;s law, units m^2 (range (1.0  1e-17) to (1.0  1e-7)?</span>
                        <span class="c1">#     # input units are mm^2 -&gt; multiply with 1e-6</span>
                        <span class="c1">#     area = numpy.power((node1.RefRadius + node2.RefRadius) / 2, 2) * numpy.pi</span>
                        <span class="c1">#     G = 1e-9 * permeability * area/(bloodvisc * length)</span>
                        <span class="c1">#     edge[2] = G + 1e-32</span>
                        <span class="c1"># else:</span>
                        <span class="c1">#     print(&quot;Error in clot.&quot;)</span>

                        <span class="c1"># scale radius (porocity = void fraction = stenosis?)</span>
                        <span class="c1"># radius = clot[1] * (node1.RefRadius + node2.RefRadius) / 2</span>
                        <span class="c1"># G = 1e-9 * (numpy.pi * numpy.power(radius, 4)) / (22 * bloodvisc * length)</span>
                        <span class="c1"># edge[2] = G + 1e-32</span>

                        <span class="c1"># scale conductance</span>
                        <span class="c1"># radius = (node1.RefRadius + node2.RefRadius) / 2</span>
                        <span class="c1"># G = 1e-9 * (numpy.pi * numpy.power(radius, 4)) / (22 * bloodvisc * length)</span>
                        <span class="c1"># edge[2] = G * clot[1] + 1e-32</span>

                        <span class="c1"># edge[2] = edge[2] * clot[1] + 1e-32  # 0.001 # Non-zero for permeable clots! value is defined in Clots.txt</span>
                        <span class="c1"># error if exactly zero</span>

            <span class="c1"># remove edges if both nodes are clot nodes.</span>
            <span class="c1"># clotnodes = [node for clot in self.Clots for node in clot[0]]</span>
            <span class="c1"># edges = [x for x in edges if not (x[0] in clotnodes and x[1] in clotnodes)]</span>

        <span class="n">duplicatenodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationDict</span><span class="p">()</span>
        <span class="n">nodestoreplace1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nodestoreplace2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">oldnodes1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">oldnodes2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">edge</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edges</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">duplicatenodes</span><span class="p">:</span>
                <span class="n">nodestoreplace1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="n">duplicatenodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
                <span class="n">oldnodes1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">duplicatenodes</span><span class="p">:</span>
                <span class="n">nodestoreplace2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="n">duplicatenodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>
                <span class="n">oldnodes2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">replace</span> <span class="ow">in</span> <span class="n">nodestoreplace1</span><span class="p">:</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">replace</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">replace</span> <span class="ow">in</span> <span class="n">nodestoreplace2</span><span class="p">:</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">replace</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">nodeset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">nodeset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">nodeset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">nodesetlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nodeset</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodesetlist</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">ssindex</span> <span class="o">=</span> <span class="n">index</span>

        <span class="n">mtx</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">lil_matrix</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">nodesetlist</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodesetlist</span><span class="p">)))</span>

        <span class="k">def</span> <span class="nf">updatemat</span><span class="p">(</span><span class="n">edge</span><span class="p">):</span>
            <span class="n">index1</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ssindex</span>
            <span class="n">index2</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ssindex</span>
            <span class="n">mtx</span><span class="p">[</span><span class="n">index1</span><span class="p">,</span> <span class="n">index2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">mtx</span><span class="p">[</span><span class="n">index2</span><span class="p">,</span> <span class="n">index1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">with</span> <span class="n">Pool</span><span class="p">()</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">updatemat</span><span class="p">,</span> <span class="n">edges</span><span class="p">)</span>

        <span class="n">rowsum</span> <span class="o">=</span> <span class="n">mtx</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodesetlist</span><span class="p">)):</span>
            <span class="n">mtx</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">rowsum</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="c1"># inputvector = scipy.sparse.lil_matrix((len(nodesetlist), 1))</span>
        <span class="n">inputvector</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">nodesetlist</span><span class="p">),))</span>

        <span class="c1"># outlet flowrates</span>
        <span class="k">if</span> <span class="n">FlowRateOutlets</span><span class="p">:</span>
            <span class="c1"># for outlet in OutletNodes:</span>
            <span class="c1">#     inputvector[outlet.ssindex] = outlet.OutPressure</span>
            <span class="c1">#     index1 = outlet.ssindex</span>
            <span class="c1">#     inputvector[next(iter(outlet.Connections)).ssindex] = outlet.OutletFlowRate  # flowrate at that wk node</span>
            <span class="c1">#     mtx[index1, next(iter(outlet.Connections)).ssindex] = 0</span>
            <span class="c1">#     mtx[index1, index1] = 1</span>
            <span class="k">for</span> <span class="n">outlet</span> <span class="ow">in</span> <span class="n">OutletNodes</span><span class="p">:</span>
                <span class="n">inputvector</span><span class="p">[</span><span class="n">outlet</span><span class="o">.</span><span class="n">ssindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">outlet</span><span class="o">.</span><span class="n">OutletFlowRate</span>  <span class="c1"># flowrate at that wk node</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># pressure at that wk node, outpressure</span>
            <span class="k">for</span> <span class="n">outlet</span> <span class="ow">in</span> <span class="n">OutletNodes</span><span class="p">:</span>
                <span class="n">inputvector</span><span class="p">[</span><span class="n">outlet</span><span class="o">.</span><span class="n">ssindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">outlet</span><span class="o">.</span><span class="n">OutPressure</span>
                <span class="n">index1</span> <span class="o">=</span> <span class="n">outlet</span><span class="o">.</span><span class="n">ssindex</span>
                <span class="n">mtx</span><span class="p">[</span><span class="n">index1</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">outlet</span><span class="o">.</span><span class="n">Connections</span><span class="p">))</span><span class="o">.</span><span class="n">ssindex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">mtx</span><span class="p">[</span><span class="n">index1</span><span class="p">,</span> <span class="n">index1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># if using pressure at the inlet:</span>
        <span class="k">if</span> <span class="n">PressureInlets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">inletnode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">:</span>
                <span class="n">inputvector</span><span class="p">[</span><span class="n">inletnode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ssindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">inletnode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">InletPressure</span>  <span class="c1"># standard units Pa</span>
                <span class="n">index1</span> <span class="o">=</span> <span class="n">inletnode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ssindex</span>
                <span class="n">mtx</span><span class="p">[</span><span class="n">index1</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">inletnode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Connections</span><span class="p">))</span><span class="o">.</span><span class="n">ssindex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">mtx</span><span class="p">[</span><span class="n">index1</span><span class="p">,</span> <span class="n">index1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># inlet flowrates</span>
            <span class="k">for</span> <span class="n">inletnode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">:</span>
                <span class="n">inputvector</span><span class="p">[</span><span class="n">inletnode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ssindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">inletnode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">InletFlowRate</span>  <span class="c1"># standard units m^3/s</span>

        <span class="k">return</span> <span class="n">mtx</span><span class="o">.</span><span class="n">tocsc</span><span class="p">(),</span> <span class="n">inputvector</span><span class="p">,</span> <span class="n">nodesetlist</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="p">(</span><span class="n">oldnodes1</span><span class="p">,</span> <span class="n">oldnodes2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">addCollateralsToTopology</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">vesselslist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Collaterals</span><span class="p">:</span>
            <span class="n">vessel</span> <span class="o">=</span> <span class="n">Vessel</span><span class="o">.</span><span class="n">Vessel</span><span class="p">()</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">SetNodes</span><span class="p">([</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="c1"># vessel.SetType(5)</span>
            <span class="c1"># vesselid = self.Vessels[-1].ID+1</span>
            <span class="c1"># vessel.SetID(vesselid)</span>
            <span class="n">vesselslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
        <span class="c1"># for edge in self.Collaterals:</span>
        <span class="c1">#     vessel = Vessel.Vessel()</span>
        <span class="c1">#     vessel.SetNodes([edge[0], edge[1]])</span>
        <span class="c1">#     vessel.SetType(5)</span>
        <span class="c1">#     vesselid = self.Vessels[-1].ID+1</span>
        <span class="c1">#     vessel.SetID(vesselid)</span>
        <span class="c1">#     self.Vessels.append(vessel)</span>
        <span class="c1"># self.UpdateTopology()</span>
        <span class="n">nodelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vesselslist</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>

        <span class="n">nodes</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPoints</span><span class="p">()</span>
        <span class="n">vessels</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellArray</span><span class="p">()</span>
        <span class="c1"># radius = vtk.vtkFloatArray()</span>
        <span class="c1">#</span>
        <span class="c1"># radius.SetNumberOfComponents(1)</span>
        <span class="c1"># radius.SetName(&quot;Radius&quot;)</span>
        <span class="c1">#</span>
        <span class="c1"># nodetype = vtk.vtkIntArray()</span>
        <span class="c1"># nodetype.SetName(&quot;Node Type &quot;)</span>

        <span class="c1"># Add radius and position to data array</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodelist</span><span class="p">):</span>
            <span class="n">i</span><span class="o">.</span><span class="n">Number</span> <span class="o">=</span> <span class="n">index</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
            <span class="c1"># radius.InsertNextValue(float(i.Radius))</span>
            <span class="c1"># nodetype.InsertNextValue(i.Type)</span>

        <span class="c1"># Add vessels to cell array</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vesselslist</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkLine</span><span class="p">()</span>
            <span class="n">line</span><span class="o">.</span><span class="n">GetPointIds</span><span class="p">()</span><span class="o">.</span><span class="n">SetNumberOfIds</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)):</span>
                <span class="n">line</span><span class="o">.</span><span class="n">GetPointIds</span><span class="p">()</span><span class="o">.</span><span class="n">SetId</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
            <span class="n">vessels</span><span class="o">.</span><span class="n">InsertNextCell</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># Create a polydata to store everything in</span>
        <span class="n">VesselsPolyData</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">()</span>

        <span class="c1"># Add the nodes to the polydata</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">SetPoints</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

        <span class="c1"># Add the vessels to the polydata</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">SetLines</span><span class="p">(</span><span class="n">vessels</span><span class="p">)</span>

        <span class="c1"># Assign radii to the nodes</span>
        <span class="c1"># VesselsPolyData.GetPointData().SetScalars(radius)</span>
        <span class="c1"># VesselsPolyData.GetPointData().AddArray(nodetype)</span>

        <span class="c1"># atlas = vtk.vtkIntArray()</span>
        <span class="c1"># [atlas.InsertNextValue(i.ID) for index, i in enumerate(self.Vessels)]</span>
        <span class="c1"># atlas.SetName(&quot;Vessel Ids&quot;)</span>
        <span class="c1"># VesselsPolyData.GetCellData().AddArray(atlas)</span>
        <span class="c1">#</span>
        <span class="c1"># majoratlas = vtk.vtkIntArray()</span>
        <span class="c1"># [majoratlas.InsertNextValue(i.MajorVesselID) for index, i in enumerate(self.Vessels)]</span>
        <span class="c1"># majoratlas.SetName(&quot;Major Vessel Ids&quot;)</span>
        <span class="c1"># VesselsPolyData.GetCellData().AddArray(majoratlas)</span>

        <span class="c1"># Save everyting in a vtp file</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">VesselsPolyData</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>



    <span class="k">def</span> <span class="nf">SteadyStateNonLinear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">clotactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">PressureInlets</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">conductancematrix</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Get1DsteadyNetwork</span><span class="p">(</span><span class="n">bloodvisc</span><span class="p">,</span> <span class="n">clotactive</span><span class="p">,</span>
                                                                                    <span class="n">PressureInlets</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodes</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="o">=</span> <span class="n">index</span>

        <span class="n">vesselbifnodes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span> <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># todo get indices of bifurcation vessel nodes and update resisuals. There is an error relating to the numbering of the nodes.</span>
        <span class="c1"># The matrix has to be updated to handle this system.</span>

        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">pressures</span><span class="p">):</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="n">conductancematrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pressures</span><span class="p">)</span> <span class="o">-</span> <span class="n">sources</span>
            <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">vesselbifnodes</span><span class="p">:</span>
                <span class="c1"># flow = sum([(pressures[node.Number]-pressures[node.NearestVesselNode.Number])*conductancematrix[node.Number,node.NearestVesselNode.Number] for node in bif])</span>

                <span class="n">residuals</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> \
                                           <span class="n">conductancematrix</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bif</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                    <span class="n">residuals</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> \
                                                <span class="n">conductancematrix</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>
                    <span class="n">velocity</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> <span class="n">conductancematrix</span><span class="p">[</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">node</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">node</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                    <span class="n">bernoulli</span> <span class="o">=</span> <span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">density</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">velocity</span> <span class="o">*</span> <span class="n">velocity</span>
                    <span class="n">velocity2</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span>
                        <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> <span class="n">conductancematrix</span><span class="p">[</span>
                                    <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
                                        <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                    <span class="n">bernoulli2</span> <span class="o">=</span> <span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">density</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">velocity2</span> <span class="o">*</span> <span class="n">velocity2</span>
                    <span class="n">residuals</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="n">bernoulli</span> <span class="o">-</span> <span class="n">bernoulli2</span>

            <span class="k">return</span> <span class="n">residuals</span>

        <span class="c1"># guess = func(numpy.zeros((nodeslength,)))</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="mi">10000</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">))</span>
        <span class="c1"># guess = []</span>
        <span class="c1"># for vessel in self.Vessels:</span>
        <span class="c1">#     for node in vessel.Nodes:</span>
        <span class="c1">#         guess.append(node.Pressure)</span>
        <span class="c1">#</span>

        <span class="n">solution</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">fsolve</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">nonlinearmodel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">,</span> <span class="n">density</span><span class="p">):</span>
        <span class="c1"># for each vessel node, create a list of conservation of flow</span>
        <span class="c1"># use the matrix from the linear model but with the bifurcations removed</span>

        <span class="c1"># we can use the same code for most</span>
        <span class="c1"># be sure to subtract the input vector and only return the pressure of the correct nodes</span>

        <span class="c1"># the matrix is fine for the linear parts</span>
        <span class="c1"># use matrix notation for the nonlinear parts as well</span>
        <span class="c1"># code needs to be fast in the future.</span>

        <span class="c1"># matrix for the linear system with removed bifurcations replacement</span>
        <span class="c1"># return residuals for the vessel nodes inc outlets and inlets</span>

        <span class="c1"># calculate the velocity at the bifurcation node</span>
        <span class="c1"># calcualte the residuals for the bifurcations</span>

        <span class="c1"># probably better to use a loop</span>
        <span class="c1"># make a list of edges to store the connectivity information</span>
        <span class="c1"># loop over bifurcations, inlet and outlets.</span>

        <span class="c1"># store a list of information about which node the pressure belongs to</span>
        <span class="n">nodeslength</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">)</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[:</span><span class="n">nodeslength</span><span class="p">]</span>
        <span class="c1"># assumption is that the pressure input is in the same order as the nodes</span>

        <span class="n">conductancematrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nodeslength</span><span class="p">,</span> <span class="n">nodeslength</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="c1"># first and last nodes</span>
            <span class="n">conductancematrix</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">SegmentConductance</span><span class="p">(</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">bloodvisc</span><span class="p">)</span>

            <span class="n">conductancematrix</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">SegmentConductance</span><span class="p">(</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">bloodvisc</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">conductancematrix</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">SegmentConductance</span><span class="p">(</span>
                    <span class="n">node</span><span class="p">,</span>
                    <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
                    <span class="n">bloodvisc</span><span class="p">)</span>
                <span class="n">conductancematrix</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">SegmentConductance</span><span class="p">(</span>
                    <span class="n">node</span><span class="p">,</span>
                    <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span>
                    <span class="n">bloodvisc</span><span class="p">)</span>

        <span class="n">rowsum</span> <span class="o">=</span> <span class="n">conductancematrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)):</span>
            <span class="n">conductancematrix</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">rowsum</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="c1"># add the conductance from the WK outlets</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">outlet</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">):</span>
            <span class="n">conductancematrix</span><span class="p">[</span><span class="n">outlet</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">outlet</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">outlet</span><span class="o">.</span><span class="n">R1</span> <span class="o">+</span> <span class="n">outlet</span><span class="o">.</span><span class="n">R2</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># add the vesselnodes that connect to vesselbifurcationnodes for easy access.</span>
        <span class="n">vesselbifnodes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span> <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">]</span>

        <span class="n">sources</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nodeslength</span><span class="p">,))</span>

        <span class="c1"># inlets</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">inlet</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">):</span>
            <span class="n">sources</span><span class="p">[</span><span class="n">inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="n">inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">InletFlowRate</span>

        <span class="c1"># outlets</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">outlet</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">):</span>
            <span class="n">sources</span><span class="p">[</span><span class="n">outlet</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="n">outlet</span><span class="o">.</span><span class="n">OutPressure</span> <span class="o">/</span> <span class="p">(</span><span class="n">outlet</span><span class="o">.</span><span class="n">R1</span> <span class="o">+</span> <span class="n">outlet</span><span class="o">.</span><span class="n">R2</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">pressures</span><span class="p">):</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="n">conductancematrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pressures</span><span class="p">)</span> <span class="o">-</span> <span class="n">sources</span>
            <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">vesselbifnodes</span><span class="p">:</span>
                <span class="c1"># flow = sum([(pressures[node.Number]-pressures[node.NearestVesselNode.Number])*conductancematrix[node.Number,node.NearestVesselNode.Number] for node in bif])</span>
                <span class="n">residuals</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> \
                                           <span class="n">conductancematrix</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bif</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                    <span class="n">residuals</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> \
                                                <span class="n">conductancematrix</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>
                    <span class="n">velocity</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> <span class="n">conductancematrix</span><span class="p">[</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">node</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">node</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                    <span class="n">bernoulli</span> <span class="o">=</span> <span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">density</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">velocity</span> <span class="o">*</span> <span class="n">velocity</span>
                    <span class="n">velocity2</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span>
                        <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> <span class="n">conductancematrix</span><span class="p">[</span>
                                    <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
                                        <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                    <span class="n">bernoulli2</span> <span class="o">=</span> <span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">density</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">velocity2</span> <span class="o">*</span> <span class="n">velocity2</span>
                    <span class="n">residuals</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="n">bernoulli</span> <span class="o">-</span> <span class="n">bernoulli2</span>

            <span class="k">return</span> <span class="n">residuals</span>

        <span class="c1"># guess = func(numpy.zeros((nodeslength,)))</span>
        <span class="c1"># guess = [node.Pressure for vessel in self.Vessels for node in vessel.Nodes]</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                <span class="n">guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Pressure</span><span class="p">)</span>
        <span class="c1">#</span>

        <span class="n">solution</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">fsolve</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">guess</span><span class="p">)</span>  <span class="c1"># ,full_output=True)</span>
        <span class="c1"># print(solution[1])</span>
        <span class="c1"># solution = scipy.linalg.solve(conductancematrix, sources)</span>
        <span class="k">return</span> <span class="n">solution</span><span class="p">,</span> <span class="n">nodes</span>


<span class="k">class</span> <span class="nc">Tree</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object that defines the bifurcating trees.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfGenerations</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="sd">&quot;&quot;&quot;Number of vessel generations&quot;&quot;&quot;</span>
        <span class="n">node</span><span class="o">.</span><span class="n">SetDirectionVector</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Direction</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">DirectionVector</span><span class="p">]</span>
        <span class="sd">&quot;&quot;&quot;Direction of the bifurcating tree&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span> <span class="o">=</span> <span class="n">node</span>
        <span class="sd">&quot;&quot;&quot;Root node of the tree&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">StartingTreeNodes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;First node of the tree (bifurcation node)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EndNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>
        <span class="sd">&quot;&quot;&quot;Outlets of the tree&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;All nodes&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;Tree vessels&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;Bifurcation nodes&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LengthRadiusRatio</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="sd">&quot;&quot;&quot;Length to radius ratio&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">GenerateTree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a bifurcating tree at the endnodes of the tree.</span>
<span class="sd">        Vessels are added until a cut-off radius.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cutoff : float</span>
<span class="sd">            Cut-off radius to stop the adding of vessels at the end of the tree.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Newendnodes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">endnode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">EndNodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">endnode</span><span class="o">.</span><span class="n">Radius</span> <span class="o">&gt;</span> <span class="n">cutoff</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfGenerations</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># calculate node properties</span>
                    <span class="n">r1</span> <span class="o">=</span> <span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">murraylaw</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                    <span class="n">r2</span> <span class="o">=</span> <span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">murraylaw</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                    <span class="n">l1</span> <span class="o">=</span> <span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">RadiusToLength</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
                    <span class="n">l2</span> <span class="o">=</span> <span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">RadiusToLength</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>

                    <span class="n">direction</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">endnode</span><span class="o">.</span><span class="n">DirectionVector</span><span class="p">]</span>

                    <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">theta</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">angle</span>
                    <span class="n">theta2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">angle</span>

                    <span class="n">posvec</span> <span class="o">=</span> <span class="p">[</span><span class="n">l1</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>
                              <span class="n">l1</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>
                              <span class="mi">0</span><span class="p">]</span>
                    <span class="n">posvec2</span> <span class="o">=</span> <span class="p">[</span><span class="n">l2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta2</span><span class="p">),</span>
                               <span class="n">l2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta2</span><span class="p">),</span>
                               <span class="mi">0</span><span class="p">]</span>

                    <span class="n">pos1end</span> <span class="o">=</span> <span class="p">[</span><span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">posvec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">posvec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">posvec</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                    <span class="n">pos2end</span> <span class="o">=</span> <span class="p">[</span><span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">posvec2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">posvec2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">posvec2</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

                    <span class="n">pos1mid</span> <span class="o">=</span> <span class="p">[</span><span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">posvec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">posvec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">posvec</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                    <span class="n">pos2mid</span> <span class="o">=</span> <span class="p">[</span><span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">posvec2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">posvec2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">posvec2</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

                    <span class="c1"># create new nodes</span>
                    <span class="n">bifurcationnode</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                    <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
                    <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>

                    <span class="n">vessel1node1</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                    <span class="n">vessel1node1</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
                    <span class="n">vessel1node1</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">vessel1node1</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
                    <span class="n">vessel1node1</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>
                    <span class="n">vessel1node2</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                    <span class="n">vessel1node2</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">pos1mid</span><span class="p">)</span>
                    <span class="n">vessel1node2</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">l1</span><span class="p">)</span>
                    <span class="n">vessel1node2</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
                    <span class="n">vessel1node2</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>
                    <span class="n">vessel1node3</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                    <span class="n">vessel1node3</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">pos1end</span><span class="p">)</span>
                    <span class="n">vessel1node3</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="n">l1</span><span class="p">)</span>
                    <span class="n">vessel1node3</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
                    <span class="n">vessel1node3</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>

                    <span class="n">vessel2node1</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                    <span class="n">vessel2node1</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
                    <span class="n">vessel2node1</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">vessel2node1</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                    <span class="n">vessel2node1</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>
                    <span class="n">vessel2node2</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                    <span class="n">vessel2node2</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">pos2mid</span><span class="p">)</span>
                    <span class="n">vessel2node2</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">l2</span><span class="p">)</span>
                    <span class="n">vessel2node2</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                    <span class="n">vessel2node2</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>
                    <span class="n">vessel2node3</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                    <span class="n">vessel2node3</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">pos2end</span><span class="p">)</span>
                    <span class="n">vessel2node3</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="n">l2</span><span class="p">)</span>
                    <span class="n">vessel2node3</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                    <span class="n">vessel2node3</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>

                    <span class="n">vessel1</span> <span class="o">=</span> <span class="n">Vessel</span><span class="o">.</span><span class="n">Vessel</span><span class="p">()</span>
                    <span class="n">vessel1</span><span class="o">.</span><span class="n">SetType</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">vessel2</span> <span class="o">=</span> <span class="n">Vessel</span><span class="o">.</span><span class="n">Vessel</span><span class="p">()</span>
                    <span class="n">vessel2</span><span class="o">.</span><span class="n">SetType</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">vessel1</span><span class="o">.</span><span class="n">SetNodes</span><span class="p">([</span><span class="n">vessel1node1</span><span class="p">,</span> <span class="n">vessel1node2</span><span class="p">,</span> <span class="n">vessel1node3</span><span class="p">])</span>
                    <span class="n">vessel2</span><span class="o">.</span><span class="n">SetNodes</span><span class="p">([</span><span class="n">vessel2node1</span><span class="p">,</span> <span class="n">vessel2node2</span><span class="p">,</span> <span class="n">vessel2node3</span><span class="p">])</span>

                    <span class="n">vessel1</span><span class="o">.</span><span class="n">SetLength</span><span class="p">(</span><span class="n">l1</span><span class="p">)</span>
                    <span class="n">vessel2</span><span class="o">.</span><span class="n">SetLength</span><span class="p">(</span><span class="n">l2</span><span class="p">)</span>
                    <span class="n">vessel1</span><span class="o">.</span><span class="n">SetMeanRadius</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
                    <span class="n">vessel2</span><span class="o">.</span><span class="n">SetMeanRadius</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                    <span class="c1"># vessel1.SetGridSize(0.5 * l1)</span>
                    <span class="c1"># vessel2.SetGridSize(0.5 * l2)</span>
                    <span class="n">vessel1</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>
                    <span class="n">vessel2</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>
                    <span class="c1"># Set connections</span>
                    <span class="c1"># do not add them to the main topology for now</span>
                    <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel1node1</span><span class="p">)</span>
                    <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel2node1</span><span class="p">)</span>

                    <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">((</span><span class="n">r1</span> <span class="o">+</span> <span class="n">endnode</span><span class="o">.</span><span class="n">Radius</span> <span class="o">+</span> <span class="n">r2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>

                    <span class="n">vessel1node1</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bifurcationnode</span><span class="p">)</span>
                    <span class="n">vessel1node1</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel1node2</span><span class="p">)</span>
                    <span class="n">vessel1node2</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel1node1</span><span class="p">)</span>
                    <span class="n">vessel1node2</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel1node3</span><span class="p">)</span>
                    <span class="n">vessel1node3</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel1node2</span><span class="p">)</span>

                    <span class="n">vessel2node1</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bifurcationnode</span><span class="p">)</span>
                    <span class="n">vessel2node1</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel2node2</span><span class="p">)</span>
                    <span class="n">vessel2node2</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel2node1</span><span class="p">)</span>
                    <span class="n">vessel2node2</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel2node3</span><span class="p">)</span>
                    <span class="n">vessel2node3</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel2node2</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfGenerations</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">endnode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bifurcationnode</span><span class="p">)</span>
                        <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">endnode</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">StartingTreeNodes</span> <span class="o">=</span> <span class="n">bifurcationnode</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bifurcationnode</span><span class="p">)</span>
                    <span class="n">Newendnodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel1node3</span><span class="p">)</span>
                    <span class="n">Newendnodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel2node3</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel2</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bifurcationnode</span><span class="p">)</span>

                    <span class="c1"># self.Nodes.append(vessel1node1)</span>
                    <span class="c1"># self.Nodes.append(vessel1node2)</span>
                    <span class="c1"># self.Nodes.append(vessel1node3)</span>
                    <span class="c1"># self.Nodes.append(vessel2node1)</span>
                    <span class="c1"># self.Nodes.append(vessel2node2)</span>
                    <span class="c1"># self.Nodes.append(vessel2node3)</span>
                    <span class="n">vessel1node3</span><span class="o">.</span><span class="n">SetDirectionVector</span><span class="p">()</span>
                    <span class="n">vessel2node3</span><span class="o">.</span><span class="n">SetDirectionVector</span><span class="p">()</span>
                    <span class="n">numbernodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">vessel1</span><span class="o">.</span><span class="n">Length</span> <span class="o">/</span> <span class="n">vessel1</span><span class="o">.</span><span class="n">GridSize</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">vessel1</span><span class="o">.</span><span class="n">UpdateResolution</span><span class="p">(</span><span class="n">numbernodes</span><span class="p">)</span>
                    <span class="n">numbernodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">vessel2</span><span class="o">.</span><span class="n">Length</span> <span class="o">/</span> <span class="n">vessel2</span><span class="o">.</span><span class="n">GridSize</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">vessel2</span><span class="o">.</span><span class="n">UpdateResolution</span><span class="p">(</span><span class="n">numbernodes</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel1</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel2</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Newendnodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">EndNodes</span> <span class="o">=</span> <span class="n">Newendnodes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfGenerations</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># rotation to match the direction of the original vessel</span>

        <span class="n">Vo</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Direction</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Direction</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Direction</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">Vn</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Direction</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Direction</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">Vcross</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">Vn</span><span class="p">,</span> <span class="n">Vo</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Vn</span><span class="p">,</span> <span class="n">Vo</span><span class="p">)</span>
        <span class="n">Vx</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">Vcross</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Vcross</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
              <span class="p">[</span><span class="n">Vcross</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">Vcross</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
              <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">Vcross</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Vcross</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]]</span>

        <span class="n">R</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">Vx</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Vx</span><span class="p">,</span> <span class="n">Vx</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">C</span><span class="p">))</span>
        <span class="n">Rnew</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">Rnew</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span>

        <span class="n">Translate1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="n">Translate2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>

        <span class="n">TMatrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Translate2</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Rnew</span><span class="p">,</span> <span class="n">Translate1</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">Position</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">TMatrix</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>
            <span class="n">posnew</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">posnew</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ConnectTree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the neccessary connections between the inital node and the first node of the tree.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">StartingTreeNodes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">StartingTreeNodes</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="p">)</span>
</pre></div>

        </details>

            </section>
                <section id="Topology">
                                <div class="attr class">
        <a class="headerlink" href="#Topology">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Topology</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Topology</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coarse_collaterals_effective_radius</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coarse_collaterals_number</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coarse_collaterals_threshold</span> <span class="o">=</span> <span class="mi">25</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coarse_collaterals_After_WKNodes</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># set to true for coupled model with estimated coupling resistance.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfVessels</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfNodes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Clots</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Graph</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NodeDict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">MapbifurcationstoVessels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For each bifurcation in topology (self.BifurcationNodes),</span>
<span class="sd">        the VesselConnections is created with the connected vessels.</span>
<span class="sd">        :return: None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># vesseldist = {item: sublist for sublist in self.Vessels for item in sublist.Nodes}</span>
        <span class="n">vesseldist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NodeVesselDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="n">bif</span><span class="o">.</span><span class="n">VesselConnections</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">vesseldist</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">MapNodesToVesselID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a dictionary of nodes to major vessel ID</span>
<span class="sd">        :return: dict with keys the nodes and values their major vessel ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nodedict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)):</span>
            <span class="p">[</span><span class="n">nodedict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">nodedict</span>

    <span class="k">def</span> <span class="nf">NodeVesselDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a dict that maps nodes to the vessel.</span>
<span class="sd">        Sets self.NodeDict</span>
<span class="sd">        :return: dictionary of nodes to vessels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NodeDict</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="n">vessel</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">NodeDict</span>

    <span class="k">def</span> <span class="nf">VesselGraph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vertices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">GetProximalBifurcation</span><span class="p">()</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">GetDistalBifurcation</span><span class="p">()</span>
            <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">vessel</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">edges</span>

    <span class="k">def</span> <span class="nf">GetVesselNameFromNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Name</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Node not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">UpdateNodeType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">SetType</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Type</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Type</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">:</span>
            <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Type</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">UpdateM2Names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the vessel names of the m2 vessels.</span>
<span class="sd">        Smaller branch:inferior branch</span>
<span class="sd">        Larger branch: superior branch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateVesselAtlas</span><span class="p">()</span>

        <span class="c1"># find both sides</span>
        <span class="n">sides</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;R. MCA&quot;</span><span class="p">,</span> <span class="s2">&quot;L. MCA&quot;</span><span class="p">]</span>
        <span class="n">new_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;M2 sup&quot;</span><span class="p">,</span> <span class="s2">&quot;M2 inf&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="n">sides</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">gens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetDownstreamVessels</span><span class="p">(</span><span class="n">side</span><span class="p">)</span>
            <span class="c1"># assuming vessels exist</span>
            <span class="n">downstream1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetDownstreamVessels</span><span class="p">(</span><span class="n">gens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">downstream2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetDownstreamVessels</span><span class="p">(</span><span class="n">gens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># sup branch has more downstream vessels?</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">downstream1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">downstream2</span><span class="p">):</span>
                <span class="n">gens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">side</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">new_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">gens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">side</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">new_names</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">side</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">new_names</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">gens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">side</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">new_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateVesselAtlas</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">UpdateVesselAtlas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an dictionary keyed to vessel name and vessel id.</span>
<span class="sd">        Value returned from the dictionary is the vessel.</span>
<span class="sd">        :return: None, self.VesselAtlas is updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">]</span> <span class="o">=</span> <span class="n">vessel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">vessel</span>

    <span class="k">def</span> <span class="nf">UpdateTopology</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">]</span>
        <span class="c1"># [vessel.SetID(id) for id, vessel in enumerate(self.Vessels)]</span>
        <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">UpdateVessel</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateVesselAtlas</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateNumbers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateNodeType</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberNodes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CheckConnectivity</span><span class="p">()</span>
        <span class="c1"># self.FindOutletNodes()</span>

    <span class="k">def</span> <span class="nf">WriteNodesCSV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ID,VesselID,Connectivity,Position,Radius,LengthAlongVessel,Elasticity,R1,R2,C,Thickness,Type</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">VesselID</span><span class="p">)</span>
                <span class="n">othernodes</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Connections</span><span class="p">)])</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">othernodes</span><span class="p">)</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">Position</span><span class="p">])</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">pos</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">YoungsModules</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">R1</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">R1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">R2</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">R2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">C</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">C</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">Thickness</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">WriteVesselCSV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Name,ID,Radius(mm),Length(mm),YoungsModules(pa),MeanThickness(mm),Type,Nodes</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">CalculateMeanRadius</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">vessel</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanRadius</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">vessel</span><span class="o">.</span><span class="n">YoungsModules</span><span class="p">)</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">CalculateMeanThickness</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanThickness</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>
                <span class="n">Nodes</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)])</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Nodes</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">BifurcationDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a dictionary of the bifurcation nodes.</span>
<span class="sd">        Keys are the nodes of the system and return value is the linked bifurcation node</span>
<span class="sd">        :return: dict{node:bifnode}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">duplicatenodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">):</span>
                <span class="n">duplicatenodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">bif</span>
        <span class="k">return</span> <span class="n">duplicatenodes</span>

    <span class="k">def</span> <span class="nf">UpdateNumbers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfVessels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfNodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span>
        <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">UpdateNodeNumber</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">SetThickness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Thickness</span> <span class="o">=</span> <span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">thickness</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">CheckConnectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking for disconnected nodes.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Disconnected node detected at node number </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">index</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;None Found.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">SaveVesselAtlas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;Mapping.csv&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No Atlas defined.&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing the vessel Atlas to file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>
        <span class="c1"># check if there are nodes without a number.</span>
        <span class="c1"># if so, renumber all nodes.</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">NumberNodes</span><span class="p">()</span>
                <span class="k">break</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">):</span>
                <span class="n">vesselname</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Name</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
                <span class="n">nodelist</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">vesselname</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">,&quot;</span> <span class="o">+</span> <span class="n">nodelist</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadSegmentedVessels_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputfolder</span><span class="p">):</span>
        <span class="c1"># temp solution</span>

        <span class="n">finalfile</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="s2">&quot;1-D_Anatomy_Patient.txt&quot;</span>
        <span class="n">readfile</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="s2">&quot;Feature_Vessel.csv&quot;</span>
        <span class="n">readfile2</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="s2">&quot;Image_info.txt&quot;</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="nb">float</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">readfile2</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="s2">&quot;1-D_Anatomy.txt&quot;</span>

        <span class="n">vesselscsv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">readfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
            <span class="n">readCSV</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">readCSV</span><span class="p">:</span>
                <span class="n">vesselscsv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="n">vessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vesselscsv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">vesseldata</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;vessel&#39;</span><span class="p">,</span> <span class="s1">&#39;ID Length Radius&#39;</span><span class="p">)</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">ID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">Length</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">Radius</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vesseldata</span><span class="p">)</span>

        <span class="n">anatomy</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>

        <span class="c1"># mapping between anatomy and patient segmented vessels</span>
        <span class="c1"># VesselID segmentation, name from segmentation, ID in 1-D anatomy</span>
        <span class="n">MapSegmentation</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;ICA L&quot;</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;ICA R&quot;</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;M1 L&quot;</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;M1 R&quot;</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;M2 L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;M2 R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;A1 L&quot;</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;A1 R&quot;</span><span class="p">,</span> <span class="mi">26</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="s2">&quot;A2 L&quot;</span><span class="p">,</span> <span class="mi">29</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;A2 R&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="s2">&quot;AComm&quot;</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;M3 L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="s2">&quot;M3 R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="s2">&quot;VA L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># 17</span>
                           <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;VA R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># 14</span>
                           <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s2">&quot;BA&quot;</span><span class="p">,</span> <span class="mi">22</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="s2">&quot;P1 L&quot;</span><span class="p">,</span> <span class="mi">27</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="s2">&quot;P1 R&quot;</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="s2">&quot;P2 L&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;P2 R&quot;</span><span class="p">,</span> <span class="mi">33</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="s2">&quot;PComm L&quot;</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="s2">&quot;PComm R&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="s2">&quot;OA L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="s2">&quot;OA R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">]</span>

        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">MapSegmentation</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vessel</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">vessel</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
            <span class="n">mapped</span> <span class="o">=</span> <span class="n">MapSegmentation</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">finalfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">anatomy</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadSegmentedVessels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputfolder</span><span class="p">,</span> <span class="n">CoWFile</span><span class="o">=</span><span class="s2">&quot;1-D_Anatomy.txt&quot;</span><span class="p">):</span>
        <span class="c1"># temp solution</span>

        <span class="n">finalfile</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="s2">&quot;1-D_Anatomy_Patient.txt&quot;</span>
        <span class="n">readfile</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="s2">&quot;Feature_Vessel.csv&quot;</span>
        <span class="n">readfile2</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="s2">&quot;Image_info.txt&quot;</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="nb">float</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">readfile2</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">file</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="n">CoWFile</span>
        <span class="n">anatomy</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>

        <span class="n">vesselscsv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">readfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
            <span class="n">readCSV</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">readCSV</span><span class="p">:</span>
                <span class="n">vesselscsv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="n">vessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vesselscsv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">vesseldata</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;vessel&#39;</span><span class="p">,</span> <span class="s1">&#39;ID Length Radius Startmark Endmark vesselnumber StartPos EndPos&#39;</span><span class="p">)</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">ID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">StartPos</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">6</span><span class="p">]))</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">EndPos</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">7</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">8</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">9</span><span class="p">]))</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">Length</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="c1"># The field called A_diameter is actually the radius of the vessel in voxel units - Praneeta</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">Radius</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">Startmark</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">Endmark</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vesseldata</span><span class="p">)</span>

        <span class="c1"># mapping between anatomy and patient segmented vessels</span>
        <span class="c1"># VesselID segmentation, name from segmentation, ID in 1-D anatomy</span>
        <span class="n">MapSegmentation</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;ICA L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;ICA R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;M1 L&quot;</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;M1 R&quot;</span><span class="p">,</span> <span class="mi">22</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;M2 L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># not in default anatomy</span>
                           <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;M2 R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># not in default anatomy</span>
                           <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;A1 L&quot;</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;A1 R&quot;</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="s2">&quot;A2 L&quot;</span><span class="p">,</span> <span class="mi">27</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;A2 R&quot;</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="s2">&quot;AComm&quot;</span><span class="p">,</span> <span class="mi">29</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;M3 L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># not in default anatomy</span>
                           <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="s2">&quot;M3 R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># not in default anatomy</span>
                           <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="s2">&quot;VA L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># 17  # not part of the scan region but is not missing either.</span>
                           <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;VA R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># 14 # not part of the scan region but is not missing either.</span>
                           <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s2">&quot;BA&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># split into 5!</span>
                           <span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="s2">&quot;P1 L&quot;</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="s2">&quot;P1 R&quot;</span><span class="p">,</span> <span class="mi">26</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="s2">&quot;P2 L&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;P2 R&quot;</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="s2">&quot;PComm L&quot;</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="s2">&quot;PComm R&quot;</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="s2">&quot;OA L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># not part of the scan region but is not missing either.</span>
                           <span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="s2">&quot;OA R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">]</span>  <span class="c1"># not part of the scan region but is not missing either.</span>

        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">vesselnumber</span> <span class="o">=</span> <span class="n">MapSegmentation</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># set missing vessels to zero</span>
        <span class="c1"># some vessels are excluded as they have to be present but are not in the scans.</span>
        <span class="c1"># example, aortic arch (23,24)</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">MapSegmentation</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">vessel</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># overwrite default anatomy</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
            <span class="n">mapped</span> <span class="o">=</span> <span class="n">MapSegmentation</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>

        <span class="c1"># remove the inlet vessels as these are cut off during imaging (incorrect length)</span>
        <span class="n">vessels</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">])]</span>

        <span class="c1"># add vessels not present in default anatomy</span>
        <span class="c1"># &quot;M2 L&quot;  # not in default anatomy</span>
        <span class="c1"># &quot;M2 R&quot;  # not in default anatomy</span>
        <span class="c1"># &quot;M3 L&quot;  # not in default anatomy</span>
        <span class="c1"># &quot;M3 R&quot;  # not in default anatomy</span>
        <span class="c1"># assumption is that these always come in pairs</span>
        <span class="n">extravessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">newvessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
            <span class="n">mapped</span> <span class="o">=</span> <span class="n">MapSegmentation</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># print(vessel)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">mapped</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">extravessels</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;,2&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">extravessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;,1&quot;</span>
                <span class="n">length</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                <span class="n">youngsmodulus</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mf">1.6</span><span class="p">)</span>
                <span class="n">newves</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">youngsmodulus</span><span class="p">],</span> <span class="n">vessel</span><span class="p">]</span>
                <span class="n">newvessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newves</span><span class="p">)</span>

        <span class="c1"># add vessels to the anatomy</span>
        <span class="n">numberoldvessels</span> <span class="o">=</span> <span class="n">anatomy</span><span class="o">.</span><span class="n">index</span><span class="p">([</span><span class="s1">&#39;Bifurcations&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newvessels</span><span class="p">):</span>
            <span class="n">vessel</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">numberoldvessels</span> <span class="o">+</span> <span class="n">index</span><span class="p">)</span>
            <span class="n">vessel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">vesselnumber</span> <span class="o">=</span> <span class="n">numberoldvessels</span> <span class="o">+</span> <span class="n">index</span>
            <span class="n">anatomy</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">numberoldvessels</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># extract ends</span>
        <span class="n">endspos</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">StartPos</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">EndPos</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">]</span>
        <span class="n">ends</span> <span class="o">=</span> <span class="p">[</span><span class="n">end</span> <span class="k">for</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">endspos</span><span class="p">))]</span>
        <span class="n">marks</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">list</span><span class="p">(</span><span class="n">end</span><span class="p">),</span> <span class="p">[],</span> <span class="p">[]]</span> <span class="k">for</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">ends</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ends</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">vessel</span><span class="o">.</span><span class="n">StartPos</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>
                    <span class="n">marks</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">vessel</span><span class="o">.</span><span class="n">EndPos</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>
                    <span class="n">marks</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>

        <span class="c1"># extract bifurcations</span>
        <span class="n">bifurcations</span> <span class="o">=</span> <span class="p">[</span><span class="n">mark</span> <span class="k">for</span> <span class="n">mark</span> <span class="ow">in</span> <span class="n">marks</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mark</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">mark</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># assign numbers</span>
        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">bifurcations</span><span class="p">:</span>
            <span class="n">numbers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">bif</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">numbers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Startmark</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">bif</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">numbers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Endmark</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error in segmentation. Bifurcation has more than one ID.&quot;</span><span class="p">)</span>
            <span class="n">bif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">numbers</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># list the new bifurcations in the 1-D anatomy format</span>
        <span class="n">possiblenewvesselsbif</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">]</span>
        <span class="n">candidatebif</span> <span class="o">=</span> <span class="p">[</span><span class="n">bif</span> <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">bifurcations</span> <span class="k">if</span> <span class="n">bif</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="n">possiblenewvesselsbif</span><span class="p">]</span>

        <span class="c1"># we assume a certain direction, the segmentation do not seem to follow the same.</span>
        <span class="c1"># M1 R, 4-&gt;8, 4</span>
        <span class="c1"># M2 R, 8-&gt;14, 6</span>
        <span class="c1"># M3 R, 14-&gt;26, 13</span>
        <span class="c1"># M1 L, 3-&gt;7, 3</span>
        <span class="c1"># M2 L, 7-&gt;13, 5</span>
        <span class="c1"># M3 L, 13-&gt;25, 12</span>
        <span class="n">bifends</span> <span class="o">=</span> <span class="p">{</span><span class="mi">7</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                   <span class="mi">8</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
                   <span class="mi">13</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
                   <span class="mi">14</span><span class="p">:</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span>
                   <span class="mi">25</span><span class="p">:</span> <span class="p">(</span><span class="mi">12</span><span class="p">,),</span>
                   <span class="mi">26</span><span class="p">:</span> <span class="p">(</span><span class="mi">13</span><span class="p">,)}</span>

        <span class="n">newbifs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">inout</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">bif</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">candidatebif</span><span class="p">):</span>
            <span class="c1"># ends = [str(i.vesselnumber) + &quot;i&quot; for i in bif[0]]</span>
            <span class="c1"># ends += [str(i.vesselnumber) + &quot;o&quot; for i in bif[1]]</span>
            <span class="n">ends</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">endlist</span> <span class="o">=</span> <span class="n">bifends</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">bif</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">endlist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
                <span class="n">ends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">vesselnumber</span><span class="p">)</span> <span class="o">+</span> <span class="n">inout</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">bif</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">endlist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
                <span class="n">ends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">vesselnumber</span><span class="p">)</span> <span class="o">+</span> <span class="n">inout</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
            <span class="n">newbifs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ends</span><span class="p">))</span>

        <span class="n">endsbiflist</span> <span class="o">=</span> <span class="n">anatomy</span><span class="o">.</span><span class="n">index</span><span class="p">([</span><span class="s1">&#39;Boundary Nodes&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">newbif</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newbifs</span><span class="p">):</span>
            <span class="n">anatomy</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">endsbiflist</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span> <span class="p">[</span><span class="n">newbif</span><span class="p">])</span>

        <span class="n">ends</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Outlets Brain:&quot;</span><span class="p">]</span>
        <span class="n">nodesinbif</span> <span class="o">=</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">}</span>  <span class="c1"># only possible extra ones atm</span>
        <span class="n">startbiflist</span> <span class="o">=</span> <span class="n">anatomy</span><span class="o">.</span><span class="n">index</span><span class="p">([</span><span class="s1">&#39;Bifurcations&#39;</span><span class="p">])</span>
        <span class="n">endsbiflist</span> <span class="o">=</span> <span class="n">anatomy</span><span class="o">.</span><span class="n">index</span><span class="p">([</span><span class="s1">&#39;Boundary Nodes&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">anatomy</span><span class="p">[</span><span class="n">startbiflist</span><span class="p">:</span><span class="n">endsbiflist</span><span class="p">]:</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="p">[</span><span class="n">nodesinbif</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span> <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;o&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">startbiflist</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nodesinbif</span><span class="p">:</span>
                <span class="n">ends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
        <span class="n">anatomy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ends</span><span class="p">)]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">finalfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">anatomy</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadBFSimFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadTopFile</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;System.top&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadParFile</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;System.par&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadRunFile</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;Run.txt&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadVesselAtlas</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;Mapping.csv&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadClotFile</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;Clots.txt&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadTopFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading topology file.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ReadNodesFromTopFile</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CheckConnectivity</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">LoadParFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading parameter file.&quot;</span><span class="p">)</span>
        <span class="n">pardata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">pardata</span><span class="p">:</span>
            <span class="n">nodenumber</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">nodenumber</span><span class="p">]</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">:])</span> <span class="o">*</span> <span class="mf">1e9</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">:])</span> <span class="o">*</span> <span class="mf">1e9</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">:])</span> <span class="o">*</span> <span class="mf">1e-12</span>
            <span class="n">node</span><span class="o">.</span><span class="n">SetWK</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadRunFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading run file.&quot;</span><span class="p">)</span>
        <span class="n">rundata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>
        <span class="n">inletdata</span> <span class="o">=</span> <span class="n">rundata</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">11</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">inlet</span> <span class="ow">in</span> <span class="n">inletdata</span><span class="p">:</span>
            <span class="n">nodenumber</span><span class="p">,</span> <span class="n">inletfile</span> <span class="o">=</span> <span class="n">inlet</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nodenumber</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="n">inletfile</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadClotFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading clot file.&quot;</span><span class="p">)</span>
        <span class="n">clotdata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">clotdata</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotdata</span><span class="p">]</span>
        <span class="n">Clotids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotdata</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">clotid</span> <span class="ow">in</span> <span class="n">Clotids</span><span class="p">:</span>
            <span class="n">clotnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotdata</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">clotid</span><span class="p">]</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotnodes</span><span class="p">]</span>
            <span class="n">par1</span> <span class="o">=</span> <span class="n">clotnodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">par2</span> <span class="o">=</span> <span class="n">clotnodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Clots</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">nodes</span><span class="p">,</span> <span class="n">par1</span><span class="p">,</span> <span class="n">par2</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">LoadVTPFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vtpfile</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">vtpfile</span><span class="p">)</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">vtpfile</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

        <span class="n">pos_vtk</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetData</span><span class="p">()</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">pos_vtk</span><span class="p">)</span>

        <span class="n">VesselAtlas</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">vesselids</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">narray</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetNumberOfArrays</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">narray</span><span class="p">):</span>
            <span class="n">arrayname</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArrayName</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;MaximumInscribedSphereRadius&quot;</span> <span class="ow">or</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Radius&quot;</span><span class="p">:</span>
                <span class="n">radius_vtk</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Type&quot;</span><span class="p">:</span>
                <span class="c1">#  load in the vessel atlas</span>
                <span class="n">VesselAtlas</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="n">narray</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetNumberOfArrays</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">narray</span><span class="p">):</span>
            <span class="n">arrayname</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArrayName</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Vessel Ids&quot;</span><span class="p">:</span>
                <span class="c1">#  load in the vessel atlas</span>
                <span class="n">vesselids</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Major Vessel Ids&quot;</span><span class="p">:</span>
                <span class="c1">#  load in the vessel atlas</span>
                <span class="n">VesselAtlas</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="n">radius</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">radius_vtk</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)):</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">radius</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">node</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="n">NumberOfVessels</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetNumberOfCells</span><span class="p">()</span>
        <span class="n">vesselnodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NumberOfVessels</span><span class="p">):</span>
            <span class="n">numberofnodes</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCell</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCell</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">GetPointIds</span><span class="p">()</span>
            <span class="n">vesselnodes</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">ids</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numberofnodes</span><span class="p">)])</span>
            <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">SetVesselID</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vesselnodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="c1"># these include the bifurcations</span>

        <span class="c1"># Connections</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vesselnodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">currentnode</span> <span class="o">=</span> <span class="n">vessel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">neighbour</span> <span class="o">=</span> <span class="n">vessel</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">currentnode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">neighbour</span><span class="p">)</span>
                <span class="n">neighbour</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">currentnode</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">VesselAtlas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">VesselAtlas</span><span class="p">):</span>
                <span class="n">vessel</span> <span class="o">=</span> <span class="n">vesselnodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">=</span> <span class="nb">id</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">vesselids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vesselids</span><span class="p">):</span>
                <span class="n">vessel</span> <span class="o">=</span> <span class="n">vesselnodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">VesselID</span> <span class="o">=</span> <span class="nb">id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">FindBifurcationNodes</span><span class="p">()</span>

        <span class="c1"># extract bifurcations from the vessels</span>
        <span class="c1"># redefine nodes</span>
        <span class="n">bifurcations</span> <span class="o">=</span> <span class="p">[</span><span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">))]</span>
        <span class="p">[</span><span class="n">bifurcations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">))]</span>
        <span class="p">[</span><span class="n">bif</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">bifurcations</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vessel</span><span class="o">.</span><span class="n">Vessel</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vesselnodes</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vesselnodes</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="n">vessel</span>

        <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">InterpolateVessel3Dto1D</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">number</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vesselnodes</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">bifurcations</span><span class="p">[</span><span class="n">number</span><span class="p">]</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bifurcations</span><span class="p">[</span><span class="n">number</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">bifurcations</span><span class="p">[</span><span class="n">number</span><span class="p">]</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bifurcations</span><span class="p">[</span><span class="n">number</span><span class="p">])</span>

        <span class="p">[</span><span class="n">bifurcation</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">Radius</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bifurcation</span><span class="o">.</span><span class="n">Connections</span><span class="p">]))</span> <span class="k">for</span> <span class="n">bifurcation</span> <span class="ow">in</span> <span class="n">bifurcations</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="n">bifurcations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FindlargestInlets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CheckConnectivity</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateNodeType</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">Load1DAnatomy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading anatomy from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">bfdata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>
        <span class="n">BifurcationsIndex</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;Bifurcations&quot;</span><span class="p">)</span>
        <span class="n">BCIndex</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;Boundary Nodes&quot;</span><span class="p">)</span>

        <span class="n">vessels</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">BifurcationsIndex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="n">bifurcations</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">[</span><span class="n">BifurcationsIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">BCIndex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="n">BC</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">[</span><span class="n">BCIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]]</span>

        <span class="c1"># remove zero length vessels from further processing</span>
        <span class="n">NoVessel</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vessels</span> <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vessel</span><span class="o">.</span><span class="n">Vessel</span><span class="p">()</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetID</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vessels</span><span class="p">)]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vessels</span><span class="p">)]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">GenerateVessel</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
                                            <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vessels</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateVesselAtlas</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateNumbers</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">bifurcationnode</span><span class="p">(</span><span class="n">info</span><span class="p">):</span>
            <span class="n">bifurcationnode</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
            <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">nodedata</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">bifurcationinfo</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">element</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">nodedata</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">NoVessel</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">NoIds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">NoVessel</span><span class="p">]</span>
                <span class="n">bifurcationinfo</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bifurcationinfo</span> <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NoIds</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bifurcationinfo</span><span class="p">:</span>
                <span class="n">vessel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span>  <span class="c1"># note that vessel ids start at 1</span>
                <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;o&quot;</span><span class="p">:</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="n">vessel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
                    <span class="n">link</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bifurcationnode</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="n">vessel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
                    <span class="n">link</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bifurcationnode</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>

            <span class="n">radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">Radius</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">Connections</span><span class="p">])</span>
            <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">bifurcationnode</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">bifurcationnode</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">bifurcations</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">bcnodes</span><span class="p">(</span><span class="n">info</span><span class="p">):</span>
            <span class="n">inlets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">outlets</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">inletdata</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">inletinfo</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">element</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">inletdata</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">NoVessel</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">NoIds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">NoVessel</span><span class="p">]</span>
                <span class="n">inletinfo</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">inletinfo</span> <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NoIds</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">inletinfo</span><span class="p">:</span>
                <span class="n">vessel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span>  <span class="c1"># note that vessel ids start at 1</span>
                <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;o&quot;</span><span class="p">:</span>
                    <span class="n">inlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
                    <span class="n">inlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="o">-</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                <span class="n">outletdata</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">outletinfo</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">element</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">outletdata</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">NoVessel</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">NoIds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">NoVessel</span><span class="p">]</span>
                    <span class="n">outletinfo</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">outletinfo</span> <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NoIds</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">outletinfo</span><span class="p">:</span>
                    <span class="n">vessel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span>  <span class="c1"># note that vessel ids start at 1</span>
                    <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;o&quot;</span><span class="p">:</span>
                        <span class="n">outlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
                        <span class="n">outlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="o">-</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">inlets</span><span class="p">,</span> <span class="n">outlets</span>

        <span class="n">inletnodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">=</span> <span class="n">bcnodes</span><span class="p">(</span><span class="n">BC</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">inlet</span><span class="p">,</span> <span class="s2">&quot;Aorta.txt&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">inlet</span> <span class="ow">in</span> <span class="n">inletnodes</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">==</span> <span class="p">[])]</span>

        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberNodes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetThickness</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfNodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfVessels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CheckConnectivity</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateNodeType</span><span class="p">()</span>
        <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">UpdateNodeVesselID</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">CalculateMeanThickness</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">CalculateMeanRadius</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">SetType</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">NumberNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Assigning numbers to the nodes.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">number</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="o">=</span> <span class="n">number</span>
                <span class="n">number</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">GetDownstreamVessels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputvessel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get upstream vessels and bifurcation nodes.</span>
<span class="sd">        Note that this follows the positive directon of the vessels.</span>
<span class="sd">        If vessels are excluded that should be included, check the direction of those vessels.</span>

<span class="sd">        The code finds the relevent bifucations and then checks which vessels are connected.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(&quot;Finding the upstream vessels.&quot;)</span>
        <span class="c1"># initiation</span>
        <span class="n">bifset</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bifurcations</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputvessel</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">vesselindex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span><span class="p">[</span><span class="n">inputvessel</span><span class="p">]</span>
            <span class="n">vessel</span> <span class="o">=</span> <span class="n">vesselindex</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vessel</span> <span class="o">=</span> <span class="n">inputvessel</span>
        <span class="c1"># the current vessel and the starting bifurcation</span>
        <span class="n">vesselend</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vesselend</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
                <span class="n">bifset</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>
                <span class="n">bifurcations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="n">gens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">gens</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">vessel</span><span class="p">])</span>
        <span class="n">alreadylisted</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="p">]</span>
        <span class="c1"># Continue until we have all upstream vessels</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">bifset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">connectedvessels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">bifurcationnode</span> <span class="ow">in</span> <span class="n">bifset</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                    <span class="n">connectedvessels</span> <span class="o">+=</span> <span class="p">[</span><span class="n">vessel</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
            <span class="n">nbifset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">connectedvessels</span><span class="p">:</span>
                <span class="n">ves</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ves</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="ow">and</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bifurcations</span><span class="p">:</span>
                        <span class="n">nbifset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                        <span class="n">bifurcations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">newgen</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">connectedvessels</span> <span class="k">if</span> <span class="n">vessel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">alreadylisted</span><span class="p">]</span>
            <span class="n">gens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newgen</span><span class="p">)</span>
            <span class="n">alreadylisted</span> <span class="o">+=</span> <span class="n">connectedvessels</span>
            <span class="n">bifset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nbifset</span><span class="p">)</span>

        <span class="c1"># only vessels that are connected with the first node should be included.</span>
        <span class="c1"># this ensures that we only get the upstream vessels</span>
        <span class="n">vessels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">vessels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">bifurcations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                <span class="p">[</span><span class="n">vessels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span> <span class="ow">and</span> <span class="n">vessel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">]</span>

        <span class="c1"># export the names of the upstream vessels</span>
        <span class="n">vesselnames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">match</span> <span class="o">==</span> <span class="n">vessel</span><span class="p">:</span>
                    <span class="n">vesselnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>

        <span class="c1"># reorder</span>
        <span class="n">sortedvessels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">vessels</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">sortedvessels</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">bifurcations</span><span class="p">),</span> <span class="n">vesselnames</span><span class="p">,</span> <span class="n">gens</span>

    <span class="k">def</span> <span class="nf">ReorderGens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gens</span><span class="p">):</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">generation</span> <span class="ow">in</span> <span class="n">gens</span><span class="p">:</span>
            <span class="n">lengthgen</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">generation</span><span class="p">:</span>
                <span class="n">v</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="n">ng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetDownstreamVessels</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
                <span class="n">lengthgen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ng</span><span class="p">))</span>
            <span class="n">ordering</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lengthgen</span><span class="p">)</span>

        <span class="n">newgens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">gen</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gens</span><span class="p">):</span>
            <span class="n">newgens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">ordering</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">gen</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">g</span><span class="p">)]))</span>
        <span class="k">return</span> <span class="n">newgens</span>

    <span class="k">def</span> <span class="nf">DownStreamResistance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputvessel</span><span class="p">,</span> <span class="n">visc</span><span class="p">,</span> <span class="n">density</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stdout</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">vessels</span><span class="p">,</span> <span class="n">bifurcations</span><span class="p">,</span> <span class="n">vesselnames</span><span class="p">,</span> <span class="n">gens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetDownstreamVessels</span><span class="p">(</span><span class="n">inputvessel</span><span class="p">)</span>

        <span class="n">C</span> <span class="o">=</span> <span class="n">gens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">C</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">gens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">R1</span> <span class="o">+</span> <span class="n">gens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">R2</span>
        <span class="n">gens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ResetWK</span><span class="p">()</span>

        <span class="n">vesselres</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">VesselResistance</span><span class="p">(</span><span class="n">visc</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">]</span>
        <span class="n">vesselres</span><span class="p">[</span><span class="n">vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">gens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># only get the downstream resistance</span>

        <span class="n">vesselcomp</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">VesselCompliance</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">]</span>
        <span class="n">vesselcomp</span><span class="p">[</span><span class="n">vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">gens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># only get the downstream resistance</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gens</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">gens</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vesselmatch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">vesselmatch</span> <span class="o">==</span> <span class="n">vessel</span><span class="p">:</span>
                        <span class="n">vesselnames</span> <span class="o">=</span> <span class="n">vesselmatch</span><span class="o">.</span><span class="n">Name</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stdout</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                    <span class="n">vesselstemp</span><span class="p">,</span> <span class="n">bifurcationstemp</span><span class="p">,</span> <span class="n">vesselnamestemp</span><span class="p">,</span> <span class="n">genstemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetDownstreamVessels</span><span class="p">(</span><span class="n">vesselnames</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">genstemp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">downstreamres</span> <span class="o">=</span> <span class="p">[</span><span class="n">vesselres</span><span class="p">[</span><span class="n">vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vesselt</span><span class="p">)]</span> <span class="k">for</span> <span class="n">vesselt</span> <span class="ow">in</span> <span class="n">genstemp</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="n">vesselres</span><span class="p">[</span><span class="n">vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vessel</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sumresvessels</span><span class="p">(</span><span class="n">vesselres</span><span class="p">[</span><span class="n">vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vessel</span><span class="p">)],</span>
                                                                          <span class="n">downstreamres</span><span class="p">)</span>
                    <span class="c1"># vesselc = sum([vesselcomp[vessels.index(vesselt)] for vesselt in genstemp[1]])</span>
                    <span class="c1"># if vesselcomp[vessels.index(vessel)] &gt; 0:</span>
                    <span class="c1">#     vesselcomp[vessels.index(vessel)] = 1/(1/vesselc + 1/vesselcomp[vessels.index(vessel)])</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     vesselcomp[vessels.index(vessel)] = vesselc</span>

        <span class="n">outlets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                    <span class="n">outlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">rcubed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="mf">1e-3</span>
        <span class="n">RT</span> <span class="o">=</span> <span class="n">R</span> <span class="o">-</span> <span class="n">vesselres</span><span class="p">[</span><span class="n">vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">gens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span>
        <span class="c1"># Ct = 1/(1/C - 1/vesselcomp[vessels.index(gens[0][0])])</span>
        <span class="k">if</span> <span class="n">RT</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found RT to be negative!?&quot;</span><span class="p">)</span>
            <span class="n">RT</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">R</span>
        <span class="c1"># RT = R</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resistance scaled: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RT</span> <span class="o">/</span> <span class="n">R</span><span class="p">))</span>
        <span class="c1"># print(&quot;Compliance scaled: %f&quot; % (Ct / C))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outlets</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">rcubed</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">C1D</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
            <span class="c1"># mean radius and thickness</span>
            <span class="n">lengthvessel</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Length</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">meanradius</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanRadius</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">meanh</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanThickness</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">C1D</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">meanradius</span> <span class="o">*</span> <span class="n">meanradius</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">lengthvessel</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">vessel</span><span class="o">.</span><span class="n">YoungsModules</span> <span class="o">*</span> <span class="n">meanh</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outlets</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">CalculateThickness</span><span class="p">()</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">rt</span> <span class="o">=</span> <span class="n">RT</span> <span class="o">*</span> <span class="n">rcubed</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="o">.</span><span class="n">YoungsModules</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="n">A</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">density</span><span class="p">)))</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="p">(</span><span class="n">density</span> <span class="o">/</span> <span class="n">A</span><span class="p">)</span> <span class="o">*</span> <span class="n">c0</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">rt</span> <span class="o">-</span> <span class="n">r1</span>
            <span class="k">if</span> <span class="n">r2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">r2</span> <span class="o">=</span> <span class="mf">0.1e9</span>
                <span class="n">r1</span> <span class="o">=</span> <span class="n">rt</span> <span class="o">-</span> <span class="n">r2</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">C</span> <span class="o">-</span> <span class="n">C1D</span><span class="p">)</span> <span class="o">*</span> <span class="n">RT</span> <span class="o">/</span> <span class="n">rt</span><span class="p">)</span>
            <span class="n">i</span><span class="o">.</span><span class="n">SetWK</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

    <span class="c1"># def UpstreamResistancesyms(self, inputvessel, visc, density):</span>
    <span class="c1">#     rt = sympy.symbols(&quot;rt&quot;)</span>
    <span class="c1">#     vessels,  bifurcations, vesselnames, gens = self.GetUpstreamVessels(inputvessel)</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1">#     C = gens[0][0][-1].C</span>
    <span class="c1">#     R = gens[0][0][-1].R1 + gens[0][0][-1].R2</span>
    <span class="c1">#     gens[0][0][-1].ResetWK()</span>
    <span class="c1">#</span>
    <span class="c1">#     vesselres = [VesselResistance(vessel, visc) for vessel in vessels]</span>
    <span class="c1">#     # vesselres[vessels.index(gens[0][0])] = 0 #assumption that the major vessels do not have meaningful resistance.</span>
    <span class="c1">#</span>
    <span class="c1">#     # add resistance of the outlets</span>
    <span class="c1">#     outlets = []</span>
    <span class="c1">#     for vessel in vessels:</span>
    <span class="c1">#         for out in self.OutletNodes:</span>
    <span class="c1">#             if out in vessel:</span>
    <span class="c1">#                 outlets.append(out)</span>
    <span class="c1">#     rcubed = 0</span>
    <span class="c1">#     scaling = 1e-3</span>
    <span class="c1">#     for i in outlets:</span>
    <span class="c1">#         radius = i.Radius * scaling</span>
    <span class="c1">#         rcubed += math.pow(radius, 3)</span>
    <span class="c1">#</span>
    <span class="c1">#     for vessel in vessels:</span>
    <span class="c1">#         for out in self.OutletNodes:</span>
    <span class="c1">#             if out in vessel:</span>
    <span class="c1">#                 vesselres[vessels.index(vessel)] += rt*rcubed / math.pow(out.Radius*scaling, 3)</span>
    <span class="c1">#</span>
    <span class="c1">#     for i in range(len(gens)-1,-1,-1):</span>
    <span class="c1">#         for vessel in gens[i]:</span>
    <span class="c1">#             for index, vesselmatch in enumerate(self.Vessels):</span>
    <span class="c1">#                 if vesselmatch == vessel:</span>
    <span class="c1">#                     vesselnames = self.VesselAtlas[index]</span>
    <span class="c1">#             with contextlib.redirect_stdout(None):</span>
    <span class="c1">#                 vesselstemp, bifurcationstemp, vesselnamestemp, genstemp = self.GetUpstreamVessels(vesselnames)</span>
    <span class="c1">#             if len(genstemp)&gt;1:</span>
    <span class="c1">#                 downstreamres = [vesselres[vessels.index(vesselt)] for vesselt in genstemp[1]]</span>
    <span class="c1">#                 vesselres[vessels.index(vessel)] = self.sumresvessels(vesselres[vessels.index(vessel)],downstreamres)</span>
    <span class="c1">#</span>
    <span class="c1">#     expression =sympy.lambdify(rt, R - vesselres[vessels.index(gens[0][0])],&#39;numpy&#39;)</span>
    <span class="c1">#     RT = float(fsolve(expression,expression(0)))</span>
    <span class="c1">#     # print((RT)/R)</span>
    <span class="c1">#</span>
    <span class="c1">#     C1D = 0</span>
    <span class="c1">#     for vessel in vessels:</span>
    <span class="c1">#         # mean radius and thickness</span>
    <span class="c1">#         lengthvessel = max([vessel[0].Position, vessel[-1].Position]) * scaling</span>
    <span class="c1">#         meanradius = numpy.trapz([i.Radius * scaling for i in vessel],</span>
    <span class="c1">#                                  [i.Position * scaling for i in vessel]) / lengthvessel</span>
    <span class="c1">#         meanh = numpy.trapz([thickness(i.Radius * scaling) for i in vessel],</span>
    <span class="c1">#                                  [i.Position * scaling for i in vessel]) / lengthvessel</span>
    <span class="c1">#         C1D += 2 * numpy.power(numpy.pi * meanradius * meanradius, 1.5) * lengthvessel / (</span>
    <span class="c1">#                 (4 / 3) * numpy.sqrt(numpy.pi) * vessel[0].E * meanh)</span>
    <span class="c1">#</span>
    <span class="c1">#     for i in outlets:</span>
    <span class="c1">#         radius = i.Radius * scaling</span>
    <span class="c1">#         h = thickness(radius)</span>
    <span class="c1">#         rt = RT * rcubed / math.pow(radius, 3)</span>
    <span class="c1">#         A = math.pi * math.pow(radius, 2)</span>
    <span class="c1">#         beta = (4 / 3) * math.sqrt(math.pi) * i.E * h / A</span>
    <span class="c1">#         c0 = abs(math.sqrt(beta / (2 * density))) * math.pow(A, 0.25)</span>
    <span class="c1">#         r1 = (density / A) * c0</span>
    <span class="c1">#         r2 = rt - r1</span>
    <span class="c1">#         if r2 &lt; 0:</span>
    <span class="c1">#             r2 = 0.1e9</span>
    <span class="c1">#             r1 = rt - r2</span>
    <span class="c1">#         c = (C-C1D) * RT / rt</span>
    <span class="c1">#         i.set_WK(r1, r2, c)</span>

    <span class="k">def</span> <span class="nf">sumresvessels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upstream</span><span class="p">,</span> <span class="n">downstream</span><span class="p">):</span>
        <span class="n">parallelvesselsres</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="o">/</span> <span class="n">vesselres</span> <span class="k">for</span> <span class="n">vesselres</span> <span class="ow">in</span> <span class="n">downstream</span><span class="p">])</span>
        <span class="n">serialvesselres</span> <span class="o">=</span> <span class="n">upstream</span>
        <span class="n">totalres</span> <span class="o">=</span> <span class="n">parallelvesselsres</span> <span class="o">+</span> <span class="n">serialvesselres</span>
        <span class="k">return</span> <span class="n">totalres</span>

    <span class="k">def</span> <span class="nf">RedefineDirection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Redefining the direction of the vessels.&quot;</span><span class="p">)</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">inlet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">direction</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">vessel</span><span class="o">.</span><span class="n">GenerationNumber</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="n">inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vessel reversed.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">nodenumber</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">nodenumber</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span> <span class="o">-</span> <span class="n">nodenumber</span><span class="p">:</span>
                            <span class="c1"># self.Vessels[index].Nodes[nodenumber].Position, self.Vessels[index].Nodes[</span>
                            <span class="c1">#     -1 - nodenumber].Position = \</span>
                            <span class="c1">#     self.Vessels[index].Nodes[-1 - nodenumber].Position, self.Vessels[index].Nodes[</span>
                            <span class="c1">#         nodenumber].Position</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span>
                                <span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">=</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span>
                                    <span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span>
                    <span class="n">direction</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">inletvessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">inlet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">inletvessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span>

        <span class="n">bifs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">inves</span> <span class="ow">in</span> <span class="n">inletvessels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">inves</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
                    <span class="n">bifs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bif</span><span class="p">)</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">bifs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">newbifs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">bifs</span><span class="p">:</span>
                <span class="n">vessels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">if</span>
                           <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span> <span class="ow">or</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">]</span>
                <span class="n">vesselundef</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span> <span class="k">if</span> <span class="n">direction</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vesselundef</span><span class="p">:</span>
                    <span class="c1"># print(self.VesselAtlas[vessel])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                        <span class="n">direction</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vessel reversed.&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                        <span class="k">for</span> <span class="n">nodenumber</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">nodenumber</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span> <span class="o">-</span> <span class="n">nodenumber</span><span class="p">:</span>
                                <span class="c1"># self.Vessels[vessel].Nodes[nodenumber].Position, self.Vessels[vessel].Nodes[</span>
                                <span class="c1">#     -1 - nodenumber].Position = \</span>
                                <span class="c1">#     self.Vessels[vessel].Nodes[-1 - nodenumber].Position, self.Vessels[vessel].Nodes[</span>
                                <span class="c1">#         nodenumber].Position</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span>
                                    <span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">=</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">,</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span>
                                        <span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span>
                        <span class="n">direction</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

                    <span class="n">newcandidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">bift</span> <span class="k">for</span> <span class="n">bift</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Connections</span> <span class="k">if</span>
                                     <span class="n">bift</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">newcandidates</span><span class="p">:</span>
                        <span class="n">newbifs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">newcandidates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">bifs</span> <span class="o">=</span> <span class="n">newbifs</span>

    <span class="k">def</span> <span class="nf">GetVesselsFromType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputtype</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting all vessels of a type.&quot;</span><span class="p">)</span>
        <span class="c1"># return all vessels that are labelled with the input type</span>
        <span class="n">vessels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">inputtype</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">vessels</span>

    <span class="k">def</span> <span class="nf">ReadNodesFromTopFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load nodes from topology file.&quot;</span><span class="p">)</span>
        <span class="n">bfdata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>
        <span class="n">bonds_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;Bonds:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">bonds_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>

        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetNodeFromTopLine</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bfdata</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">bonds_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])]</span>

        <span class="n">links</span> <span class="o">=</span> <span class="n">bfdata</span><span class="p">[</span><span class="n">bonds_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">bfdata</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="n">i</span><span class="p">])])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
             <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">link</span><span class="p">))]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">Read3DNodesFromTopFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load nodes from topology file.&quot;</span><span class="p">)</span>
        <span class="n">bfdata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>
        <span class="n">bonds_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;Bonds:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">bonds_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bfdata</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">bonds_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetNumber</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">([</span><span class="mf">1e3</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">:]),</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">:]),</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">:])])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">2</span><span class="p">:]))</span>

        <span class="n">links</span> <span class="o">=</span> <span class="n">bfdata</span><span class="p">[</span><span class="n">bonds_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">bfdata</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="n">i</span><span class="p">])])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
             <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">link</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">LoadVesselAtlas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading vessel atlas from file.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">file</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">vesselatlas</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">vessel</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">]</span>
                <span class="n">vesselatlas</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vessel</span><span class="p">]</span>
                <span class="n">vesselnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vessel</span><span class="p">]</span>
                <span class="p">[</span><span class="n">vesselatlas</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vesselnames</span><span class="p">)]</span>

        <span class="c1"># vesselatlas = [i.strip(&#39;\n&#39;).split(&#39;\t&#39;) for i in open(file)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vessel</span><span class="o">.</span><span class="n">Vessel</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vesselatlas</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vesselatlas</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetID</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">nodenumbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nodenumbers</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetLength</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">,</span> <span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetGridSize</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">-</span> <span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetNodes</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">UpdateVessel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">CalculateMeanRadius</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">CalculateMeanThickness</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateVesselAtlas</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">SetInletNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inlets</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting inlet nodes.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span> <span class="o">=</span> <span class="n">inlets</span>

    <span class="k">def</span> <span class="nf">SetOutletNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outlets</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting outlet nodes.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">=</span> <span class="n">outlets</span>

    <span class="k">def</span> <span class="nf">SetBifurcationNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bifurcationnodes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting bifurcation nodes.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bifurcationnodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FindBifurcationNodes</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="n">bifurcationnodes</span>

    <span class="k">def</span> <span class="nf">FindBifurcationNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding the bifurcation nodes.&quot;</span><span class="p">)</span>
        <span class="n">bifurcationnodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">bifurcationnodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="n">bifurcationnodes</span>

    <span class="k">def</span> <span class="nf">FindOutletNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding the outlet nodes.&quot;</span><span class="p">)</span>
        <span class="n">InletNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">]</span>
        <span class="n">OutletsNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">InletNodes</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetOutletNodes</span><span class="p">(</span><span class="n">OutletsNodes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">FindlargestInlets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">InletNumber</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding the largest </span><span class="si">%d</span><span class="s2"> inlets.&quot;</span> <span class="o">%</span> <span class="n">InletNumber</span><span class="p">)</span>
        <span class="c1"># InletNodes = [i.strip(&#39;\n&#39;).split(&#39;,&#39;) for i in open(inletfilename)]</span>
        <span class="n">Ends</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">InletNodes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Ends</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">Ends</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">inletnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;left_carotid_inlet.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;right_carotid_inlet.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;basilar.txt&quot;</span><span class="p">]</span>
        <span class="n">Inlets</span> <span class="o">=</span> <span class="p">[(</span><span class="n">Ends</span><span class="p">[</span><span class="n">line</span><span class="p">],</span> <span class="n">inletnames</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">InletNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">InletNumber</span><span class="p">]]</span>  <span class="c1"># Dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetInletNodes</span><span class="p">(</span><span class="n">Inlets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FindOutletNodes</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">ApplyTransformation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">Position</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>
            <span class="n">posnew</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">posnew</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">AnatomyToVessels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get vessels from topology data</span>
<span class="sd">        start at an end point</span>
<span class="sd">        get the neighbour, if connection of neighbour is 2 then get next neighbour and repeat.</span>
<span class="sd">        If connection is 1, stop. If connection is more than 2, stop and start new vessel.</span>
<span class="sd">        repeat for every end point, keep track of nodes that are already assigned to a vesse (except bif nodes)</span>
<span class="sd">        bifurcation nodes are nodes with more than 2 connections</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting vessels from topology data.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FindBifurcationNodes</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FindOutletNodes</span><span class="p">()</span>

        <span class="n">ProcessedNodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Note: gives an error is there are no vessel nodes</span>
        <span class="k">for</span> <span class="n">BifurcationNode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="c1"># check connected vessels</span>
            <span class="n">newvessels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">BifurcationNode</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">ProcessedNodes</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">newvessels</span><span class="p">:</span>
                <span class="n">vessel</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BifurcationNode</span><span class="p">)</span>
                <span class="n">ProcessedNodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BifurcationNode</span><span class="p">)</span>
                <span class="n">currentnode</span> <span class="o">=</span> <span class="n">node</span>
                <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">numberconnection</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">currentnode</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">numberconnection</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">vessel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentnode</span><span class="p">)</span>
                        <span class="n">ProcessedNodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentnode</span><span class="p">)</span>
                        <span class="n">currentnode</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">currentnode</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">vessel</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">numberconnection</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">vessel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentnode</span><span class="p">)</span>
                        <span class="n">ProcessedNodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentnode</span><span class="p">)</span>
                        <span class="n">vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vessel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentnode</span><span class="p">)</span>
                        <span class="n">ProcessedNodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentnode</span><span class="p">)</span>
                        <span class="n">vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
                        <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vessel</span><span class="o">.</span><span class="n">Vessel</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vessels</span><span class="p">))]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetNodes</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">elements</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vessels</span><span class="p">)]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span>
         <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateNodeType</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">removebifurcation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span>
            <span class="n">linked</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                        <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">node</span><span class="p">)]</span> <span class="o">=</span> <span class="n">bif</span>
                <span class="n">othernodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span>
                <span class="p">[</span><span class="n">linked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">othernodes</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">n</span> <span class="ow">is</span> <span class="n">bif</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">lastmostvesselend</span> <span class="ow">in</span> <span class="n">othernodes</span><span class="p">:</span>
                    <span class="n">lastmostvesselend</span><span class="o">.</span><span class="n">RemoveConnection</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">linked</span><span class="p">:</span>
                <span class="n">bif</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
                <span class="n">link</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bif</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">TopologyToVTP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the network to a .vtp file.</span>
<span class="sd">        This only works with 3-D coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NumberNodes</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing topology to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPoints</span><span class="p">()</span>
        <span class="n">vessels</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellArray</span><span class="p">()</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>

        <span class="n">radius</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">radius</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Radius&quot;</span><span class="p">)</span>

        <span class="n">nodetype</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkIntArray</span><span class="p">()</span>
        <span class="n">nodetype</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Node Type &quot;</span><span class="p">)</span>

        <span class="c1"># Add radius and position to data array</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
            <span class="n">radius</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Radius</span><span class="p">))</span>
            <span class="n">nodetype</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>

        <span class="c1"># Add vessels to cell array</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkLine</span><span class="p">()</span>
            <span class="n">line</span><span class="o">.</span><span class="n">GetPointIds</span><span class="p">()</span><span class="o">.</span><span class="n">SetNumberOfIds</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)):</span>
                <span class="n">line</span><span class="o">.</span><span class="n">GetPointIds</span><span class="p">()</span><span class="o">.</span><span class="n">SetId</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
            <span class="n">vessels</span><span class="o">.</span><span class="n">InsertNextCell</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># Create a polydata to store everything in</span>
        <span class="n">VesselsPolyData</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">()</span>

        <span class="c1"># Add the nodes to the polydata</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">SetPoints</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

        <span class="c1"># Add the vessels to the polydata</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">SetLines</span><span class="p">(</span><span class="n">vessels</span><span class="p">)</span>

        <span class="c1"># Assign radii to the nodes</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">SetScalars</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">nodetype</span><span class="p">)</span>

        <span class="n">atlas</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkIntArray</span><span class="p">()</span>
        <span class="p">[</span><span class="n">atlas</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)]</span>
        <span class="n">atlas</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Vessel Ids&quot;</span><span class="p">)</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">atlas</span><span class="p">)</span>

        <span class="n">majoratlas</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkIntArray</span><span class="p">()</span>
        <span class="p">[</span><span class="n">majoratlas</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)]</span>
        <span class="n">majoratlas</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Major Vessel Ids&quot;</span><span class="p">)</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">majoratlas</span><span class="p">)</span>

        <span class="c1"># Save everyting in a vtp file</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">VesselsPolyData</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">GetMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Vessel</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Vessel&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Vesselname&#39;</span><span class="p">,</span> <span class="s1">&#39;Numberofnodes&#39;</span><span class="p">,</span> <span class="s1">&#39;Startnode&#39;</span><span class="p">,</span> <span class="s1">&#39;Endnode&#39;</span><span class="p">])</span>
        <span class="n">vessellist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vessellist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Vessel</span><span class="p">(</span><span class="n">Vesselname</span><span class="o">=</span><span class="s1">&#39;System&#39;</span><span class="p">,</span>
                                     <span class="n">Numberofnodes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">),</span>
                                     <span class="n">Startnode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                     <span class="n">Endnode</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span><span class="p">):</span>
                <span class="n">vessellist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Vessel</span><span class="p">(</span><span class="n">Vesselname</span><span class="o">=</span><span class="n">vessel</span><span class="p">,</span>
                                         <span class="n">Numberofnodes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]),</span>
                                         <span class="n">Startnode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span>
                                         <span class="n">Endnode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">vessellist</span>

    <span class="k">def</span> <span class="nf">CalculateMaximumTimestep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">density</span><span class="p">):</span>
        <span class="n">wavespeed</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vessel</span><span class="o">.</span><span class="n">CalculateMaxWaveSpeed</span><span class="p">(</span><span class="n">density</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="n">gridsize</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">GridSize</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="n">CourantNumber</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">timestep</span> <span class="o">=</span> <span class="p">[</span><span class="n">CourantNumber</span> <span class="o">*</span> <span class="n">gridsize</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">speed</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">speed</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wavespeed</span><span class="p">)]</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">timestep</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Maximum timestep: </span><span class="si">%1.1e</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="n">dt</span><span class="p">)</span>
        <span class="c1"># newgridsize = [1e3 * speed * dt / CourantNumber for speed in wavespeed]  # minimum gridsize, there is no max</span>
        <span class="c1"># max gridsize is set by the vessel length and by the need for detail</span>
        <span class="k">return</span> <span class="n">dt</span>

    <span class="k">def</span> <span class="nf">GetAdjacencyMatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the adjacency matrix of the network</span>

<span class="sd">        :return: scipy sparse matrix, nodes in order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># for each vessel, get the bifurcations at the ends</span>
        <span class="c1"># then check at what parts of other vessels these bifurcations connect.</span>
        <span class="c1"># matrix = numpy.zeros((len(self.Vessels),len(self.Vessels)))</span>
        <span class="c1">#</span>
        <span class="c1"># for index, vessel in enumerate(self.Vessels):</span>
        <span class="c1">#     bif = vessel.GetDistalBifurcation()</span>
        <span class="c1">#     if not (bif is None):</span>
        <span class="c1">#         vesselsnumbers = bif.GetConnectedVesselIDs()</span>
        <span class="c1">#         vesselsnumbers.remove(vessel.ID)</span>
        <span class="c1">#         for number in vesselsnumbers:</span>
        <span class="c1">#             matrix[vessel.ID][number] = 1</span>
        <span class="c1">#</span>
        <span class="c1">#     bif = vessel.GetProximalBifurcation()</span>
        <span class="c1">#     if not (bif is None):</span>
        <span class="c1">#         vesselsnumbers = bif.GetConnectedVesselIDs()</span>
        <span class="c1">#         vesselsnumbers.remove(vessel.ID)</span>
        <span class="c1">#         for number in vesselsnumbers:</span>
        <span class="c1">#             matrix[vessel.ID][number] = -1</span>

        <span class="n">network</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="n">inlets</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">]</span>
        <span class="n">bifs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span>
        <span class="n">outlets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span>  <span class="c1"># vessel ends</span>
        <span class="n">newoutletnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">]</span>
        <span class="n">allnodes</span> <span class="o">=</span> <span class="n">inlets</span> <span class="o">+</span> <span class="n">bifs</span> <span class="o">+</span> <span class="n">outlets</span> <span class="o">+</span> <span class="n">newoutletnodes</span>

        <span class="n">network</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">allnodes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">GetVesselResistance</span><span class="p">(</span><span class="n">bloodvisc</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[[</span><span class="n">vessel</span><span class="o">.</span><span class="n">GetEndNodes</span><span class="p">(),</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Resistance</span><span class="p">]</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>

        <span class="n">outletedges</span> <span class="o">=</span> <span class="p">[[[</span><span class="n">node</span><span class="p">,</span> <span class="n">newoutletnodes</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">R1</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">R2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outlets</span><span class="p">)]</span>
        <span class="n">edges</span> <span class="o">+=</span> <span class="n">outletedges</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">network</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">length</span><span class="o">=</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">nodes</span><span class="p">()):</span>
            <span class="n">labels</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>

        <span class="c1"># import matplotlib.pylab as plt</span>
        <span class="c1"># pos = nx.spring_layout(network, weight=&#39;length&#39;)</span>
        <span class="c1"># nx.draw_networkx_nodes(network, pos)</span>
        <span class="c1"># nx.draw_networkx_edges(network, pos)</span>
        <span class="c1"># nx.draw_networkx_labels(network, pos, labels, font_size=16)</span>
        <span class="c1"># plt.show()</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">allnodes</span>

    <span class="k">def</span> <span class="nf">GetAdjacencyMatrix2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the adjacency matrix of the network</span>

<span class="sd">        :return: scipy sparse matrix, nodes in order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">network</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="n">inlets</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">]</span>
        <span class="n">bifs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span>
        <span class="n">outlets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span>  <span class="c1"># vessel ends</span>

        <span class="n">allnodes</span> <span class="o">=</span> <span class="n">inlets</span> <span class="o">+</span> <span class="n">bifs</span> <span class="o">+</span> <span class="n">outlets</span>

        <span class="n">network</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">allnodes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">GetVesselResistance</span><span class="p">(</span><span class="n">bloodvisc</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[[</span><span class="n">vessel</span><span class="o">.</span><span class="n">GetEndNodes</span><span class="p">(),</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Resistance</span><span class="p">]</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">network</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">length</span><span class="o">=</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">nodes</span><span class="p">()):</span>
            <span class="n">labels</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>

        <span class="c1"># import matplotlib.pylab as plt</span>
        <span class="c1"># pos = nx.spring_layout(network, weight=&#39;length&#39;)</span>
        <span class="c1"># nx.draw_networkx_nodes(network, pos)</span>
        <span class="c1"># nx.draw_networkx_edges(network, pos)</span>
        <span class="c1"># nx.draw_networkx_labels(network, pos, labels, font_size=16)</span>
        <span class="c1"># plt.show()</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">allnodes</span>

    <span class="k">def</span> <span class="nf">GetVesselResistance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">):</span>
        <span class="n">resistance</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">VesselResistance</span><span class="p">(</span><span class="n">bloodvisc</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">resistance</span>

    <span class="k">def</span> <span class="nf">SegmentConductance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="o">=</span><span class="mi">22</span><span class="p">):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">node1</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">-</span> <span class="n">node2</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">GeneralFunctions</span><span class="o">.</span><span class="n">distancebetweenpoints</span><span class="p">(</span><span class="n">node1</span><span class="o">.</span><span class="n">Position</span><span class="p">,</span> <span class="n">node2</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>

        <span class="c1"># a = node1.Radius</span>
        <span class="c1"># b = (node2.Radius - node1.Radius) / length</span>
        <span class="c1"># radiusint = scipy.integrate.quad(lambda l: 1 / scipy.power(a + b * l, 4), 0, length)</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="p">(</span><span class="n">node1</span><span class="o">.</span><span class="n">Radius</span> <span class="o">+</span> <span class="n">node2</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">frictionconstant</span><span class="p">):</span>
            <span class="n">friction</span> <span class="o">=</span> <span class="n">frictionconstant</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
            <span class="k">return</span> <span class="mf">1e-9</span> <span class="o">*</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">friction</span> <span class="o">*</span> <span class="n">bloodvisc</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1e-9</span> <span class="o">*</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">frictionconstant</span> <span class="o">*</span> <span class="n">bloodvisc</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span>

        <span class="c1"># G = 1e-9 * (numpy.pi * numpy.power(radius, 4)) / (fictionconstant * bloodvisc * length)</span>
        <span class="c1"># # G = 1e-9 * (numpy.pi * numpy.power(radius, 4)) / (8 * bloodvisc * length)</span>
        <span class="c1"># return G</span>

    <span class="k">def</span> <span class="nf">TopologyToGraph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">network</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)):</span>
                <span class="n">network</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                 <span class="n">weight</span><span class="o">=</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">-</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                <span class="n">network</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">bif</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Graph</span> <span class="o">=</span> <span class="n">network</span>

        <span class="c1"># pos = nx.spring_layout(network)</span>
        <span class="c1"># nx.draw(network, pos)</span>
        <span class="c1"># plt.show()</span>

    <span class="k">def</span> <span class="nf">Get1DsteadyNetwork</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">,</span> <span class="n">clotactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">PressureInlets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">coarseCollaterals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">FlowRateOutlets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="o">=</span><span class="mi">22</span><span class="p">):</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># bloodvisc = patient.ModelParameters[&quot;BLOOD_VISC&quot;]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)):</span>
                <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                              <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">SegmentConductance</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bloodvisc</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="o">=</span><span class="n">frictionconstant</span><span class="p">)])</span>

        <span class="c1"># generate more nodes for the wk elements</span>
        <span class="n">newoutlets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># newcounter = self.NumberOfNodes</span>
        <span class="k">for</span> <span class="n">outlet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">outlet</span><span class="o">.</span><span class="n">R1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">g</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">outlet</span><span class="o">.</span><span class="n">R1</span> <span class="o">+</span> <span class="n">outlet</span><span class="o">.</span><span class="n">R2</span><span class="p">)</span>
                <span class="n">wknode</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                <span class="n">wknode</span><span class="o">.</span><span class="n">OutPressure</span> <span class="o">=</span> <span class="n">outlet</span><span class="o">.</span><span class="n">OutPressure</span>
                <span class="n">wknode</span><span class="o">.</span><span class="n">OutletFlowRate</span> <span class="o">=</span> <span class="n">outlet</span><span class="o">.</span><span class="n">OutletFlowRate</span>
                <span class="c1"># wknode.InputPressure = wknode.OutPressure</span>
                <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">outlet</span><span class="p">,</span> <span class="n">wknode</span><span class="p">,</span> <span class="n">g</span><span class="p">])</span>
                <span class="c1"># outlet.AddConnection(wknode)</span>
                <span class="n">wknode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">outlet</span><span class="p">)</span>
                <span class="n">newoutlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wknode</span><span class="p">)</span>

                <span class="n">outlet</span><span class="o">.</span><span class="n">WKNode</span> <span class="o">=</span> <span class="n">wknode</span>  <span class="c1"># for collaterals</span>
                <span class="n">wknode</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">outlet</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>  <span class="c1"># for collaterals</span>
                <span class="n">wknode</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">outlet</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
                <span class="c1"># newcounter += 1</span>
                <span class="c1"># wknode.SetNumber(newcounter)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newoutlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outlet</span><span class="p">)</span>
        <span class="n">OutletNodes</span> <span class="o">=</span> <span class="n">newoutlets</span>

        <span class="c1"># collaterals</span>
        <span class="n">collateralEdges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># coarseCollaterals = False</span>
        <span class="k">if</span> <span class="n">coarseCollaterals</span><span class="p">:</span>  <span class="c1"># collateral model</span>
            <span class="c1"># add conductance between wknodes of outlets according to collaterals</span>
            <span class="c1"># connections between MCA and PCA/ACA for now</span>
            <span class="c1"># scaling = 1e-12 # guess value? resistance per mm?</span>
            <span class="c1"># n = 0.01  # number</span>
            <span class="c1"># effectiveradius = 0.2  # mm</span>
            <span class="c1"># 1e-9 * (numpy.pi * numpy.power(radius, 4)) / (friction * bloodvisc * length)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_collaterals_number</span>
            <span class="n">effectiveradius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_collaterals_effective_radius</span>
            <span class="n">distance_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_collaterals_threshold</span>

            <span class="c1"># basically 1mm? (assume properties are uniform, like a thin sheet)</span>
            <span class="n">scaling</span> <span class="o">=</span> <span class="mf">1e-9</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">effectiveradius</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">frictionconstant</span> <span class="o">*</span> <span class="n">bloodvisc</span><span class="p">)</span>
            <span class="c1"># print(f&quot;\tScaling factor: {scaling}&quot;)</span>

            <span class="c1"># based on previous found connections</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">othernode</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">connected_cp</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="o">&lt;</span> <span class="n">othernode</span><span class="o">.</span><span class="n">Number</span><span class="p">:</span>  <span class="c1"># prevent duplicates</span>
                        <span class="n">collateral_conductance</span> <span class="o">=</span> <span class="n">scaling</span>
                        <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">WKNode</span><span class="p">,</span> <span class="n">othernode</span><span class="o">.</span><span class="n">WKNode</span><span class="p">,</span> <span class="n">collateral_conductance</span><span class="p">])</span>
                        <span class="n">collateralEdges</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">WKNode</span><span class="p">,</span> <span class="n">othernode</span><span class="o">.</span><span class="n">WKNode</span><span class="p">,</span> <span class="n">collateral_conductance</span><span class="p">])</span>

            <span class="c1"># Identify outlets within distance x</span>
            <span class="c1"># for node in self.OutletNodes:</span>
            <span class="c1">#     if node.MajorVesselID == 2 or node.MajorVesselID == 3 or node.MajorVesselID == 6:  # R SIDE</span>
            <span class="c1">#         othernodes = [othernode for othernode in self.OutletNodes if</span>
            <span class="c1">#                       othernode.MajorVesselID == 2 or othernode.MajorVesselID == 3 or othernode.MajorVesselID == 6]</span>
            <span class="c1">#     elif node.MajorVesselID == 4 or node.MajorVesselID == 5 or node.MajorVesselID == 7:  # L SIDE</span>
            <span class="c1">#         othernodes = [othernode for othernode in self.OutletNodes if</span>
            <span class="c1">#                       othernode.MajorVesselID == 4 or othernode.MajorVesselID == 5 or othernode.MajorVesselID == 7]</span>
            <span class="c1">#     else:</span>
            <span class="c1">#         othernodes = []</span>
            <span class="c1">#     for othernode in othernodes:</span>
            <span class="c1">#</span>
            <span class="c1">#         if self.coarse_collaterals_After_WKNodes:</span>
            <span class="c1">#             if node.Number &lt; othernode.Number:  # prevent duplicates</span>
            <span class="c1">#                 distance = GeneralFunctions.distancebetweenpoints(node.WKNode.Position, othernode.WKNode.Position)</span>
            <span class="c1">#                 # collateral_conductance = scaling/distance</span>
            <span class="c1">#                 if distance &lt; distance_threshold:</span>
            <span class="c1">#                     collateral_conductance = scaling</span>
            <span class="c1">#                     edges.append([node.WKNode, othernode.WKNode, collateral_conductance])</span>
            <span class="c1">#                     collateralEdges.append([node.WKNode, othernode.WKNode, collateral_conductance])</span>
            <span class="c1">#         else:</span>
            <span class="c1">#             if node.Number &lt; othernode.Number:  # prevent duplicates</span>
            <span class="c1">#                 distance = GeneralFunctions.distancebetweenpoints(node.Position, othernode.Position)</span>
            <span class="c1">#                 # collateral_conductance = scaling/distance</span>
            <span class="c1">#                 if distance &lt; distance_threshold:</span>
            <span class="c1">#                     collateral_conductance = scaling</span>
            <span class="c1">#                     edges.append([node, othernode, collateral_conductance])</span>
            <span class="c1">#                     collateralEdges.append([node, othernode, collateral_conductance])</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Collateral vessels: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">collateralEdges</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Collaterals</span> <span class="o">=</span> <span class="n">collateralEdges</span>

        <span class="c1"># modelling clots</span>
        <span class="c1"># we can simply update the edges</span>
        <span class="c1"># set global parameter ClotActive to true</span>
        <span class="c1"># set conductance to zero.</span>
        <span class="c1"># find edge in list of edges, set conductance to zero</span>
        <span class="k">if</span> <span class="n">clotactive</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">clot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Clots</span><span class="p">:</span>
                <span class="n">clotnodes</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># for _ in enumerate(clotnodes[:-1]):</span>
                <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">clotnodes</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">clotnodes</span><span class="p">):</span>
                        <span class="n">node1</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">node2</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                        <span class="n">length</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">node1</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">-</span> <span class="n">node2</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">length</span> <span class="o">=</span> <span class="n">GeneralFunctions</span><span class="o">.</span><span class="n">distancebetweenpoints</span><span class="p">(</span><span class="n">node1</span><span class="o">.</span><span class="n">Position</span><span class="p">,</span> <span class="n">node2</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>

                        <span class="n">permeability</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="c1"># porocity = clot[2]</span>

                        <span class="c1"># permeable, darcy&#39;s law, units m^2 (range (1.0  1e-17) to (1.0  1e-7)?</span>
                        <span class="c1"># input units are mm^2 -&gt; multiply with 1e-6</span>
                        <span class="n">area</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">node1</span><span class="o">.</span><span class="n">RefRadius</span> <span class="o">+</span> <span class="n">node2</span><span class="o">.</span><span class="n">RefRadius</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>
                        <span class="n">G</span> <span class="o">=</span> <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">permeability</span> <span class="o">*</span> <span class="n">area</span><span class="o">/</span><span class="p">(</span><span class="n">bloodvisc</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span>
                        <span class="c1"># todo should we account for segment resistance as well?</span>
                        <span class="n">node1</span><span class="o">.</span><span class="n">Radius</span> <span class="o">=</span> <span class="n">node1</span><span class="o">.</span><span class="n">RefRadius</span>
                        <span class="n">node2</span><span class="o">.</span><span class="n">Radius</span> <span class="o">=</span> <span class="n">node2</span><span class="o">.</span><span class="n">RefRadius</span>
                        <span class="n">segmentConduction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SegmentConductance</span><span class="p">(</span><span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="o">=</span><span class="n">frictionconstant</span><span class="p">)</span>
                        <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">G</span> <span class="o">+</span> <span class="mf">1e-32</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">segmentConduction</span><span class="p">)</span>


                        <span class="c1"># if porocity == 0 and permeability == 0:</span>
                        <span class="c1">#     edge[2] = 1e-32  # zero</span>
                        <span class="c1"># elif permeability == 0:</span>
                        <span class="c1">#     # void fraction, stenosis</span>
                        <span class="c1">#     radius = numpy.sqrt(porocity) * (node1.RefRadius + node2.RefRadius) / 2</span>
                        <span class="c1">#     G = 1e-9 * (numpy.pi * numpy.power(radius, 4)) / (frictionconstant * bloodvisc * length)</span>
                        <span class="c1">#     edge[2] = G + 1e-32</span>
                        <span class="c1">#     node1.Radius = node1.RefRadius*numpy.sqrt(porocity)</span>
                        <span class="c1">#     node2.Radius = node2.RefRadius*numpy.sqrt(porocity)</span>
                        <span class="c1">#</span>
                        <span class="c1"># elif porocity == 0:</span>
                        <span class="c1">#     # permeable, darcy&#39;s law, units m^2 (range (1.0  1e-17) to (1.0  1e-7)?</span>
                        <span class="c1">#     # input units are mm^2 -&gt; multiply with 1e-6</span>
                        <span class="c1">#     area = numpy.power((node1.RefRadius + node2.RefRadius) / 2, 2) * numpy.pi</span>
                        <span class="c1">#     G = 1e-9 * permeability * area/(bloodvisc * length)</span>
                        <span class="c1">#     edge[2] = G + 1e-32</span>
                        <span class="c1"># else:</span>
                        <span class="c1">#     print(&quot;Error in clot.&quot;)</span>

                        <span class="c1"># scale radius (porocity = void fraction = stenosis?)</span>
                        <span class="c1"># radius = clot[1] * (node1.RefRadius + node2.RefRadius) / 2</span>
                        <span class="c1"># G = 1e-9 * (numpy.pi * numpy.power(radius, 4)) / (22 * bloodvisc * length)</span>
                        <span class="c1"># edge[2] = G + 1e-32</span>

                        <span class="c1"># scale conductance</span>
                        <span class="c1"># radius = (node1.RefRadius + node2.RefRadius) / 2</span>
                        <span class="c1"># G = 1e-9 * (numpy.pi * numpy.power(radius, 4)) / (22 * bloodvisc * length)</span>
                        <span class="c1"># edge[2] = G * clot[1] + 1e-32</span>

                        <span class="c1"># edge[2] = edge[2] * clot[1] + 1e-32  # 0.001 # Non-zero for permeable clots! value is defined in Clots.txt</span>
                        <span class="c1"># error if exactly zero</span>

            <span class="c1"># remove edges if both nodes are clot nodes.</span>
            <span class="c1"># clotnodes = [node for clot in self.Clots for node in clot[0]]</span>
            <span class="c1"># edges = [x for x in edges if not (x[0] in clotnodes and x[1] in clotnodes)]</span>

        <span class="n">duplicatenodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationDict</span><span class="p">()</span>
        <span class="n">nodestoreplace1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nodestoreplace2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">oldnodes1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">oldnodes2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">edge</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edges</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">duplicatenodes</span><span class="p">:</span>
                <span class="n">nodestoreplace1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="n">duplicatenodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
                <span class="n">oldnodes1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">duplicatenodes</span><span class="p">:</span>
                <span class="n">nodestoreplace2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="n">duplicatenodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>
                <span class="n">oldnodes2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">replace</span> <span class="ow">in</span> <span class="n">nodestoreplace1</span><span class="p">:</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">replace</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">replace</span> <span class="ow">in</span> <span class="n">nodestoreplace2</span><span class="p">:</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">replace</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">nodeset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">nodeset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">nodeset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">nodesetlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nodeset</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodesetlist</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">ssindex</span> <span class="o">=</span> <span class="n">index</span>

        <span class="n">mtx</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">lil_matrix</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">nodesetlist</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodesetlist</span><span class="p">)))</span>

        <span class="k">def</span> <span class="nf">updatemat</span><span class="p">(</span><span class="n">edge</span><span class="p">):</span>
            <span class="n">index1</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ssindex</span>
            <span class="n">index2</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ssindex</span>
            <span class="n">mtx</span><span class="p">[</span><span class="n">index1</span><span class="p">,</span> <span class="n">index2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">mtx</span><span class="p">[</span><span class="n">index2</span><span class="p">,</span> <span class="n">index1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">with</span> <span class="n">Pool</span><span class="p">()</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">updatemat</span><span class="p">,</span> <span class="n">edges</span><span class="p">)</span>

        <span class="n">rowsum</span> <span class="o">=</span> <span class="n">mtx</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodesetlist</span><span class="p">)):</span>
            <span class="n">mtx</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">rowsum</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="c1"># inputvector = scipy.sparse.lil_matrix((len(nodesetlist), 1))</span>
        <span class="n">inputvector</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">nodesetlist</span><span class="p">),))</span>

        <span class="c1"># outlet flowrates</span>
        <span class="k">if</span> <span class="n">FlowRateOutlets</span><span class="p">:</span>
            <span class="c1"># for outlet in OutletNodes:</span>
            <span class="c1">#     inputvector[outlet.ssindex] = outlet.OutPressure</span>
            <span class="c1">#     index1 = outlet.ssindex</span>
            <span class="c1">#     inputvector[next(iter(outlet.Connections)).ssindex] = outlet.OutletFlowRate  # flowrate at that wk node</span>
            <span class="c1">#     mtx[index1, next(iter(outlet.Connections)).ssindex] = 0</span>
            <span class="c1">#     mtx[index1, index1] = 1</span>
            <span class="k">for</span> <span class="n">outlet</span> <span class="ow">in</span> <span class="n">OutletNodes</span><span class="p">:</span>
                <span class="n">inputvector</span><span class="p">[</span><span class="n">outlet</span><span class="o">.</span><span class="n">ssindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">outlet</span><span class="o">.</span><span class="n">OutletFlowRate</span>  <span class="c1"># flowrate at that wk node</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># pressure at that wk node, outpressure</span>
            <span class="k">for</span> <span class="n">outlet</span> <span class="ow">in</span> <span class="n">OutletNodes</span><span class="p">:</span>
                <span class="n">inputvector</span><span class="p">[</span><span class="n">outlet</span><span class="o">.</span><span class="n">ssindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">outlet</span><span class="o">.</span><span class="n">OutPressure</span>
                <span class="n">index1</span> <span class="o">=</span> <span class="n">outlet</span><span class="o">.</span><span class="n">ssindex</span>
                <span class="n">mtx</span><span class="p">[</span><span class="n">index1</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">outlet</span><span class="o">.</span><span class="n">Connections</span><span class="p">))</span><span class="o">.</span><span class="n">ssindex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">mtx</span><span class="p">[</span><span class="n">index1</span><span class="p">,</span> <span class="n">index1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># if using pressure at the inlet:</span>
        <span class="k">if</span> <span class="n">PressureInlets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">inletnode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">:</span>
                <span class="n">inputvector</span><span class="p">[</span><span class="n">inletnode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ssindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">inletnode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">InletPressure</span>  <span class="c1"># standard units Pa</span>
                <span class="n">index1</span> <span class="o">=</span> <span class="n">inletnode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ssindex</span>
                <span class="n">mtx</span><span class="p">[</span><span class="n">index1</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">inletnode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Connections</span><span class="p">))</span><span class="o">.</span><span class="n">ssindex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">mtx</span><span class="p">[</span><span class="n">index1</span><span class="p">,</span> <span class="n">index1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># inlet flowrates</span>
            <span class="k">for</span> <span class="n">inletnode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">:</span>
                <span class="n">inputvector</span><span class="p">[</span><span class="n">inletnode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ssindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">inletnode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">InletFlowRate</span>  <span class="c1"># standard units m^3/s</span>

        <span class="k">return</span> <span class="n">mtx</span><span class="o">.</span><span class="n">tocsc</span><span class="p">(),</span> <span class="n">inputvector</span><span class="p">,</span> <span class="n">nodesetlist</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="p">(</span><span class="n">oldnodes1</span><span class="p">,</span> <span class="n">oldnodes2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">addCollateralsToTopology</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">vesselslist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Collaterals</span><span class="p">:</span>
            <span class="n">vessel</span> <span class="o">=</span> <span class="n">Vessel</span><span class="o">.</span><span class="n">Vessel</span><span class="p">()</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">SetNodes</span><span class="p">([</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="c1"># vessel.SetType(5)</span>
            <span class="c1"># vesselid = self.Vessels[-1].ID+1</span>
            <span class="c1"># vessel.SetID(vesselid)</span>
            <span class="n">vesselslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
        <span class="c1"># for edge in self.Collaterals:</span>
        <span class="c1">#     vessel = Vessel.Vessel()</span>
        <span class="c1">#     vessel.SetNodes([edge[0], edge[1]])</span>
        <span class="c1">#     vessel.SetType(5)</span>
        <span class="c1">#     vesselid = self.Vessels[-1].ID+1</span>
        <span class="c1">#     vessel.SetID(vesselid)</span>
        <span class="c1">#     self.Vessels.append(vessel)</span>
        <span class="c1"># self.UpdateTopology()</span>
        <span class="n">nodelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vesselslist</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>

        <span class="n">nodes</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPoints</span><span class="p">()</span>
        <span class="n">vessels</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellArray</span><span class="p">()</span>
        <span class="c1"># radius = vtk.vtkFloatArray()</span>
        <span class="c1">#</span>
        <span class="c1"># radius.SetNumberOfComponents(1)</span>
        <span class="c1"># radius.SetName(&quot;Radius&quot;)</span>
        <span class="c1">#</span>
        <span class="c1"># nodetype = vtk.vtkIntArray()</span>
        <span class="c1"># nodetype.SetName(&quot;Node Type &quot;)</span>

        <span class="c1"># Add radius and position to data array</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodelist</span><span class="p">):</span>
            <span class="n">i</span><span class="o">.</span><span class="n">Number</span> <span class="o">=</span> <span class="n">index</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
            <span class="c1"># radius.InsertNextValue(float(i.Radius))</span>
            <span class="c1"># nodetype.InsertNextValue(i.Type)</span>

        <span class="c1"># Add vessels to cell array</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vesselslist</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkLine</span><span class="p">()</span>
            <span class="n">line</span><span class="o">.</span><span class="n">GetPointIds</span><span class="p">()</span><span class="o">.</span><span class="n">SetNumberOfIds</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)):</span>
                <span class="n">line</span><span class="o">.</span><span class="n">GetPointIds</span><span class="p">()</span><span class="o">.</span><span class="n">SetId</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
            <span class="n">vessels</span><span class="o">.</span><span class="n">InsertNextCell</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># Create a polydata to store everything in</span>
        <span class="n">VesselsPolyData</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">()</span>

        <span class="c1"># Add the nodes to the polydata</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">SetPoints</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

        <span class="c1"># Add the vessels to the polydata</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">SetLines</span><span class="p">(</span><span class="n">vessels</span><span class="p">)</span>

        <span class="c1"># Assign radii to the nodes</span>
        <span class="c1"># VesselsPolyData.GetPointData().SetScalars(radius)</span>
        <span class="c1"># VesselsPolyData.GetPointData().AddArray(nodetype)</span>

        <span class="c1"># atlas = vtk.vtkIntArray()</span>
        <span class="c1"># [atlas.InsertNextValue(i.ID) for index, i in enumerate(self.Vessels)]</span>
        <span class="c1"># atlas.SetName(&quot;Vessel Ids&quot;)</span>
        <span class="c1"># VesselsPolyData.GetCellData().AddArray(atlas)</span>
        <span class="c1">#</span>
        <span class="c1"># majoratlas = vtk.vtkIntArray()</span>
        <span class="c1"># [majoratlas.InsertNextValue(i.MajorVesselID) for index, i in enumerate(self.Vessels)]</span>
        <span class="c1"># majoratlas.SetName(&quot;Major Vessel Ids&quot;)</span>
        <span class="c1"># VesselsPolyData.GetCellData().AddArray(majoratlas)</span>

        <span class="c1"># Save everyting in a vtp file</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">VesselsPolyData</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>



    <span class="k">def</span> <span class="nf">SteadyStateNonLinear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">clotactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">PressureInlets</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">conductancematrix</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Get1DsteadyNetwork</span><span class="p">(</span><span class="n">bloodvisc</span><span class="p">,</span> <span class="n">clotactive</span><span class="p">,</span>
                                                                                    <span class="n">PressureInlets</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodes</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="o">=</span> <span class="n">index</span>

        <span class="n">vesselbifnodes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span> <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># todo get indices of bifurcation vessel nodes and update resisuals. There is an error relating to the numbering of the nodes.</span>
        <span class="c1"># The matrix has to be updated to handle this system.</span>

        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">pressures</span><span class="p">):</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="n">conductancematrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pressures</span><span class="p">)</span> <span class="o">-</span> <span class="n">sources</span>
            <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">vesselbifnodes</span><span class="p">:</span>
                <span class="c1"># flow = sum([(pressures[node.Number]-pressures[node.NearestVesselNode.Number])*conductancematrix[node.Number,node.NearestVesselNode.Number] for node in bif])</span>

                <span class="n">residuals</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> \
                                           <span class="n">conductancematrix</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bif</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                    <span class="n">residuals</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> \
                                                <span class="n">conductancematrix</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>
                    <span class="n">velocity</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> <span class="n">conductancematrix</span><span class="p">[</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">node</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">node</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                    <span class="n">bernoulli</span> <span class="o">=</span> <span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">density</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">velocity</span> <span class="o">*</span> <span class="n">velocity</span>
                    <span class="n">velocity2</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span>
                        <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> <span class="n">conductancematrix</span><span class="p">[</span>
                                    <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
                                        <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                    <span class="n">bernoulli2</span> <span class="o">=</span> <span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">density</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">velocity2</span> <span class="o">*</span> <span class="n">velocity2</span>
                    <span class="n">residuals</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="n">bernoulli</span> <span class="o">-</span> <span class="n">bernoulli2</span>

            <span class="k">return</span> <span class="n">residuals</span>

        <span class="c1"># guess = func(numpy.zeros((nodeslength,)))</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="mi">10000</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">))</span>
        <span class="c1"># guess = []</span>
        <span class="c1"># for vessel in self.Vessels:</span>
        <span class="c1">#     for node in vessel.Nodes:</span>
        <span class="c1">#         guess.append(node.Pressure)</span>
        <span class="c1">#</span>

        <span class="n">solution</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">fsolve</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">nonlinearmodel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">,</span> <span class="n">density</span><span class="p">):</span>
        <span class="c1"># for each vessel node, create a list of conservation of flow</span>
        <span class="c1"># use the matrix from the linear model but with the bifurcations removed</span>

        <span class="c1"># we can use the same code for most</span>
        <span class="c1"># be sure to subtract the input vector and only return the pressure of the correct nodes</span>

        <span class="c1"># the matrix is fine for the linear parts</span>
        <span class="c1"># use matrix notation for the nonlinear parts as well</span>
        <span class="c1"># code needs to be fast in the future.</span>

        <span class="c1"># matrix for the linear system with removed bifurcations replacement</span>
        <span class="c1"># return residuals for the vessel nodes inc outlets and inlets</span>

        <span class="c1"># calculate the velocity at the bifurcation node</span>
        <span class="c1"># calcualte the residuals for the bifurcations</span>

        <span class="c1"># probably better to use a loop</span>
        <span class="c1"># make a list of edges to store the connectivity information</span>
        <span class="c1"># loop over bifurcations, inlet and outlets.</span>

        <span class="c1"># store a list of information about which node the pressure belongs to</span>
        <span class="n">nodeslength</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">)</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[:</span><span class="n">nodeslength</span><span class="p">]</span>
        <span class="c1"># assumption is that the pressure input is in the same order as the nodes</span>

        <span class="n">conductancematrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nodeslength</span><span class="p">,</span> <span class="n">nodeslength</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="c1"># first and last nodes</span>
            <span class="n">conductancematrix</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">SegmentConductance</span><span class="p">(</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">bloodvisc</span><span class="p">)</span>

            <span class="n">conductancematrix</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">SegmentConductance</span><span class="p">(</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">bloodvisc</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">conductancematrix</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">SegmentConductance</span><span class="p">(</span>
                    <span class="n">node</span><span class="p">,</span>
                    <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
                    <span class="n">bloodvisc</span><span class="p">)</span>
                <span class="n">conductancematrix</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">SegmentConductance</span><span class="p">(</span>
                    <span class="n">node</span><span class="p">,</span>
                    <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span>
                    <span class="n">bloodvisc</span><span class="p">)</span>

        <span class="n">rowsum</span> <span class="o">=</span> <span class="n">conductancematrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)):</span>
            <span class="n">conductancematrix</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">rowsum</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="c1"># add the conductance from the WK outlets</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">outlet</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">):</span>
            <span class="n">conductancematrix</span><span class="p">[</span><span class="n">outlet</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">outlet</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">outlet</span><span class="o">.</span><span class="n">R1</span> <span class="o">+</span> <span class="n">outlet</span><span class="o">.</span><span class="n">R2</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># add the vesselnodes that connect to vesselbifurcationnodes for easy access.</span>
        <span class="n">vesselbifnodes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span> <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">]</span>

        <span class="n">sources</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nodeslength</span><span class="p">,))</span>

        <span class="c1"># inlets</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">inlet</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">):</span>
            <span class="n">sources</span><span class="p">[</span><span class="n">inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="n">inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">InletFlowRate</span>

        <span class="c1"># outlets</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">outlet</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">):</span>
            <span class="n">sources</span><span class="p">[</span><span class="n">outlet</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="n">outlet</span><span class="o">.</span><span class="n">OutPressure</span> <span class="o">/</span> <span class="p">(</span><span class="n">outlet</span><span class="o">.</span><span class="n">R1</span> <span class="o">+</span> <span class="n">outlet</span><span class="o">.</span><span class="n">R2</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">pressures</span><span class="p">):</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="n">conductancematrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pressures</span><span class="p">)</span> <span class="o">-</span> <span class="n">sources</span>
            <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">vesselbifnodes</span><span class="p">:</span>
                <span class="c1"># flow = sum([(pressures[node.Number]-pressures[node.NearestVesselNode.Number])*conductancematrix[node.Number,node.NearestVesselNode.Number] for node in bif])</span>
                <span class="n">residuals</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> \
                                           <span class="n">conductancematrix</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bif</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                    <span class="n">residuals</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> \
                                                <span class="n">conductancematrix</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>
                    <span class="n">velocity</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> <span class="n">conductancematrix</span><span class="p">[</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">node</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">node</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                    <span class="n">bernoulli</span> <span class="o">=</span> <span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">density</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">velocity</span> <span class="o">*</span> <span class="n">velocity</span>
                    <span class="n">velocity2</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span>
                        <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> <span class="n">conductancematrix</span><span class="p">[</span>
                                    <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
                                        <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                    <span class="n">bernoulli2</span> <span class="o">=</span> <span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">density</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">velocity2</span> <span class="o">*</span> <span class="n">velocity2</span>
                    <span class="n">residuals</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="n">bernoulli</span> <span class="o">-</span> <span class="n">bernoulli2</span>

            <span class="k">return</span> <span class="n">residuals</span>

        <span class="c1"># guess = func(numpy.zeros((nodeslength,)))</span>
        <span class="c1"># guess = [node.Pressure for vessel in self.Vessels for node in vessel.Nodes]</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                <span class="n">guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Pressure</span><span class="p">)</span>
        <span class="c1">#</span>

        <span class="n">solution</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">fsolve</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">guess</span><span class="p">)</span>  <span class="c1"># ,full_output=True)</span>
        <span class="c1"># print(solution[1])</span>
        <span class="c1"># solution = scipy.linalg.solve(conductancematrix, sources)</span>
        <span class="k">return</span> <span class="n">solution</span><span class="p">,</span> <span class="n">nodes</span>
</pre></div>

        </details>

    

                            <div id="Topology.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Topology</span><span class="signature">()</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coarse_collaterals_effective_radius</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coarse_collaterals_number</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coarse_collaterals_threshold</span> <span class="o">=</span> <span class="mi">25</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coarse_collaterals_After_WKNodes</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># set to true for coupled model with estimated coupling resistance.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfVessels</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfNodes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Clots</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Graph</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NodeDict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.MapbifurcationstoVessels" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.MapbifurcationstoVessels">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">MapbifurcationstoVessels</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">MapbifurcationstoVessels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For each bifurcation in topology (self.BifurcationNodes),</span>
<span class="sd">        the VesselConnections is created with the connected vessels.</span>
<span class="sd">        :return: None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># vesseldist = {item: sublist for sublist in self.Vessels for item in sublist.Nodes}</span>
        <span class="n">vesseldist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NodeVesselDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="n">bif</span><span class="o">.</span><span class="n">VesselConnections</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">vesseldist</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>For each bifurcation in topology (self.BifurcationNodes),
the VesselConnections is created with the connected vessels.
:return: None.</p>
</div>


                            </div>
                            <div id="Topology.MapNodesToVesselID" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.MapNodesToVesselID">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">MapNodesToVesselID</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">MapNodesToVesselID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a dictionary of nodes to major vessel ID</span>
<span class="sd">        :return: dict with keys the nodes and values their major vessel ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nodedict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)):</span>
            <span class="p">[</span><span class="n">nodedict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">nodedict</span>
</pre></div>

        </details>

            <div class="docstring"><p>Create a dictionary of nodes to major vessel ID
:return: dict with keys the nodes and values their major vessel ID.</p>
</div>


                            </div>
                            <div id="Topology.NodeVesselDict" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.NodeVesselDict">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">NodeVesselDict</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">NodeVesselDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a dict that maps nodes to the vessel.</span>
<span class="sd">        Sets self.NodeDict</span>
<span class="sd">        :return: dictionary of nodes to vessels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NodeDict</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="n">vessel</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">NodeDict</span>
</pre></div>

        </details>

            <div class="docstring"><p>Create a dict that maps nodes to the vessel.
Sets self.NodeDict
:return: dictionary of nodes to vessels</p>
</div>


                            </div>
                            <div id="Topology.VesselGraph" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.VesselGraph">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">VesselGraph</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">VesselGraph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vertices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">GetProximalBifurcation</span><span class="p">()</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">GetDistalBifurcation</span><span class="p">()</span>
            <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">vessel</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">edges</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.GetVesselNameFromNode" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.GetVesselNameFromNode">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">GetVesselNameFromNode</span><span class="signature">(self, node)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">GetVesselNameFromNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Name</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Node not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.UpdateNodeType" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.UpdateNodeType">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">UpdateNodeType</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">UpdateNodeType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">SetType</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Type</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Type</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">:</span>
            <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Type</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.UpdateM2Names" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.UpdateM2Names">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">UpdateM2Names</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">UpdateM2Names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the vessel names of the m2 vessels.</span>
<span class="sd">        Smaller branch:inferior branch</span>
<span class="sd">        Larger branch: superior branch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateVesselAtlas</span><span class="p">()</span>

        <span class="c1"># find both sides</span>
        <span class="n">sides</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;R. MCA&quot;</span><span class="p">,</span> <span class="s2">&quot;L. MCA&quot;</span><span class="p">]</span>
        <span class="n">new_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;M2 sup&quot;</span><span class="p">,</span> <span class="s2">&quot;M2 inf&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="n">sides</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">gens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetDownstreamVessels</span><span class="p">(</span><span class="n">side</span><span class="p">)</span>
            <span class="c1"># assuming vessels exist</span>
            <span class="n">downstream1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetDownstreamVessels</span><span class="p">(</span><span class="n">gens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">downstream2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetDownstreamVessels</span><span class="p">(</span><span class="n">gens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># sup branch has more downstream vessels?</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">downstream1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">downstream2</span><span class="p">):</span>
                <span class="n">gens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">side</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">new_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">gens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">side</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">new_names</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">side</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">new_names</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">gens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">side</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">new_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateVesselAtlas</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Update the vessel names of the m2 vessels.
Smaller branch:inferior branch
Larger branch: superior branch</p>
</div>


                            </div>
                            <div id="Topology.UpdateVesselAtlas" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.UpdateVesselAtlas">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">UpdateVesselAtlas</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">UpdateVesselAtlas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an dictionary keyed to vessel name and vessel id.</span>
<span class="sd">        Value returned from the dictionary is the vessel.</span>
<span class="sd">        :return: None, self.VesselAtlas is updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">]</span> <span class="o">=</span> <span class="n">vessel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">vessel</span>
</pre></div>

        </details>

            <div class="docstring"><p>Create an dictionary keyed to vessel name and vessel id.
Value returned from the dictionary is the vessel.
:return: None, self.VesselAtlas is updated.</p>
</div>


                            </div>
                            <div id="Topology.UpdateTopology" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.UpdateTopology">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">UpdateTopology</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">UpdateTopology</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">]</span>
        <span class="c1"># [vessel.SetID(id) for id, vessel in enumerate(self.Vessels)]</span>
        <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">UpdateVessel</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateVesselAtlas</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateNumbers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateNodeType</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberNodes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CheckConnectivity</span><span class="p">()</span>
        <span class="c1"># self.FindOutletNodes()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.WriteNodesCSV" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.WriteNodesCSV">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">WriteNodesCSV</span><span class="signature">(self, filename)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">WriteNodesCSV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ID,VesselID,Connectivity,Position,Radius,LengthAlongVessel,Elasticity,R1,R2,C,Thickness,Type</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">VesselID</span><span class="p">)</span>
                <span class="n">othernodes</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Connections</span><span class="p">)])</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">othernodes</span><span class="p">)</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">Position</span><span class="p">])</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">pos</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">YoungsModules</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">R1</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">R1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">R2</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">R2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">C</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">C</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">Thickness</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.WriteVesselCSV" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.WriteVesselCSV">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">WriteVesselCSV</span><span class="signature">(self, filename)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">WriteVesselCSV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Name,ID,Radius(mm),Length(mm),YoungsModules(pa),MeanThickness(mm),Type,Nodes</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">CalculateMeanRadius</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">vessel</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanRadius</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">vessel</span><span class="o">.</span><span class="n">YoungsModules</span><span class="p">)</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">CalculateMeanThickness</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanThickness</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>
                <span class="n">Nodes</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)])</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Nodes</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.BifurcationDict" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.BifurcationDict">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">BifurcationDict</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">BifurcationDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a dictionary of the bifurcation nodes.</span>
<span class="sd">        Keys are the nodes of the system and return value is the linked bifurcation node</span>
<span class="sd">        :return: dict{node:bifnode}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">duplicatenodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">):</span>
                <span class="n">duplicatenodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">bif</span>
        <span class="k">return</span> <span class="n">duplicatenodes</span>
</pre></div>

        </details>

            <div class="docstring"><p>Create a dictionary of the bifurcation nodes.
Keys are the nodes of the system and return value is the linked bifurcation node
:return: dict{node:bifnode}</p>
</div>


                            </div>
                            <div id="Topology.UpdateNumbers" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.UpdateNumbers">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">UpdateNumbers</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">UpdateNumbers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfVessels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfNodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span>
        <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">UpdateNodeNumber</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.SetThickness" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.SetThickness">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">SetThickness</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">SetThickness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Thickness</span> <span class="o">=</span> <span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">thickness</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.CheckConnectivity" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.CheckConnectivity">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">CheckConnectivity</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">CheckConnectivity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking for disconnected nodes.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Disconnected node detected at node number </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">index</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;None Found.&quot;</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.SaveVesselAtlas" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.SaveVesselAtlas">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">SaveVesselAtlas</span><span class="signature">(self, file=&#39;Mapping.csv&#39;)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">SaveVesselAtlas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;Mapping.csv&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No Atlas defined.&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing the vessel Atlas to file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>
        <span class="c1"># check if there are nodes without a number.</span>
        <span class="c1"># if so, renumber all nodes.</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">NumberNodes</span><span class="p">()</span>
                <span class="k">break</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">):</span>
                <span class="n">vesselname</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Name</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
                <span class="n">nodelist</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">vesselname</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">,&quot;</span> <span class="o">+</span> <span class="n">nodelist</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.LoadSegmentedVessels_old" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.LoadSegmentedVessels_old">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">LoadSegmentedVessels_old</span><span class="signature">(self, inputfolder)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">LoadSegmentedVessels_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputfolder</span><span class="p">):</span>
        <span class="c1"># temp solution</span>

        <span class="n">finalfile</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="s2">&quot;1-D_Anatomy_Patient.txt&quot;</span>
        <span class="n">readfile</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="s2">&quot;Feature_Vessel.csv&quot;</span>
        <span class="n">readfile2</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="s2">&quot;Image_info.txt&quot;</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="nb">float</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">readfile2</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="s2">&quot;1-D_Anatomy.txt&quot;</span>

        <span class="n">vesselscsv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">readfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
            <span class="n">readCSV</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">readCSV</span><span class="p">:</span>
                <span class="n">vesselscsv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="n">vessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vesselscsv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">vesseldata</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;vessel&#39;</span><span class="p">,</span> <span class="s1">&#39;ID Length Radius&#39;</span><span class="p">)</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">ID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">Length</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">Radius</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vesseldata</span><span class="p">)</span>

        <span class="n">anatomy</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>

        <span class="c1"># mapping between anatomy and patient segmented vessels</span>
        <span class="c1"># VesselID segmentation, name from segmentation, ID in 1-D anatomy</span>
        <span class="n">MapSegmentation</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;ICA L&quot;</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;ICA R&quot;</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;M1 L&quot;</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;M1 R&quot;</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;M2 L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;M2 R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;A1 L&quot;</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;A1 R&quot;</span><span class="p">,</span> <span class="mi">26</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="s2">&quot;A2 L&quot;</span><span class="p">,</span> <span class="mi">29</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;A2 R&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="s2">&quot;AComm&quot;</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;M3 L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="s2">&quot;M3 R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="s2">&quot;VA L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># 17</span>
                           <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;VA R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># 14</span>
                           <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s2">&quot;BA&quot;</span><span class="p">,</span> <span class="mi">22</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="s2">&quot;P1 L&quot;</span><span class="p">,</span> <span class="mi">27</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="s2">&quot;P1 R&quot;</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="s2">&quot;P2 L&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;P2 R&quot;</span><span class="p">,</span> <span class="mi">33</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="s2">&quot;PComm L&quot;</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="s2">&quot;PComm R&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="s2">&quot;OA L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="s2">&quot;OA R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">]</span>

        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">MapSegmentation</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vessel</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">vessel</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
            <span class="n">mapped</span> <span class="o">=</span> <span class="n">MapSegmentation</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">finalfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">anatomy</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.LoadSegmentedVessels" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.LoadSegmentedVessels">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">LoadSegmentedVessels</span><span class="signature">(self, inputfolder, CoWFile=&#39;1-D_Anatomy.txt&#39;)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">LoadSegmentedVessels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputfolder</span><span class="p">,</span> <span class="n">CoWFile</span><span class="o">=</span><span class="s2">&quot;1-D_Anatomy.txt&quot;</span><span class="p">):</span>
        <span class="c1"># temp solution</span>

        <span class="n">finalfile</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="s2">&quot;1-D_Anatomy_Patient.txt&quot;</span>
        <span class="n">readfile</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="s2">&quot;Feature_Vessel.csv&quot;</span>
        <span class="n">readfile2</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="s2">&quot;Image_info.txt&quot;</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="nb">float</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">readfile2</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">file</span> <span class="o">=</span> <span class="n">inputfolder</span> <span class="o">+</span> <span class="n">CoWFile</span>
        <span class="n">anatomy</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>

        <span class="n">vesselscsv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">readfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
            <span class="n">readCSV</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">readCSV</span><span class="p">:</span>
                <span class="n">vesselscsv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="n">vessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vesselscsv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">vesseldata</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;vessel&#39;</span><span class="p">,</span> <span class="s1">&#39;ID Length Radius Startmark Endmark vesselnumber StartPos EndPos&#39;</span><span class="p">)</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">ID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">StartPos</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">6</span><span class="p">]))</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">EndPos</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">7</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">8</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">9</span><span class="p">]))</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">Length</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="c1"># The field called A_diameter is actually the radius of the vessel in voxel units - Praneeta</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">Radius</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">Startmark</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">vesseldata</span><span class="o">.</span><span class="n">Endmark</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vesseldata</span><span class="p">)</span>

        <span class="c1"># mapping between anatomy and patient segmented vessels</span>
        <span class="c1"># VesselID segmentation, name from segmentation, ID in 1-D anatomy</span>
        <span class="n">MapSegmentation</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;ICA L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;ICA R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;M1 L&quot;</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;M1 R&quot;</span><span class="p">,</span> <span class="mi">22</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;M2 L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># not in default anatomy</span>
                           <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;M2 R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># not in default anatomy</span>
                           <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;A1 L&quot;</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;A1 R&quot;</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="s2">&quot;A2 L&quot;</span><span class="p">,</span> <span class="mi">27</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;A2 R&quot;</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="s2">&quot;AComm&quot;</span><span class="p">,</span> <span class="mi">29</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;M3 L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># not in default anatomy</span>
                           <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="s2">&quot;M3 R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># not in default anatomy</span>
                           <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="s2">&quot;VA L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># 17  # not part of the scan region but is not missing either.</span>
                           <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;VA R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># 14 # not part of the scan region but is not missing either.</span>
                           <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s2">&quot;BA&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># split into 5!</span>
                           <span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="s2">&quot;P1 L&quot;</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="s2">&quot;P1 R&quot;</span><span class="p">,</span> <span class="mi">26</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="s2">&quot;P2 L&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;P2 R&quot;</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="s2">&quot;PComm L&quot;</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="s2">&quot;PComm R&quot;</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span>
                           <span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="s2">&quot;OA L&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># not part of the scan region but is not missing either.</span>
                           <span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="s2">&quot;OA R&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">]</span>  <span class="c1"># not part of the scan region but is not missing either.</span>

        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">vesselnumber</span> <span class="o">=</span> <span class="n">MapSegmentation</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># set missing vessels to zero</span>
        <span class="c1"># some vessels are excluded as they have to be present but are not in the scans.</span>
        <span class="c1"># example, aortic arch (23,24)</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">MapSegmentation</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">vessel</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># overwrite default anatomy</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
            <span class="n">mapped</span> <span class="o">=</span> <span class="n">MapSegmentation</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                <span class="n">anatomy</span><span class="p">[</span><span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>

        <span class="c1"># remove the inlet vessels as these are cut off during imaging (incorrect length)</span>
        <span class="n">vessels</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">])]</span>

        <span class="c1"># add vessels not present in default anatomy</span>
        <span class="c1"># &quot;M2 L&quot;  # not in default anatomy</span>
        <span class="c1"># &quot;M2 R&quot;  # not in default anatomy</span>
        <span class="c1"># &quot;M3 L&quot;  # not in default anatomy</span>
        <span class="c1"># &quot;M3 R&quot;  # not in default anatomy</span>
        <span class="c1"># assumption is that these always come in pairs</span>
        <span class="n">extravessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">newvessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
            <span class="n">mapped</span> <span class="o">=</span> <span class="n">MapSegmentation</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mapped</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># print(vessel)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">mapped</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">extravessels</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;,2&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">extravessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;,1&quot;</span>
                <span class="n">length</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                <span class="n">youngsmodulus</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mf">1.6</span><span class="p">)</span>
                <span class="n">newves</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">youngsmodulus</span><span class="p">],</span> <span class="n">vessel</span><span class="p">]</span>
                <span class="n">newvessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newves</span><span class="p">)</span>

        <span class="c1"># add vessels to the anatomy</span>
        <span class="n">numberoldvessels</span> <span class="o">=</span> <span class="n">anatomy</span><span class="o">.</span><span class="n">index</span><span class="p">([</span><span class="s1">&#39;Bifurcations&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newvessels</span><span class="p">):</span>
            <span class="n">vessel</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">numberoldvessels</span> <span class="o">+</span> <span class="n">index</span><span class="p">)</span>
            <span class="n">vessel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">vesselnumber</span> <span class="o">=</span> <span class="n">numberoldvessels</span> <span class="o">+</span> <span class="n">index</span>
            <span class="n">anatomy</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">numberoldvessels</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># extract ends</span>
        <span class="n">endspos</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">StartPos</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">EndPos</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">]</span>
        <span class="n">ends</span> <span class="o">=</span> <span class="p">[</span><span class="n">end</span> <span class="k">for</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">endspos</span><span class="p">))]</span>
        <span class="n">marks</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">list</span><span class="p">(</span><span class="n">end</span><span class="p">),</span> <span class="p">[],</span> <span class="p">[]]</span> <span class="k">for</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">ends</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ends</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">vessel</span><span class="o">.</span><span class="n">StartPos</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>
                    <span class="n">marks</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">vessel</span><span class="o">.</span><span class="n">EndPos</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>
                    <span class="n">marks</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>

        <span class="c1"># extract bifurcations</span>
        <span class="n">bifurcations</span> <span class="o">=</span> <span class="p">[</span><span class="n">mark</span> <span class="k">for</span> <span class="n">mark</span> <span class="ow">in</span> <span class="n">marks</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mark</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">mark</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># assign numbers</span>
        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">bifurcations</span><span class="p">:</span>
            <span class="n">numbers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">bif</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">numbers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Startmark</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">bif</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">numbers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Endmark</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error in segmentation. Bifurcation has more than one ID.&quot;</span><span class="p">)</span>
            <span class="n">bif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">numbers</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># list the new bifurcations in the 1-D anatomy format</span>
        <span class="n">possiblenewvesselsbif</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">]</span>
        <span class="n">candidatebif</span> <span class="o">=</span> <span class="p">[</span><span class="n">bif</span> <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">bifurcations</span> <span class="k">if</span> <span class="n">bif</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="n">possiblenewvesselsbif</span><span class="p">]</span>

        <span class="c1"># we assume a certain direction, the segmentation do not seem to follow the same.</span>
        <span class="c1"># M1 R, 4-&gt;8, 4</span>
        <span class="c1"># M2 R, 8-&gt;14, 6</span>
        <span class="c1"># M3 R, 14-&gt;26, 13</span>
        <span class="c1"># M1 L, 3-&gt;7, 3</span>
        <span class="c1"># M2 L, 7-&gt;13, 5</span>
        <span class="c1"># M3 L, 13-&gt;25, 12</span>
        <span class="n">bifends</span> <span class="o">=</span> <span class="p">{</span><span class="mi">7</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                   <span class="mi">8</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
                   <span class="mi">13</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
                   <span class="mi">14</span><span class="p">:</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span>
                   <span class="mi">25</span><span class="p">:</span> <span class="p">(</span><span class="mi">12</span><span class="p">,),</span>
                   <span class="mi">26</span><span class="p">:</span> <span class="p">(</span><span class="mi">13</span><span class="p">,)}</span>

        <span class="n">newbifs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">inout</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">bif</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">candidatebif</span><span class="p">):</span>
            <span class="c1"># ends = [str(i.vesselnumber) + &quot;i&quot; for i in bif[0]]</span>
            <span class="c1"># ends += [str(i.vesselnumber) + &quot;o&quot; for i in bif[1]]</span>
            <span class="n">ends</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">endlist</span> <span class="o">=</span> <span class="n">bifends</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">bif</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">endlist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
                <span class="n">ends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">vesselnumber</span><span class="p">)</span> <span class="o">+</span> <span class="n">inout</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">bif</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">endlist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
                <span class="n">ends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">vesselnumber</span><span class="p">)</span> <span class="o">+</span> <span class="n">inout</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
            <span class="n">newbifs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ends</span><span class="p">))</span>

        <span class="n">endsbiflist</span> <span class="o">=</span> <span class="n">anatomy</span><span class="o">.</span><span class="n">index</span><span class="p">([</span><span class="s1">&#39;Boundary Nodes&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">newbif</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newbifs</span><span class="p">):</span>
            <span class="n">anatomy</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">endsbiflist</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span> <span class="p">[</span><span class="n">newbif</span><span class="p">])</span>

        <span class="n">ends</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Outlets Brain:&quot;</span><span class="p">]</span>
        <span class="n">nodesinbif</span> <span class="o">=</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">}</span>  <span class="c1"># only possible extra ones atm</span>
        <span class="n">startbiflist</span> <span class="o">=</span> <span class="n">anatomy</span><span class="o">.</span><span class="n">index</span><span class="p">([</span><span class="s1">&#39;Bifurcations&#39;</span><span class="p">])</span>
        <span class="n">endsbiflist</span> <span class="o">=</span> <span class="n">anatomy</span><span class="o">.</span><span class="n">index</span><span class="p">([</span><span class="s1">&#39;Boundary Nodes&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">anatomy</span><span class="p">[</span><span class="n">startbiflist</span><span class="p">:</span><span class="n">endsbiflist</span><span class="p">]:</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="p">[</span><span class="n">nodesinbif</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span> <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;o&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">startbiflist</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nodesinbif</span><span class="p">:</span>
                <span class="n">ends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
        <span class="n">anatomy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ends</span><span class="p">)]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">finalfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">anatomy</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.LoadBFSimFiles" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.LoadBFSimFiles">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">LoadBFSimFiles</span><span class="signature">(self, folder)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">LoadBFSimFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadTopFile</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;System.top&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadParFile</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;System.par&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadRunFile</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;Run.txt&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadVesselAtlas</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;Mapping.csv&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadClotFile</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;Clots.txt&quot;</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.LoadTopFile" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.LoadTopFile">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">LoadTopFile</span><span class="signature">(self, file)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">LoadTopFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading topology file.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ReadNodesFromTopFile</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CheckConnectivity</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.LoadParFile" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.LoadParFile">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">LoadParFile</span><span class="signature">(self, file)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">LoadParFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading parameter file.&quot;</span><span class="p">)</span>
        <span class="n">pardata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">pardata</span><span class="p">:</span>
            <span class="n">nodenumber</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">nodenumber</span><span class="p">]</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">:])</span> <span class="o">*</span> <span class="mf">1e9</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">:])</span> <span class="o">*</span> <span class="mf">1e9</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">:])</span> <span class="o">*</span> <span class="mf">1e-12</span>
            <span class="n">node</span><span class="o">.</span><span class="n">SetWK</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.LoadRunFile" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.LoadRunFile">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">LoadRunFile</span><span class="signature">(self, file)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">LoadRunFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading run file.&quot;</span><span class="p">)</span>
        <span class="n">rundata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>
        <span class="n">inletdata</span> <span class="o">=</span> <span class="n">rundata</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">11</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">inlet</span> <span class="ow">in</span> <span class="n">inletdata</span><span class="p">:</span>
            <span class="n">nodenumber</span><span class="p">,</span> <span class="n">inletfile</span> <span class="o">=</span> <span class="n">inlet</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nodenumber</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="n">inletfile</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.LoadClotFile" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.LoadClotFile">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">LoadClotFile</span><span class="signature">(self, file)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">LoadClotFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading clot file.&quot;</span><span class="p">)</span>
        <span class="n">clotdata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">clotdata</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">])]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotdata</span><span class="p">]</span>
        <span class="n">Clotids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotdata</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">clotid</span> <span class="ow">in</span> <span class="n">Clotids</span><span class="p">:</span>
            <span class="n">clotnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotdata</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">clotid</span><span class="p">]</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotnodes</span><span class="p">]</span>
            <span class="n">par1</span> <span class="o">=</span> <span class="n">clotnodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">par2</span> <span class="o">=</span> <span class="n">clotnodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Clots</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">nodes</span><span class="p">,</span> <span class="n">par1</span><span class="p">,</span> <span class="n">par2</span><span class="p">])</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.LoadVTPFile" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.LoadVTPFile">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">LoadVTPFile</span><span class="signature">(self, vtpfile)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">LoadVTPFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vtpfile</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">vtpfile</span><span class="p">)</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">vtpfile</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

        <span class="n">pos_vtk</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetData</span><span class="p">()</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">pos_vtk</span><span class="p">)</span>

        <span class="n">VesselAtlas</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">vesselids</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">narray</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetNumberOfArrays</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">narray</span><span class="p">):</span>
            <span class="n">arrayname</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArrayName</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;MaximumInscribedSphereRadius&quot;</span> <span class="ow">or</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Radius&quot;</span><span class="p">:</span>
                <span class="n">radius_vtk</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Type&quot;</span><span class="p">:</span>
                <span class="c1">#  load in the vessel atlas</span>
                <span class="n">VesselAtlas</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="n">narray</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetNumberOfArrays</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">narray</span><span class="p">):</span>
            <span class="n">arrayname</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArrayName</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Vessel Ids&quot;</span><span class="p">:</span>
                <span class="c1">#  load in the vessel atlas</span>
                <span class="n">vesselids</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Major Vessel Ids&quot;</span><span class="p">:</span>
                <span class="c1">#  load in the vessel atlas</span>
                <span class="n">VesselAtlas</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="n">radius</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">radius_vtk</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)):</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">radius</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">node</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="n">NumberOfVessels</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetNumberOfCells</span><span class="p">()</span>
        <span class="n">vesselnodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NumberOfVessels</span><span class="p">):</span>
            <span class="n">numberofnodes</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCell</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">GetNumberOfPoints</span><span class="p">()</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCell</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">GetPointIds</span><span class="p">()</span>
            <span class="n">vesselnodes</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">ids</span><span class="o">.</span><span class="n">GetId</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numberofnodes</span><span class="p">)])</span>
            <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">SetVesselID</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vesselnodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="c1"># these include the bifurcations</span>

        <span class="c1"># Connections</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vesselnodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">currentnode</span> <span class="o">=</span> <span class="n">vessel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">neighbour</span> <span class="o">=</span> <span class="n">vessel</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">currentnode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">neighbour</span><span class="p">)</span>
                <span class="n">neighbour</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">currentnode</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">VesselAtlas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">VesselAtlas</span><span class="p">):</span>
                <span class="n">vessel</span> <span class="o">=</span> <span class="n">vesselnodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">=</span> <span class="nb">id</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">vesselids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vesselids</span><span class="p">):</span>
                <span class="n">vessel</span> <span class="o">=</span> <span class="n">vesselnodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">VesselID</span> <span class="o">=</span> <span class="nb">id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">FindBifurcationNodes</span><span class="p">()</span>

        <span class="c1"># extract bifurcations from the vessels</span>
        <span class="c1"># redefine nodes</span>
        <span class="n">bifurcations</span> <span class="o">=</span> <span class="p">[</span><span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">))]</span>
        <span class="p">[</span><span class="n">bifurcations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">))]</span>
        <span class="p">[</span><span class="n">bif</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">bifurcations</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vessel</span><span class="o">.</span><span class="n">Vessel</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vesselnodes</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vesselnodes</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="n">vessel</span>

        <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">InterpolateVessel3Dto1D</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">number</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vesselnodes</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">bifurcations</span><span class="p">[</span><span class="n">number</span><span class="p">]</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bifurcations</span><span class="p">[</span><span class="n">number</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">bifurcations</span><span class="p">[</span><span class="n">number</span><span class="p">]</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bifurcations</span><span class="p">[</span><span class="n">number</span><span class="p">])</span>

        <span class="p">[</span><span class="n">bifurcation</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">Radius</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bifurcation</span><span class="o">.</span><span class="n">Connections</span><span class="p">]))</span> <span class="k">for</span> <span class="n">bifurcation</span> <span class="ow">in</span> <span class="n">bifurcations</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="n">bifurcations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FindlargestInlets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CheckConnectivity</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateNodeType</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.Load1DAnatomy" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.Load1DAnatomy">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">Load1DAnatomy</span><span class="signature">(self, file)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">Load1DAnatomy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading anatomy from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">bfdata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>
        <span class="n">BifurcationsIndex</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;Bifurcations&quot;</span><span class="p">)</span>
        <span class="n">BCIndex</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;Boundary Nodes&quot;</span><span class="p">)</span>

        <span class="n">vessels</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">BifurcationsIndex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="n">bifurcations</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">[</span><span class="n">BifurcationsIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">BCIndex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="n">BC</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">[</span><span class="n">BCIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]]</span>

        <span class="c1"># remove zero length vessels from further processing</span>
        <span class="n">NoVessel</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vessels</span> <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vessel</span><span class="o">.</span><span class="n">Vessel</span><span class="p">()</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetID</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vessels</span><span class="p">)]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vessels</span><span class="p">)]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">GenerateVessel</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
                                            <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vessels</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateVesselAtlas</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateNumbers</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">bifurcationnode</span><span class="p">(</span><span class="n">info</span><span class="p">):</span>
            <span class="n">bifurcationnode</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
            <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">nodedata</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">bifurcationinfo</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">element</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">nodedata</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">NoVessel</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">NoIds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">NoVessel</span><span class="p">]</span>
                <span class="n">bifurcationinfo</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bifurcationinfo</span> <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NoIds</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bifurcationinfo</span><span class="p">:</span>
                <span class="n">vessel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span>  <span class="c1"># note that vessel ids start at 1</span>
                <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;o&quot;</span><span class="p">:</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="n">vessel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
                    <span class="n">link</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bifurcationnode</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
                    <span class="n">link</span> <span class="o">=</span> <span class="n">vessel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
                    <span class="n">link</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bifurcationnode</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>

            <span class="n">radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">Radius</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">Connections</span><span class="p">])</span>
            <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">bifurcationnode</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">bifurcationnode</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">bifurcations</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">bcnodes</span><span class="p">(</span><span class="n">info</span><span class="p">):</span>
            <span class="n">inlets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">outlets</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">inletdata</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">inletinfo</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">element</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">inletdata</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">NoVessel</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">NoIds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">NoVessel</span><span class="p">]</span>
                <span class="n">inletinfo</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">inletinfo</span> <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NoIds</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">inletinfo</span><span class="p">:</span>
                <span class="n">vessel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span>  <span class="c1"># note that vessel ids start at 1</span>
                <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;o&quot;</span><span class="p">:</span>
                    <span class="n">inlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
                    <span class="n">inlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="o">-</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                <span class="n">outletdata</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">outletinfo</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">element</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">outletdata</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">NoVessel</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">NoIds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">NoVessel</span><span class="p">]</span>
                    <span class="n">outletinfo</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">outletinfo</span> <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NoIds</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">outletinfo</span><span class="p">:</span>
                    <span class="n">vessel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span>  <span class="c1"># note that vessel ids start at 1</span>
                    <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;o&quot;</span><span class="p">:</span>
                        <span class="n">outlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
                        <span class="n">outlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">[</span><span class="o">-</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">inlets</span><span class="p">,</span> <span class="n">outlets</span>

        <span class="n">inletnodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">=</span> <span class="n">bcnodes</span><span class="p">(</span><span class="n">BC</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">inlet</span><span class="p">,</span> <span class="s2">&quot;Aorta.txt&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">inlet</span> <span class="ow">in</span> <span class="n">inletnodes</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">==</span> <span class="p">[])]</span>

        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberNodes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetThickness</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfNodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfVessels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CheckConnectivity</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateNodeType</span><span class="p">()</span>
        <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">UpdateNodeVesselID</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">CalculateMeanThickness</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">CalculateMeanRadius</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">SetType</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.NumberNodes" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.NumberNodes">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">NumberNodes</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">NumberNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Assigning numbers to the nodes.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">number</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="o">=</span> <span class="n">number</span>
                <span class="n">number</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.GetDownstreamVessels" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.GetDownstreamVessels">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">GetDownstreamVessels</span><span class="signature">(self, inputvessel)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">GetDownstreamVessels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputvessel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get upstream vessels and bifurcation nodes.</span>
<span class="sd">        Note that this follows the positive directon of the vessels.</span>
<span class="sd">        If vessels are excluded that should be included, check the direction of those vessels.</span>

<span class="sd">        The code finds the relevent bifucations and then checks which vessels are connected.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(&quot;Finding the upstream vessels.&quot;)</span>
        <span class="c1"># initiation</span>
        <span class="n">bifset</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bifurcations</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputvessel</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">vesselindex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span><span class="p">[</span><span class="n">inputvessel</span><span class="p">]</span>
            <span class="n">vessel</span> <span class="o">=</span> <span class="n">vesselindex</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vessel</span> <span class="o">=</span> <span class="n">inputvessel</span>
        <span class="c1"># the current vessel and the starting bifurcation</span>
        <span class="n">vesselend</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vesselend</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
                <span class="n">bifset</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>
                <span class="n">bifurcations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="n">gens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">gens</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">vessel</span><span class="p">])</span>
        <span class="n">alreadylisted</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="p">]</span>
        <span class="c1"># Continue until we have all upstream vessels</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">bifset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">connectedvessels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">bifurcationnode</span> <span class="ow">in</span> <span class="n">bifset</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                    <span class="n">connectedvessels</span> <span class="o">+=</span> <span class="p">[</span><span class="n">vessel</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
            <span class="n">nbifset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">connectedvessels</span><span class="p">:</span>
                <span class="n">ves</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ves</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="ow">and</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bifurcations</span><span class="p">:</span>
                        <span class="n">nbifset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                        <span class="n">bifurcations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">newgen</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">connectedvessels</span> <span class="k">if</span> <span class="n">vessel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">alreadylisted</span><span class="p">]</span>
            <span class="n">gens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newgen</span><span class="p">)</span>
            <span class="n">alreadylisted</span> <span class="o">+=</span> <span class="n">connectedvessels</span>
            <span class="n">bifset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nbifset</span><span class="p">)</span>

        <span class="c1"># only vessels that are connected with the first node should be included.</span>
        <span class="c1"># this ensures that we only get the upstream vessels</span>
        <span class="n">vessels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">vessels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">bifurcations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                <span class="p">[</span><span class="n">vessels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span> <span class="ow">and</span> <span class="n">vessel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">]</span>

        <span class="c1"># export the names of the upstream vessels</span>
        <span class="n">vesselnames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">match</span> <span class="o">==</span> <span class="n">vessel</span><span class="p">:</span>
                    <span class="n">vesselnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>

        <span class="c1"># reorder</span>
        <span class="n">sortedvessels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">vessels</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">sortedvessels</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">bifurcations</span><span class="p">),</span> <span class="n">vesselnames</span><span class="p">,</span> <span class="n">gens</span>
</pre></div>

        </details>

            <div class="docstring"><p>Get upstream vessels and bifurcation nodes.
Note that this follows the positive directon of the vessels.
If vessels are excluded that should be included, check the direction of those vessels.</p>

<p>The code finds the relevent bifucations and then checks which vessels are connected.</p>
</div>


                            </div>
                            <div id="Topology.ReorderGens" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.ReorderGens">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">ReorderGens</span><span class="signature">(self, gens)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">ReorderGens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gens</span><span class="p">):</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">generation</span> <span class="ow">in</span> <span class="n">gens</span><span class="p">:</span>
            <span class="n">lengthgen</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">generation</span><span class="p">:</span>
                <span class="n">v</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="n">ng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetDownstreamVessels</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
                <span class="n">lengthgen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ng</span><span class="p">))</span>
            <span class="n">ordering</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lengthgen</span><span class="p">)</span>

        <span class="n">newgens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">gen</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gens</span><span class="p">):</span>
            <span class="n">newgens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">ordering</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">gen</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">g</span><span class="p">)]))</span>
        <span class="k">return</span> <span class="n">newgens</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.DownStreamResistance" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.DownStreamResistance">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">DownStreamResistance</span><span class="signature">(self, inputvessel, visc, density)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">DownStreamResistance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputvessel</span><span class="p">,</span> <span class="n">visc</span><span class="p">,</span> <span class="n">density</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stdout</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">vessels</span><span class="p">,</span> <span class="n">bifurcations</span><span class="p">,</span> <span class="n">vesselnames</span><span class="p">,</span> <span class="n">gens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetDownstreamVessels</span><span class="p">(</span><span class="n">inputvessel</span><span class="p">)</span>

        <span class="n">C</span> <span class="o">=</span> <span class="n">gens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">C</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">gens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">R1</span> <span class="o">+</span> <span class="n">gens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">R2</span>
        <span class="n">gens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ResetWK</span><span class="p">()</span>

        <span class="n">vesselres</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">VesselResistance</span><span class="p">(</span><span class="n">visc</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">]</span>
        <span class="n">vesselres</span><span class="p">[</span><span class="n">vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">gens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># only get the downstream resistance</span>

        <span class="n">vesselcomp</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">VesselCompliance</span><span class="p">()</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">]</span>
        <span class="n">vesselcomp</span><span class="p">[</span><span class="n">vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">gens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># only get the downstream resistance</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gens</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">gens</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vesselmatch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">vesselmatch</span> <span class="o">==</span> <span class="n">vessel</span><span class="p">:</span>
                        <span class="n">vesselnames</span> <span class="o">=</span> <span class="n">vesselmatch</span><span class="o">.</span><span class="n">Name</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stdout</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                    <span class="n">vesselstemp</span><span class="p">,</span> <span class="n">bifurcationstemp</span><span class="p">,</span> <span class="n">vesselnamestemp</span><span class="p">,</span> <span class="n">genstemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetDownstreamVessels</span><span class="p">(</span><span class="n">vesselnames</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">genstemp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">downstreamres</span> <span class="o">=</span> <span class="p">[</span><span class="n">vesselres</span><span class="p">[</span><span class="n">vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vesselt</span><span class="p">)]</span> <span class="k">for</span> <span class="n">vesselt</span> <span class="ow">in</span> <span class="n">genstemp</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="n">vesselres</span><span class="p">[</span><span class="n">vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vessel</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sumresvessels</span><span class="p">(</span><span class="n">vesselres</span><span class="p">[</span><span class="n">vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vessel</span><span class="p">)],</span>
                                                                          <span class="n">downstreamres</span><span class="p">)</span>
                    <span class="c1"># vesselc = sum([vesselcomp[vessels.index(vesselt)] for vesselt in genstemp[1]])</span>
                    <span class="c1"># if vesselcomp[vessels.index(vessel)] &gt; 0:</span>
                    <span class="c1">#     vesselcomp[vessels.index(vessel)] = 1/(1/vesselc + 1/vesselcomp[vessels.index(vessel)])</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     vesselcomp[vessels.index(vessel)] = vesselc</span>

        <span class="n">outlets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                    <span class="n">outlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">rcubed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="mf">1e-3</span>
        <span class="n">RT</span> <span class="o">=</span> <span class="n">R</span> <span class="o">-</span> <span class="n">vesselres</span><span class="p">[</span><span class="n">vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">gens</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span>
        <span class="c1"># Ct = 1/(1/C - 1/vesselcomp[vessels.index(gens[0][0])])</span>
        <span class="k">if</span> <span class="n">RT</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found RT to be negative!?&quot;</span><span class="p">)</span>
            <span class="n">RT</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">R</span>
        <span class="c1"># RT = R</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resistance scaled: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RT</span> <span class="o">/</span> <span class="n">R</span><span class="p">))</span>
        <span class="c1"># print(&quot;Compliance scaled: %f&quot; % (Ct / C))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outlets</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">rcubed</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">C1D</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
            <span class="c1"># mean radius and thickness</span>
            <span class="n">lengthvessel</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Length</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">meanradius</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanRadius</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">meanh</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanThickness</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">C1D</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">meanradius</span> <span class="o">*</span> <span class="n">meanradius</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">lengthvessel</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">vessel</span><span class="o">.</span><span class="n">YoungsModules</span> <span class="o">*</span> <span class="n">meanh</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outlets</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">CalculateThickness</span><span class="p">()</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">rt</span> <span class="o">=</span> <span class="n">RT</span> <span class="o">*</span> <span class="n">rcubed</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="o">.</span><span class="n">YoungsModules</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="n">A</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">density</span><span class="p">)))</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="p">(</span><span class="n">density</span> <span class="o">/</span> <span class="n">A</span><span class="p">)</span> <span class="o">*</span> <span class="n">c0</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">rt</span> <span class="o">-</span> <span class="n">r1</span>
            <span class="k">if</span> <span class="n">r2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">r2</span> <span class="o">=</span> <span class="mf">0.1e9</span>
                <span class="n">r1</span> <span class="o">=</span> <span class="n">rt</span> <span class="o">-</span> <span class="n">r2</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">C</span> <span class="o">-</span> <span class="n">C1D</span><span class="p">)</span> <span class="o">*</span> <span class="n">RT</span> <span class="o">/</span> <span class="n">rt</span><span class="p">)</span>
            <span class="n">i</span><span class="o">.</span><span class="n">SetWK</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.sumresvessels" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.sumresvessels">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">sumresvessels</span><span class="signature">(self, upstream, downstream)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">sumresvessels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upstream</span><span class="p">,</span> <span class="n">downstream</span><span class="p">):</span>
        <span class="n">parallelvesselsres</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="o">/</span> <span class="n">vesselres</span> <span class="k">for</span> <span class="n">vesselres</span> <span class="ow">in</span> <span class="n">downstream</span><span class="p">])</span>
        <span class="n">serialvesselres</span> <span class="o">=</span> <span class="n">upstream</span>
        <span class="n">totalres</span> <span class="o">=</span> <span class="n">parallelvesselsres</span> <span class="o">+</span> <span class="n">serialvesselres</span>
        <span class="k">return</span> <span class="n">totalres</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.RedefineDirection" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.RedefineDirection">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">RedefineDirection</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">RedefineDirection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Redefining the direction of the vessels.&quot;</span><span class="p">)</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">inlet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">direction</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">vessel</span><span class="o">.</span><span class="n">GenerationNumber</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="n">inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vessel reversed.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">nodenumber</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">nodenumber</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span> <span class="o">-</span> <span class="n">nodenumber</span><span class="p">:</span>
                            <span class="c1"># self.Vessels[index].Nodes[nodenumber].Position, self.Vessels[index].Nodes[</span>
                            <span class="c1">#     -1 - nodenumber].Position = \</span>
                            <span class="c1">#     self.Vessels[index].Nodes[-1 - nodenumber].Position, self.Vessels[index].Nodes[</span>
                            <span class="c1">#         nodenumber].Position</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span>
                                <span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">=</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span>
                                    <span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span>
                    <span class="n">direction</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">inletvessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">inlet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">inletvessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span>

        <span class="n">bifs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">inves</span> <span class="ow">in</span> <span class="n">inletvessels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">inves</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
                    <span class="n">bifs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bif</span><span class="p">)</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">bifs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">newbifs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">bifs</span><span class="p">:</span>
                <span class="n">vessels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="k">if</span>
                           <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span> <span class="ow">or</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">]</span>
                <span class="n">vesselundef</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span> <span class="k">if</span> <span class="n">direction</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vesselundef</span><span class="p">:</span>
                    <span class="c1"># print(self.VesselAtlas[vessel])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                        <span class="n">direction</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vessel reversed.&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                        <span class="k">for</span> <span class="n">nodenumber</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">nodenumber</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span> <span class="o">-</span> <span class="n">nodenumber</span><span class="p">:</span>
                                <span class="c1"># self.Vessels[vessel].Nodes[nodenumber].Position, self.Vessels[vessel].Nodes[</span>
                                <span class="c1">#     -1 - nodenumber].Position = \</span>
                                <span class="c1">#     self.Vessels[vessel].Nodes[-1 - nodenumber].Position, self.Vessels[vessel].Nodes[</span>
                                <span class="c1">#         nodenumber].Position</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span>
                                    <span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">=</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">,</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span>
                                        <span class="n">nodenumber</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span>
                        <span class="n">direction</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

                    <span class="n">newcandidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">bift</span> <span class="k">for</span> <span class="n">bift</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">vessel</span><span class="p">]</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Connections</span> <span class="k">if</span>
                                     <span class="n">bift</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">newcandidates</span><span class="p">:</span>
                        <span class="n">newbifs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">newcandidates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">bifs</span> <span class="o">=</span> <span class="n">newbifs</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.GetVesselsFromType" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.GetVesselsFromType">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">GetVesselsFromType</span><span class="signature">(self, inputtype)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">GetVesselsFromType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputtype</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting all vessels of a type.&quot;</span><span class="p">)</span>
        <span class="c1"># return all vessels that are labelled with the input type</span>
        <span class="n">vessels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">inputtype</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">vessels</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.ReadNodesFromTopFile" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.ReadNodesFromTopFile">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">ReadNodesFromTopFile</span><span class="signature">(self, file)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">ReadNodesFromTopFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load nodes from topology file.&quot;</span><span class="p">)</span>
        <span class="n">bfdata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>
        <span class="n">bonds_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;Bonds:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">bonds_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>

        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetNodeFromTopLine</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bfdata</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">bonds_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])]</span>

        <span class="n">links</span> <span class="o">=</span> <span class="n">bfdata</span><span class="p">[</span><span class="n">bonds_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">bfdata</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="n">i</span><span class="p">])])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
             <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">link</span><span class="p">))]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.Read3DNodesFromTopFile" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.Read3DNodesFromTopFile">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">Read3DNodesFromTopFile</span><span class="signature">(self, file)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">Read3DNodesFromTopFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load nodes from topology file.&quot;</span><span class="p">)</span>
        <span class="n">bfdata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>
        <span class="n">bonds_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;Bonds:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bfdata</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">bonds_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bfdata</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">bonds_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetNumber</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">([</span><span class="mf">1e3</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">:]),</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">:]),</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">:])])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">2</span><span class="p">:]))</span>

        <span class="n">links</span> <span class="o">=</span> <span class="n">bfdata</span><span class="p">[</span><span class="n">bonds_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">bfdata</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="n">i</span><span class="p">])])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
             <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">link</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.LoadVesselAtlas" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.LoadVesselAtlas">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">LoadVesselAtlas</span><span class="signature">(self, file)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">LoadVesselAtlas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading vessel atlas from file.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">file</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">vesselatlas</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">vessel</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">]</span>
                <span class="n">vesselatlas</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vessel</span><span class="p">]</span>
                <span class="n">vesselnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vessel</span><span class="p">]</span>
                <span class="p">[</span><span class="n">vesselatlas</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vesselnames</span><span class="p">)]</span>

        <span class="c1"># vesselatlas = [i.strip(&#39;\n&#39;).split(&#39;\t&#39;) for i in open(file)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vessel</span><span class="o">.</span><span class="n">Vessel</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vesselatlas</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vesselatlas</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetID</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">nodenumbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nodenumbers</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetLength</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">,</span> <span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetGridSize</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">-</span> <span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetNodes</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">UpdateVessel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">CalculateMeanRadius</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">CalculateMeanThickness</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateVesselAtlas</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.SetInletNodes" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.SetInletNodes">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">SetInletNodes</span><span class="signature">(self, inlets)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">SetInletNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inlets</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting inlet nodes.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span> <span class="o">=</span> <span class="n">inlets</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.SetOutletNodes" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.SetOutletNodes">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">SetOutletNodes</span><span class="signature">(self, outlets)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">SetOutletNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outlets</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting outlet nodes.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">=</span> <span class="n">outlets</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.SetBifurcationNodes" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.SetBifurcationNodes">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">SetBifurcationNodes</span><span class="signature">(self, bifurcationnodes=None)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">SetBifurcationNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bifurcationnodes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting bifurcation nodes.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bifurcationnodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FindBifurcationNodes</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="n">bifurcationnodes</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.FindBifurcationNodes" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.FindBifurcationNodes">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">FindBifurcationNodes</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">FindBifurcationNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding the bifurcation nodes.&quot;</span><span class="p">)</span>
        <span class="n">bifurcationnodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">bifurcationnodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="n">bifurcationnodes</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.FindOutletNodes" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.FindOutletNodes">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">FindOutletNodes</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">FindOutletNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding the outlet nodes.&quot;</span><span class="p">)</span>
        <span class="n">InletNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">]</span>
        <span class="n">OutletsNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">InletNodes</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetOutletNodes</span><span class="p">(</span><span class="n">OutletsNodes</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.FindlargestInlets" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.FindlargestInlets">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">FindlargestInlets</span><span class="signature">(self, InletNumber=3)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">FindlargestInlets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">InletNumber</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding the largest </span><span class="si">%d</span><span class="s2"> inlets.&quot;</span> <span class="o">%</span> <span class="n">InletNumber</span><span class="p">)</span>
        <span class="c1"># InletNodes = [i.strip(&#39;\n&#39;).split(&#39;,&#39;) for i in open(inletfilename)]</span>
        <span class="n">Ends</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">InletNodes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Ends</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">Ends</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">inletnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;left_carotid_inlet.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;right_carotid_inlet.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;basilar.txt&quot;</span><span class="p">]</span>
        <span class="n">Inlets</span> <span class="o">=</span> <span class="p">[(</span><span class="n">Ends</span><span class="p">[</span><span class="n">line</span><span class="p">],</span> <span class="n">inletnames</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">InletNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">InletNumber</span><span class="p">]]</span>  <span class="c1"># Dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetInletNodes</span><span class="p">(</span><span class="n">Inlets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FindOutletNodes</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.ApplyTransformation" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.ApplyTransformation">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">ApplyTransformation</span><span class="signature">(self, matrix)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">ApplyTransformation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">Position</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>
            <span class="n">posnew</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">posnew</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.AnatomyToVessels" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.AnatomyToVessels">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">AnatomyToVessels</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">AnatomyToVessels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get vessels from topology data</span>
<span class="sd">        start at an end point</span>
<span class="sd">        get the neighbour, if connection of neighbour is 2 then get next neighbour and repeat.</span>
<span class="sd">        If connection is 1, stop. If connection is more than 2, stop and start new vessel.</span>
<span class="sd">        repeat for every end point, keep track of nodes that are already assigned to a vesse (except bif nodes)</span>
<span class="sd">        bifurcation nodes are nodes with more than 2 connections</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting vessels from topology data.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FindBifurcationNodes</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FindOutletNodes</span><span class="p">()</span>

        <span class="n">ProcessedNodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Note: gives an error is there are no vessel nodes</span>
        <span class="k">for</span> <span class="n">BifurcationNode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="c1"># check connected vessels</span>
            <span class="n">newvessels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">BifurcationNode</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">ProcessedNodes</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">newvessels</span><span class="p">:</span>
                <span class="n">vessel</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BifurcationNode</span><span class="p">)</span>
                <span class="n">ProcessedNodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BifurcationNode</span><span class="p">)</span>
                <span class="n">currentnode</span> <span class="o">=</span> <span class="n">node</span>
                <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">numberconnection</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">currentnode</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">numberconnection</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">vessel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentnode</span><span class="p">)</span>
                        <span class="n">ProcessedNodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentnode</span><span class="p">)</span>
                        <span class="n">currentnode</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">currentnode</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">vessel</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">numberconnection</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">vessel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentnode</span><span class="p">)</span>
                        <span class="n">ProcessedNodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentnode</span><span class="p">)</span>
                        <span class="n">vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vessel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentnode</span><span class="p">)</span>
                        <span class="n">ProcessedNodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentnode</span><span class="p">)</span>
                        <span class="n">vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
                        <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vessel</span><span class="o">.</span><span class="n">Vessel</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vessels</span><span class="p">))]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetNodes</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">elements</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vessels</span><span class="p">)]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span>
         <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateNodeType</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Get vessels from topology data
start at an end point
get the neighbour, if connection of neighbour is 2 then get next neighbour and repeat.
If connection is 1, stop. If connection is more than 2, stop and start new vessel.
repeat for every end point, keep track of nodes that are already assigned to a vesse (except bif nodes)
bifurcation nodes are nodes with more than 2 connections</p>
</div>


                            </div>
                            <div id="Topology.removebifurcation" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.removebifurcation">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">removebifurcation</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">removebifurcation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span>
            <span class="n">linked</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                        <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">node</span><span class="p">)]</span> <span class="o">=</span> <span class="n">bif</span>
                <span class="n">othernodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span>
                <span class="p">[</span><span class="n">linked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">othernodes</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">n</span> <span class="ow">is</span> <span class="n">bif</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">lastmostvesselend</span> <span class="ow">in</span> <span class="n">othernodes</span><span class="p">:</span>
                    <span class="n">lastmostvesselend</span><span class="o">.</span><span class="n">RemoveConnection</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">linked</span><span class="p">:</span>
                <span class="n">bif</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
                <span class="n">link</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bif</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.TopologyToVTP" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.TopologyToVTP">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">TopologyToVTP</span><span class="signature">(self, filename)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">TopologyToVTP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the network to a .vtp file.</span>
<span class="sd">        This only works with 3-D coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NumberNodes</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing topology to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPoints</span><span class="p">()</span>
        <span class="n">vessels</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellArray</span><span class="p">()</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>

        <span class="n">radius</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">radius</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Radius&quot;</span><span class="p">)</span>

        <span class="n">nodetype</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkIntArray</span><span class="p">()</span>
        <span class="n">nodetype</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Node Type &quot;</span><span class="p">)</span>

        <span class="c1"># Add radius and position to data array</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
            <span class="n">radius</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Radius</span><span class="p">))</span>
            <span class="n">nodetype</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>

        <span class="c1"># Add vessels to cell array</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkLine</span><span class="p">()</span>
            <span class="n">line</span><span class="o">.</span><span class="n">GetPointIds</span><span class="p">()</span><span class="o">.</span><span class="n">SetNumberOfIds</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)):</span>
                <span class="n">line</span><span class="o">.</span><span class="n">GetPointIds</span><span class="p">()</span><span class="o">.</span><span class="n">SetId</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
            <span class="n">vessels</span><span class="o">.</span><span class="n">InsertNextCell</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># Create a polydata to store everything in</span>
        <span class="n">VesselsPolyData</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">()</span>

        <span class="c1"># Add the nodes to the polydata</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">SetPoints</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

        <span class="c1"># Add the vessels to the polydata</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">SetLines</span><span class="p">(</span><span class="n">vessels</span><span class="p">)</span>

        <span class="c1"># Assign radii to the nodes</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">SetScalars</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">nodetype</span><span class="p">)</span>

        <span class="n">atlas</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkIntArray</span><span class="p">()</span>
        <span class="p">[</span><span class="n">atlas</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)]</span>
        <span class="n">atlas</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Vessel Ids&quot;</span><span class="p">)</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">atlas</span><span class="p">)</span>

        <span class="n">majoratlas</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkIntArray</span><span class="p">()</span>
        <span class="p">[</span><span class="n">majoratlas</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)]</span>
        <span class="n">majoratlas</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Major Vessel Ids&quot;</span><span class="p">)</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">majoratlas</span><span class="p">)</span>

        <span class="c1"># Save everyting in a vtp file</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">VesselsPolyData</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Write the network to a .vtp file.
This only works with 3-D coordinates.</p>
</div>


                            </div>
                            <div id="Topology.GetMapping" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.GetMapping">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">GetMapping</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">GetMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Vessel</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Vessel&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Vesselname&#39;</span><span class="p">,</span> <span class="s1">&#39;Numberofnodes&#39;</span><span class="p">,</span> <span class="s1">&#39;Startnode&#39;</span><span class="p">,</span> <span class="s1">&#39;Endnode&#39;</span><span class="p">])</span>
        <span class="n">vessellist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vessellist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Vessel</span><span class="p">(</span><span class="n">Vesselname</span><span class="o">=</span><span class="s1">&#39;System&#39;</span><span class="p">,</span>
                                     <span class="n">Numberofnodes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">),</span>
                                     <span class="n">Startnode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                     <span class="n">Endnode</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VesselAtlas</span><span class="p">):</span>
                <span class="n">vessellist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Vessel</span><span class="p">(</span><span class="n">Vesselname</span><span class="o">=</span><span class="n">vessel</span><span class="p">,</span>
                                         <span class="n">Numberofnodes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">]),</span>
                                         <span class="n">Startnode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span>
                                         <span class="n">Endnode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">vessellist</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.CalculateMaximumTimestep" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.CalculateMaximumTimestep">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">CalculateMaximumTimestep</span><span class="signature">(self, density)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">CalculateMaximumTimestep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">density</span><span class="p">):</span>
        <span class="n">wavespeed</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vessel</span><span class="o">.</span><span class="n">CalculateMaxWaveSpeed</span><span class="p">(</span><span class="n">density</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="n">gridsize</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">GridSize</span> <span class="o">*</span> <span class="mf">1e-3</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="n">CourantNumber</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">timestep</span> <span class="o">=</span> <span class="p">[</span><span class="n">CourantNumber</span> <span class="o">*</span> <span class="n">gridsize</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">speed</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">speed</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wavespeed</span><span class="p">)]</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">timestep</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Maximum timestep: </span><span class="si">%1.1e</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="n">dt</span><span class="p">)</span>
        <span class="c1"># newgridsize = [1e3 * speed * dt / CourantNumber for speed in wavespeed]  # minimum gridsize, there is no max</span>
        <span class="c1"># max gridsize is set by the vessel length and by the need for detail</span>
        <span class="k">return</span> <span class="n">dt</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.GetAdjacencyMatrix" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.GetAdjacencyMatrix">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">GetAdjacencyMatrix</span><span class="signature">(self, bloodvisc)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">GetAdjacencyMatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the adjacency matrix of the network</span>

<span class="sd">        :return: scipy sparse matrix, nodes in order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># for each vessel, get the bifurcations at the ends</span>
        <span class="c1"># then check at what parts of other vessels these bifurcations connect.</span>
        <span class="c1"># matrix = numpy.zeros((len(self.Vessels),len(self.Vessels)))</span>
        <span class="c1">#</span>
        <span class="c1"># for index, vessel in enumerate(self.Vessels):</span>
        <span class="c1">#     bif = vessel.GetDistalBifurcation()</span>
        <span class="c1">#     if not (bif is None):</span>
        <span class="c1">#         vesselsnumbers = bif.GetConnectedVesselIDs()</span>
        <span class="c1">#         vesselsnumbers.remove(vessel.ID)</span>
        <span class="c1">#         for number in vesselsnumbers:</span>
        <span class="c1">#             matrix[vessel.ID][number] = 1</span>
        <span class="c1">#</span>
        <span class="c1">#     bif = vessel.GetProximalBifurcation()</span>
        <span class="c1">#     if not (bif is None):</span>
        <span class="c1">#         vesselsnumbers = bif.GetConnectedVesselIDs()</span>
        <span class="c1">#         vesselsnumbers.remove(vessel.ID)</span>
        <span class="c1">#         for number in vesselsnumbers:</span>
        <span class="c1">#             matrix[vessel.ID][number] = -1</span>

        <span class="n">network</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="n">inlets</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">]</span>
        <span class="n">bifs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span>
        <span class="n">outlets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span>  <span class="c1"># vessel ends</span>
        <span class="n">newoutletnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">]</span>
        <span class="n">allnodes</span> <span class="o">=</span> <span class="n">inlets</span> <span class="o">+</span> <span class="n">bifs</span> <span class="o">+</span> <span class="n">outlets</span> <span class="o">+</span> <span class="n">newoutletnodes</span>

        <span class="n">network</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">allnodes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">GetVesselResistance</span><span class="p">(</span><span class="n">bloodvisc</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[[</span><span class="n">vessel</span><span class="o">.</span><span class="n">GetEndNodes</span><span class="p">(),</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Resistance</span><span class="p">]</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>

        <span class="n">outletedges</span> <span class="o">=</span> <span class="p">[[[</span><span class="n">node</span><span class="p">,</span> <span class="n">newoutletnodes</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">R1</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">R2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outlets</span><span class="p">)]</span>
        <span class="n">edges</span> <span class="o">+=</span> <span class="n">outletedges</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">network</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">length</span><span class="o">=</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">nodes</span><span class="p">()):</span>
            <span class="n">labels</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>

        <span class="c1"># import matplotlib.pylab as plt</span>
        <span class="c1"># pos = nx.spring_layout(network, weight=&#39;length&#39;)</span>
        <span class="c1"># nx.draw_networkx_nodes(network, pos)</span>
        <span class="c1"># nx.draw_networkx_edges(network, pos)</span>
        <span class="c1"># nx.draw_networkx_labels(network, pos, labels, font_size=16)</span>
        <span class="c1"># plt.show()</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">allnodes</span>
</pre></div>

        </details>

            <div class="docstring"><p>Get the adjacency matrix of the network</p>

<p>:return: scipy sparse matrix, nodes in order</p>
</div>


                            </div>
                            <div id="Topology.GetAdjacencyMatrix2" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.GetAdjacencyMatrix2">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">GetAdjacencyMatrix2</span><span class="signature">(self, bloodvisc)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">GetAdjacencyMatrix2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the adjacency matrix of the network</span>

<span class="sd">        :return: scipy sparse matrix, nodes in order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">network</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="n">inlets</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">]</span>
        <span class="n">bifs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span>
        <span class="n">outlets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span>  <span class="c1"># vessel ends</span>

        <span class="n">allnodes</span> <span class="o">=</span> <span class="n">inlets</span> <span class="o">+</span> <span class="n">bifs</span> <span class="o">+</span> <span class="n">outlets</span>

        <span class="n">network</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">allnodes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">GetVesselResistance</span><span class="p">(</span><span class="n">bloodvisc</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[[</span><span class="n">vessel</span><span class="o">.</span><span class="n">GetEndNodes</span><span class="p">(),</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Resistance</span><span class="p">]</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">network</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">length</span><span class="o">=</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">nodes</span><span class="p">()):</span>
            <span class="n">labels</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>

        <span class="c1"># import matplotlib.pylab as plt</span>
        <span class="c1"># pos = nx.spring_layout(network, weight=&#39;length&#39;)</span>
        <span class="c1"># nx.draw_networkx_nodes(network, pos)</span>
        <span class="c1"># nx.draw_networkx_edges(network, pos)</span>
        <span class="c1"># nx.draw_networkx_labels(network, pos, labels, font_size=16)</span>
        <span class="c1"># plt.show()</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">allnodes</span>
</pre></div>

        </details>

            <div class="docstring"><p>Get the adjacency matrix of the network</p>

<p>:return: scipy sparse matrix, nodes in order</p>
</div>


                            </div>
                            <div id="Topology.GetVesselResistance" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.GetVesselResistance">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">GetVesselResistance</span><span class="signature">(self, bloodvisc)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">GetVesselResistance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">):</span>
        <span class="n">resistance</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">VesselResistance</span><span class="p">(</span><span class="n">bloodvisc</span><span class="p">)</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">resistance</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.SegmentConductance" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.SegmentConductance">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">SegmentConductance</span><span class="signature">(self, node1, node2, bloodvisc, frictionconstant=22)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">SegmentConductance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="o">=</span><span class="mi">22</span><span class="p">):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">node1</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">-</span> <span class="n">node2</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">GeneralFunctions</span><span class="o">.</span><span class="n">distancebetweenpoints</span><span class="p">(</span><span class="n">node1</span><span class="o">.</span><span class="n">Position</span><span class="p">,</span> <span class="n">node2</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>

        <span class="c1"># a = node1.Radius</span>
        <span class="c1"># b = (node2.Radius - node1.Radius) / length</span>
        <span class="c1"># radiusint = scipy.integrate.quad(lambda l: 1 / scipy.power(a + b * l, 4), 0, length)</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="p">(</span><span class="n">node1</span><span class="o">.</span><span class="n">Radius</span> <span class="o">+</span> <span class="n">node2</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">frictionconstant</span><span class="p">):</span>
            <span class="n">friction</span> <span class="o">=</span> <span class="n">frictionconstant</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
            <span class="k">return</span> <span class="mf">1e-9</span> <span class="o">*</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">friction</span> <span class="o">*</span> <span class="n">bloodvisc</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1e-9</span> <span class="o">*</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">frictionconstant</span> <span class="o">*</span> <span class="n">bloodvisc</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span>

        <span class="c1"># G = 1e-9 * (numpy.pi * numpy.power(radius, 4)) / (fictionconstant * bloodvisc * length)</span>
        <span class="c1"># # G = 1e-9 * (numpy.pi * numpy.power(radius, 4)) / (8 * bloodvisc * length)</span>
        <span class="c1"># return G</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.TopologyToGraph" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.TopologyToGraph">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">TopologyToGraph</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">TopologyToGraph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">network</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)):</span>
                <span class="n">network</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                 <span class="n">weight</span><span class="o">=</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">-</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                <span class="n">network</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">bif</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Graph</span> <span class="o">=</span> <span class="n">network</span>

        <span class="c1"># pos = nx.spring_layout(network)</span>
        <span class="c1"># nx.draw(network, pos)</span>
        <span class="c1"># plt.show()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.Get1DsteadyNetwork" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.Get1DsteadyNetwork">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">Get1DsteadyNetwork</span><span class="signature">(
    self,
    bloodvisc,
    clotactive=False,
    PressureInlets=False,
    coarseCollaterals=False,
    FlowRateOutlets=False,
    frictionconstant=22
)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">Get1DsteadyNetwork</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">,</span> <span class="n">clotactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">PressureInlets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">coarseCollaterals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">FlowRateOutlets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="o">=</span><span class="mi">22</span><span class="p">):</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># bloodvisc = patient.ModelParameters[&quot;BLOOD_VISC&quot;]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)):</span>
                <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                              <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">SegmentConductance</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bloodvisc</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="o">=</span><span class="n">frictionconstant</span><span class="p">)])</span>

        <span class="c1"># generate more nodes for the wk elements</span>
        <span class="n">newoutlets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># newcounter = self.NumberOfNodes</span>
        <span class="k">for</span> <span class="n">outlet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">outlet</span><span class="o">.</span><span class="n">R1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">g</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">outlet</span><span class="o">.</span><span class="n">R1</span> <span class="o">+</span> <span class="n">outlet</span><span class="o">.</span><span class="n">R2</span><span class="p">)</span>
                <span class="n">wknode</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                <span class="n">wknode</span><span class="o">.</span><span class="n">OutPressure</span> <span class="o">=</span> <span class="n">outlet</span><span class="o">.</span><span class="n">OutPressure</span>
                <span class="n">wknode</span><span class="o">.</span><span class="n">OutletFlowRate</span> <span class="o">=</span> <span class="n">outlet</span><span class="o">.</span><span class="n">OutletFlowRate</span>
                <span class="c1"># wknode.InputPressure = wknode.OutPressure</span>
                <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">outlet</span><span class="p">,</span> <span class="n">wknode</span><span class="p">,</span> <span class="n">g</span><span class="p">])</span>
                <span class="c1"># outlet.AddConnection(wknode)</span>
                <span class="n">wknode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">outlet</span><span class="p">)</span>
                <span class="n">newoutlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wknode</span><span class="p">)</span>

                <span class="n">outlet</span><span class="o">.</span><span class="n">WKNode</span> <span class="o">=</span> <span class="n">wknode</span>  <span class="c1"># for collaterals</span>
                <span class="n">wknode</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">outlet</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>  <span class="c1"># for collaterals</span>
                <span class="n">wknode</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">outlet</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
                <span class="c1"># newcounter += 1</span>
                <span class="c1"># wknode.SetNumber(newcounter)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newoutlets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outlet</span><span class="p">)</span>
        <span class="n">OutletNodes</span> <span class="o">=</span> <span class="n">newoutlets</span>

        <span class="c1"># collaterals</span>
        <span class="n">collateralEdges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># coarseCollaterals = False</span>
        <span class="k">if</span> <span class="n">coarseCollaterals</span><span class="p">:</span>  <span class="c1"># collateral model</span>
            <span class="c1"># add conductance between wknodes of outlets according to collaterals</span>
            <span class="c1"># connections between MCA and PCA/ACA for now</span>
            <span class="c1"># scaling = 1e-12 # guess value? resistance per mm?</span>
            <span class="c1"># n = 0.01  # number</span>
            <span class="c1"># effectiveradius = 0.2  # mm</span>
            <span class="c1"># 1e-9 * (numpy.pi * numpy.power(radius, 4)) / (friction * bloodvisc * length)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_collaterals_number</span>
            <span class="n">effectiveradius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_collaterals_effective_radius</span>
            <span class="n">distance_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_collaterals_threshold</span>

            <span class="c1"># basically 1mm? (assume properties are uniform, like a thin sheet)</span>
            <span class="n">scaling</span> <span class="o">=</span> <span class="mf">1e-9</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">effectiveradius</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">frictionconstant</span> <span class="o">*</span> <span class="n">bloodvisc</span><span class="p">)</span>
            <span class="c1"># print(f&quot;\tScaling factor: {scaling}&quot;)</span>

            <span class="c1"># based on previous found connections</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">othernode</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">connected_cp</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="o">&lt;</span> <span class="n">othernode</span><span class="o">.</span><span class="n">Number</span><span class="p">:</span>  <span class="c1"># prevent duplicates</span>
                        <span class="n">collateral_conductance</span> <span class="o">=</span> <span class="n">scaling</span>
                        <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">WKNode</span><span class="p">,</span> <span class="n">othernode</span><span class="o">.</span><span class="n">WKNode</span><span class="p">,</span> <span class="n">collateral_conductance</span><span class="p">])</span>
                        <span class="n">collateralEdges</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">WKNode</span><span class="p">,</span> <span class="n">othernode</span><span class="o">.</span><span class="n">WKNode</span><span class="p">,</span> <span class="n">collateral_conductance</span><span class="p">])</span>

            <span class="c1"># Identify outlets within distance x</span>
            <span class="c1"># for node in self.OutletNodes:</span>
            <span class="c1">#     if node.MajorVesselID == 2 or node.MajorVesselID == 3 or node.MajorVesselID == 6:  # R SIDE</span>
            <span class="c1">#         othernodes = [othernode for othernode in self.OutletNodes if</span>
            <span class="c1">#                       othernode.MajorVesselID == 2 or othernode.MajorVesselID == 3 or othernode.MajorVesselID == 6]</span>
            <span class="c1">#     elif node.MajorVesselID == 4 or node.MajorVesselID == 5 or node.MajorVesselID == 7:  # L SIDE</span>
            <span class="c1">#         othernodes = [othernode for othernode in self.OutletNodes if</span>
            <span class="c1">#                       othernode.MajorVesselID == 4 or othernode.MajorVesselID == 5 or othernode.MajorVesselID == 7]</span>
            <span class="c1">#     else:</span>
            <span class="c1">#         othernodes = []</span>
            <span class="c1">#     for othernode in othernodes:</span>
            <span class="c1">#</span>
            <span class="c1">#         if self.coarse_collaterals_After_WKNodes:</span>
            <span class="c1">#             if node.Number &lt; othernode.Number:  # prevent duplicates</span>
            <span class="c1">#                 distance = GeneralFunctions.distancebetweenpoints(node.WKNode.Position, othernode.WKNode.Position)</span>
            <span class="c1">#                 # collateral_conductance = scaling/distance</span>
            <span class="c1">#                 if distance &lt; distance_threshold:</span>
            <span class="c1">#                     collateral_conductance = scaling</span>
            <span class="c1">#                     edges.append([node.WKNode, othernode.WKNode, collateral_conductance])</span>
            <span class="c1">#                     collateralEdges.append([node.WKNode, othernode.WKNode, collateral_conductance])</span>
            <span class="c1">#         else:</span>
            <span class="c1">#             if node.Number &lt; othernode.Number:  # prevent duplicates</span>
            <span class="c1">#                 distance = GeneralFunctions.distancebetweenpoints(node.Position, othernode.Position)</span>
            <span class="c1">#                 # collateral_conductance = scaling/distance</span>
            <span class="c1">#                 if distance &lt; distance_threshold:</span>
            <span class="c1">#                     collateral_conductance = scaling</span>
            <span class="c1">#                     edges.append([node, othernode, collateral_conductance])</span>
            <span class="c1">#                     collateralEdges.append([node, othernode, collateral_conductance])</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Collateral vessels: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">collateralEdges</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Collaterals</span> <span class="o">=</span> <span class="n">collateralEdges</span>

        <span class="c1"># modelling clots</span>
        <span class="c1"># we can simply update the edges</span>
        <span class="c1"># set global parameter ClotActive to true</span>
        <span class="c1"># set conductance to zero.</span>
        <span class="c1"># find edge in list of edges, set conductance to zero</span>
        <span class="k">if</span> <span class="n">clotactive</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">clot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Clots</span><span class="p">:</span>
                <span class="n">clotnodes</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># for _ in enumerate(clotnodes[:-1]):</span>
                <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">clotnodes</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">clotnodes</span><span class="p">):</span>
                        <span class="n">node1</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">node2</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                        <span class="n">length</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">node1</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">-</span> <span class="n">node2</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">length</span> <span class="o">=</span> <span class="n">GeneralFunctions</span><span class="o">.</span><span class="n">distancebetweenpoints</span><span class="p">(</span><span class="n">node1</span><span class="o">.</span><span class="n">Position</span><span class="p">,</span> <span class="n">node2</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>

                        <span class="n">permeability</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="c1"># porocity = clot[2]</span>

                        <span class="c1"># permeable, darcy&#39;s law, units m^2 (range (1.0  1e-17) to (1.0  1e-7)?</span>
                        <span class="c1"># input units are mm^2 -&gt; multiply with 1e-6</span>
                        <span class="n">area</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">node1</span><span class="o">.</span><span class="n">RefRadius</span> <span class="o">+</span> <span class="n">node2</span><span class="o">.</span><span class="n">RefRadius</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>
                        <span class="n">G</span> <span class="o">=</span> <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">permeability</span> <span class="o">*</span> <span class="n">area</span><span class="o">/</span><span class="p">(</span><span class="n">bloodvisc</span> <span class="o">*</span> <span class="n">length</span><span class="p">)</span>
                        <span class="c1"># todo should we account for segment resistance as well?</span>
                        <span class="n">node1</span><span class="o">.</span><span class="n">Radius</span> <span class="o">=</span> <span class="n">node1</span><span class="o">.</span><span class="n">RefRadius</span>
                        <span class="n">node2</span><span class="o">.</span><span class="n">Radius</span> <span class="o">=</span> <span class="n">node2</span><span class="o">.</span><span class="n">RefRadius</span>
                        <span class="n">segmentConduction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SegmentConductance</span><span class="p">(</span><span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="o">=</span><span class="n">frictionconstant</span><span class="p">)</span>
                        <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">G</span> <span class="o">+</span> <span class="mf">1e-32</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">segmentConduction</span><span class="p">)</span>


                        <span class="c1"># if porocity == 0 and permeability == 0:</span>
                        <span class="c1">#     edge[2] = 1e-32  # zero</span>
                        <span class="c1"># elif permeability == 0:</span>
                        <span class="c1">#     # void fraction, stenosis</span>
                        <span class="c1">#     radius = numpy.sqrt(porocity) * (node1.RefRadius + node2.RefRadius) / 2</span>
                        <span class="c1">#     G = 1e-9 * (numpy.pi * numpy.power(radius, 4)) / (frictionconstant * bloodvisc * length)</span>
                        <span class="c1">#     edge[2] = G + 1e-32</span>
                        <span class="c1">#     node1.Radius = node1.RefRadius*numpy.sqrt(porocity)</span>
                        <span class="c1">#     node2.Radius = node2.RefRadius*numpy.sqrt(porocity)</span>
                        <span class="c1">#</span>
                        <span class="c1"># elif porocity == 0:</span>
                        <span class="c1">#     # permeable, darcy&#39;s law, units m^2 (range (1.0  1e-17) to (1.0  1e-7)?</span>
                        <span class="c1">#     # input units are mm^2 -&gt; multiply with 1e-6</span>
                        <span class="c1">#     area = numpy.power((node1.RefRadius + node2.RefRadius) / 2, 2) * numpy.pi</span>
                        <span class="c1">#     G = 1e-9 * permeability * area/(bloodvisc * length)</span>
                        <span class="c1">#     edge[2] = G + 1e-32</span>
                        <span class="c1"># else:</span>
                        <span class="c1">#     print(&quot;Error in clot.&quot;)</span>

                        <span class="c1"># scale radius (porocity = void fraction = stenosis?)</span>
                        <span class="c1"># radius = clot[1] * (node1.RefRadius + node2.RefRadius) / 2</span>
                        <span class="c1"># G = 1e-9 * (numpy.pi * numpy.power(radius, 4)) / (22 * bloodvisc * length)</span>
                        <span class="c1"># edge[2] = G + 1e-32</span>

                        <span class="c1"># scale conductance</span>
                        <span class="c1"># radius = (node1.RefRadius + node2.RefRadius) / 2</span>
                        <span class="c1"># G = 1e-9 * (numpy.pi * numpy.power(radius, 4)) / (22 * bloodvisc * length)</span>
                        <span class="c1"># edge[2] = G * clot[1] + 1e-32</span>

                        <span class="c1"># edge[2] = edge[2] * clot[1] + 1e-32  # 0.001 # Non-zero for permeable clots! value is defined in Clots.txt</span>
                        <span class="c1"># error if exactly zero</span>

            <span class="c1"># remove edges if both nodes are clot nodes.</span>
            <span class="c1"># clotnodes = [node for clot in self.Clots for node in clot[0]]</span>
            <span class="c1"># edges = [x for x in edges if not (x[0] in clotnodes and x[1] in clotnodes)]</span>

        <span class="n">duplicatenodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationDict</span><span class="p">()</span>
        <span class="n">nodestoreplace1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nodestoreplace2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">oldnodes1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">oldnodes2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">edge</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edges</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">duplicatenodes</span><span class="p">:</span>
                <span class="n">nodestoreplace1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="n">duplicatenodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
                <span class="n">oldnodes1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">duplicatenodes</span><span class="p">:</span>
                <span class="n">nodestoreplace2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="n">duplicatenodes</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>
                <span class="n">oldnodes2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">replace</span> <span class="ow">in</span> <span class="n">nodestoreplace1</span><span class="p">:</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">replace</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">replace</span> <span class="ow">in</span> <span class="n">nodestoreplace2</span><span class="p">:</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">replace</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">nodeset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">nodeset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">nodeset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">nodesetlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nodeset</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodesetlist</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">ssindex</span> <span class="o">=</span> <span class="n">index</span>

        <span class="n">mtx</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">lil_matrix</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">nodesetlist</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodesetlist</span><span class="p">)))</span>

        <span class="k">def</span> <span class="nf">updatemat</span><span class="p">(</span><span class="n">edge</span><span class="p">):</span>
            <span class="n">index1</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ssindex</span>
            <span class="n">index2</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ssindex</span>
            <span class="n">mtx</span><span class="p">[</span><span class="n">index1</span><span class="p">,</span> <span class="n">index2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">mtx</span><span class="p">[</span><span class="n">index2</span><span class="p">,</span> <span class="n">index1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">with</span> <span class="n">Pool</span><span class="p">()</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">updatemat</span><span class="p">,</span> <span class="n">edges</span><span class="p">)</span>

        <span class="n">rowsum</span> <span class="o">=</span> <span class="n">mtx</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodesetlist</span><span class="p">)):</span>
            <span class="n">mtx</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">rowsum</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="c1"># inputvector = scipy.sparse.lil_matrix((len(nodesetlist), 1))</span>
        <span class="n">inputvector</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">nodesetlist</span><span class="p">),))</span>

        <span class="c1"># outlet flowrates</span>
        <span class="k">if</span> <span class="n">FlowRateOutlets</span><span class="p">:</span>
            <span class="c1"># for outlet in OutletNodes:</span>
            <span class="c1">#     inputvector[outlet.ssindex] = outlet.OutPressure</span>
            <span class="c1">#     index1 = outlet.ssindex</span>
            <span class="c1">#     inputvector[next(iter(outlet.Connections)).ssindex] = outlet.OutletFlowRate  # flowrate at that wk node</span>
            <span class="c1">#     mtx[index1, next(iter(outlet.Connections)).ssindex] = 0</span>
            <span class="c1">#     mtx[index1, index1] = 1</span>
            <span class="k">for</span> <span class="n">outlet</span> <span class="ow">in</span> <span class="n">OutletNodes</span><span class="p">:</span>
                <span class="n">inputvector</span><span class="p">[</span><span class="n">outlet</span><span class="o">.</span><span class="n">ssindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">outlet</span><span class="o">.</span><span class="n">OutletFlowRate</span>  <span class="c1"># flowrate at that wk node</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># pressure at that wk node, outpressure</span>
            <span class="k">for</span> <span class="n">outlet</span> <span class="ow">in</span> <span class="n">OutletNodes</span><span class="p">:</span>
                <span class="n">inputvector</span><span class="p">[</span><span class="n">outlet</span><span class="o">.</span><span class="n">ssindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">outlet</span><span class="o">.</span><span class="n">OutPressure</span>
                <span class="n">index1</span> <span class="o">=</span> <span class="n">outlet</span><span class="o">.</span><span class="n">ssindex</span>
                <span class="n">mtx</span><span class="p">[</span><span class="n">index1</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">outlet</span><span class="o">.</span><span class="n">Connections</span><span class="p">))</span><span class="o">.</span><span class="n">ssindex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">mtx</span><span class="p">[</span><span class="n">index1</span><span class="p">,</span> <span class="n">index1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># if using pressure at the inlet:</span>
        <span class="k">if</span> <span class="n">PressureInlets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">inletnode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">:</span>
                <span class="n">inputvector</span><span class="p">[</span><span class="n">inletnode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ssindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">inletnode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">InletPressure</span>  <span class="c1"># standard units Pa</span>
                <span class="n">index1</span> <span class="o">=</span> <span class="n">inletnode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ssindex</span>
                <span class="n">mtx</span><span class="p">[</span><span class="n">index1</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">inletnode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Connections</span><span class="p">))</span><span class="o">.</span><span class="n">ssindex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">mtx</span><span class="p">[</span><span class="n">index1</span><span class="p">,</span> <span class="n">index1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># inlet flowrates</span>
            <span class="k">for</span> <span class="n">inletnode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">:</span>
                <span class="n">inputvector</span><span class="p">[</span><span class="n">inletnode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ssindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">inletnode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">InletFlowRate</span>  <span class="c1"># standard units m^3/s</span>

        <span class="k">return</span> <span class="n">mtx</span><span class="o">.</span><span class="n">tocsc</span><span class="p">(),</span> <span class="n">inputvector</span><span class="p">,</span> <span class="n">nodesetlist</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="p">(</span><span class="n">oldnodes1</span><span class="p">,</span> <span class="n">oldnodes2</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.addCollateralsToTopology" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.addCollateralsToTopology">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">addCollateralsToTopology</span><span class="signature">(self, filename)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">addCollateralsToTopology</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">vesselslist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Collaterals</span><span class="p">:</span>
            <span class="n">vessel</span> <span class="o">=</span> <span class="n">Vessel</span><span class="o">.</span><span class="n">Vessel</span><span class="p">()</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">SetNodes</span><span class="p">([</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="c1"># vessel.SetType(5)</span>
            <span class="c1"># vesselid = self.Vessels[-1].ID+1</span>
            <span class="c1"># vessel.SetID(vesselid)</span>
            <span class="n">vesselslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
        <span class="c1"># for edge in self.Collaterals:</span>
        <span class="c1">#     vessel = Vessel.Vessel()</span>
        <span class="c1">#     vessel.SetNodes([edge[0], edge[1]])</span>
        <span class="c1">#     vessel.SetType(5)</span>
        <span class="c1">#     vesselid = self.Vessels[-1].ID+1</span>
        <span class="c1">#     vessel.SetID(vesselid)</span>
        <span class="c1">#     self.Vessels.append(vessel)</span>
        <span class="c1"># self.UpdateTopology()</span>
        <span class="n">nodelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vesselslist</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>

        <span class="n">nodes</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPoints</span><span class="p">()</span>
        <span class="n">vessels</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkCellArray</span><span class="p">()</span>
        <span class="c1"># radius = vtk.vtkFloatArray()</span>
        <span class="c1">#</span>
        <span class="c1"># radius.SetNumberOfComponents(1)</span>
        <span class="c1"># radius.SetName(&quot;Radius&quot;)</span>
        <span class="c1">#</span>
        <span class="c1"># nodetype = vtk.vtkIntArray()</span>
        <span class="c1"># nodetype.SetName(&quot;Node Type &quot;)</span>

        <span class="c1"># Add radius and position to data array</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodelist</span><span class="p">):</span>
            <span class="n">i</span><span class="o">.</span><span class="n">Number</span> <span class="o">=</span> <span class="n">index</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">InsertNextPoint</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
            <span class="c1"># radius.InsertNextValue(float(i.Radius))</span>
            <span class="c1"># nodetype.InsertNextValue(i.Type)</span>

        <span class="c1"># Add vessels to cell array</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vesselslist</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkLine</span><span class="p">()</span>
            <span class="n">line</span><span class="o">.</span><span class="n">GetPointIds</span><span class="p">()</span><span class="o">.</span><span class="n">SetNumberOfIds</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)):</span>
                <span class="n">line</span><span class="o">.</span><span class="n">GetPointIds</span><span class="p">()</span><span class="o">.</span><span class="n">SetId</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
            <span class="n">vessels</span><span class="o">.</span><span class="n">InsertNextCell</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># Create a polydata to store everything in</span>
        <span class="n">VesselsPolyData</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPolyData</span><span class="p">()</span>

        <span class="c1"># Add the nodes to the polydata</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">SetPoints</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

        <span class="c1"># Add the vessels to the polydata</span>
        <span class="n">VesselsPolyData</span><span class="o">.</span><span class="n">SetLines</span><span class="p">(</span><span class="n">vessels</span><span class="p">)</span>

        <span class="c1"># Assign radii to the nodes</span>
        <span class="c1"># VesselsPolyData.GetPointData().SetScalars(radius)</span>
        <span class="c1"># VesselsPolyData.GetPointData().AddArray(nodetype)</span>

        <span class="c1"># atlas = vtk.vtkIntArray()</span>
        <span class="c1"># [atlas.InsertNextValue(i.ID) for index, i in enumerate(self.Vessels)]</span>
        <span class="c1"># atlas.SetName(&quot;Vessel Ids&quot;)</span>
        <span class="c1"># VesselsPolyData.GetCellData().AddArray(atlas)</span>
        <span class="c1">#</span>
        <span class="c1"># majoratlas = vtk.vtkIntArray()</span>
        <span class="c1"># [majoratlas.InsertNextValue(i.MajorVesselID) for index, i in enumerate(self.Vessels)]</span>
        <span class="c1"># majoratlas.SetName(&quot;Major Vessel Ids&quot;)</span>
        <span class="c1"># VesselsPolyData.GetCellData().AddArray(majoratlas)</span>

        <span class="c1"># Save everyting in a vtp file</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">VesselsPolyData</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.SteadyStateNonLinear" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.SteadyStateNonLinear">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">SteadyStateNonLinear</span><span class="signature">(self, bloodvisc, density, clotactive=False, PressureInlets=False)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">SteadyStateNonLinear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">clotactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">PressureInlets</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">conductancematrix</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Get1DsteadyNetwork</span><span class="p">(</span><span class="n">bloodvisc</span><span class="p">,</span> <span class="n">clotactive</span><span class="p">,</span>
                                                                                    <span class="n">PressureInlets</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodes</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Number</span> <span class="o">=</span> <span class="n">index</span>

        <span class="n">vesselbifnodes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span> <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># todo get indices of bifurcation vessel nodes and update resisuals. There is an error relating to the numbering of the nodes.</span>
        <span class="c1"># The matrix has to be updated to handle this system.</span>

        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">pressures</span><span class="p">):</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="n">conductancematrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pressures</span><span class="p">)</span> <span class="o">-</span> <span class="n">sources</span>
            <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">vesselbifnodes</span><span class="p">:</span>
                <span class="c1"># flow = sum([(pressures[node.Number]-pressures[node.NearestVesselNode.Number])*conductancematrix[node.Number,node.NearestVesselNode.Number] for node in bif])</span>

                <span class="n">residuals</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> \
                                           <span class="n">conductancematrix</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bif</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                    <span class="n">residuals</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> \
                                                <span class="n">conductancematrix</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>
                    <span class="n">velocity</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> <span class="n">conductancematrix</span><span class="p">[</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">node</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">node</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                    <span class="n">bernoulli</span> <span class="o">=</span> <span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">density</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">velocity</span> <span class="o">*</span> <span class="n">velocity</span>
                    <span class="n">velocity2</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span>
                        <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> <span class="n">conductancematrix</span><span class="p">[</span>
                                    <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
                                        <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                    <span class="n">bernoulli2</span> <span class="o">=</span> <span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">density</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">velocity2</span> <span class="o">*</span> <span class="n">velocity2</span>
                    <span class="n">residuals</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="n">bernoulli</span> <span class="o">-</span> <span class="n">bernoulli2</span>

            <span class="k">return</span> <span class="n">residuals</span>

        <span class="c1"># guess = func(numpy.zeros((nodeslength,)))</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="mi">10000</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">))</span>
        <span class="c1"># guess = []</span>
        <span class="c1"># for vessel in self.Vessels:</span>
        <span class="c1">#     for node in vessel.Nodes:</span>
        <span class="c1">#         guess.append(node.Pressure)</span>
        <span class="c1">#</span>

        <span class="n">solution</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">fsolve</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Topology.nonlinearmodel" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Topology.nonlinearmodel">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">nonlinearmodel</span><span class="signature">(self, bloodvisc, density)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">nonlinearmodel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bloodvisc</span><span class="p">,</span> <span class="n">density</span><span class="p">):</span>
        <span class="c1"># for each vessel node, create a list of conservation of flow</span>
        <span class="c1"># use the matrix from the linear model but with the bifurcations removed</span>

        <span class="c1"># we can use the same code for most</span>
        <span class="c1"># be sure to subtract the input vector and only return the pressure of the correct nodes</span>

        <span class="c1"># the matrix is fine for the linear parts</span>
        <span class="c1"># use matrix notation for the nonlinear parts as well</span>
        <span class="c1"># code needs to be fast in the future.</span>

        <span class="c1"># matrix for the linear system with removed bifurcations replacement</span>
        <span class="c1"># return residuals for the vessel nodes inc outlets and inlets</span>

        <span class="c1"># calculate the velocity at the bifurcation node</span>
        <span class="c1"># calcualte the residuals for the bifurcations</span>

        <span class="c1"># probably better to use a loop</span>
        <span class="c1"># make a list of edges to store the connectivity information</span>
        <span class="c1"># loop over bifurcations, inlet and outlets.</span>

        <span class="c1"># store a list of information about which node the pressure belongs to</span>
        <span class="n">nodeslength</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">)</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[:</span><span class="n">nodeslength</span><span class="p">]</span>
        <span class="c1"># assumption is that the pressure input is in the same order as the nodes</span>

        <span class="n">conductancematrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nodeslength</span><span class="p">,</span> <span class="n">nodeslength</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="c1"># first and last nodes</span>
            <span class="n">conductancematrix</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">SegmentConductance</span><span class="p">(</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">bloodvisc</span><span class="p">)</span>

            <span class="n">conductancematrix</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">SegmentConductance</span><span class="p">(</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">bloodvisc</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">conductancematrix</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">SegmentConductance</span><span class="p">(</span>
                    <span class="n">node</span><span class="p">,</span>
                    <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
                    <span class="n">bloodvisc</span><span class="p">)</span>
                <span class="n">conductancematrix</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">SegmentConductance</span><span class="p">(</span>
                    <span class="n">node</span><span class="p">,</span>
                    <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span>
                    <span class="n">bloodvisc</span><span class="p">)</span>

        <span class="n">rowsum</span> <span class="o">=</span> <span class="n">conductancematrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)):</span>
            <span class="n">conductancematrix</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">rowsum</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="c1"># add the conductance from the WK outlets</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">outlet</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">):</span>
            <span class="n">conductancematrix</span><span class="p">[</span><span class="n">outlet</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">outlet</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">outlet</span><span class="o">.</span><span class="n">R1</span> <span class="o">+</span> <span class="n">outlet</span><span class="o">.</span><span class="n">R2</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># add the vesselnodes that connect to vesselbifurcationnodes for easy access.</span>
        <span class="n">vesselbifnodes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">)</span> <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">]</span>

        <span class="n">sources</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nodeslength</span><span class="p">,))</span>

        <span class="c1"># inlets</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">inlet</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">):</span>
            <span class="n">sources</span><span class="p">[</span><span class="n">inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="n">inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">InletFlowRate</span>

        <span class="c1"># outlets</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">outlet</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">):</span>
            <span class="n">sources</span><span class="p">[</span><span class="n">outlet</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="n">outlet</span><span class="o">.</span><span class="n">OutPressure</span> <span class="o">/</span> <span class="p">(</span><span class="n">outlet</span><span class="o">.</span><span class="n">R1</span> <span class="o">+</span> <span class="n">outlet</span><span class="o">.</span><span class="n">R2</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">pressures</span><span class="p">):</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="n">conductancematrix</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pressures</span><span class="p">)</span> <span class="o">-</span> <span class="n">sources</span>
            <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="n">vesselbifnodes</span><span class="p">:</span>
                <span class="c1"># flow = sum([(pressures[node.Number]-pressures[node.NearestVesselNode.Number])*conductancematrix[node.Number,node.NearestVesselNode.Number] for node in bif])</span>
                <span class="n">residuals</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> \
                                           <span class="n">conductancematrix</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bif</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                    <span class="n">residuals</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> \
                                                <span class="n">conductancematrix</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>
                    <span class="n">velocity</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> <span class="n">conductancematrix</span><span class="p">[</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">node</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">node</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                    <span class="n">bernoulli</span> <span class="o">=</span> <span class="n">pressures</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">density</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">velocity</span> <span class="o">*</span> <span class="n">velocity</span>
                    <span class="n">velocity2</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">-</span> <span class="n">pressures</span><span class="p">[</span>
                        <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">])</span> <span class="o">*</span> <span class="n">conductancematrix</span><span class="p">[</span>
                                    <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">,</span> <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">NearestVesselNode</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
                                        <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                    <span class="n">bernoulli2</span> <span class="o">=</span> <span class="n">pressures</span><span class="p">[</span><span class="n">bif</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">density</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">velocity2</span> <span class="o">*</span> <span class="n">velocity2</span>
                    <span class="n">residuals</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="n">bernoulli</span> <span class="o">-</span> <span class="n">bernoulli2</span>

            <span class="k">return</span> <span class="n">residuals</span>

        <span class="c1"># guess = func(numpy.zeros((nodeslength,)))</span>
        <span class="c1"># guess = [node.Pressure for vessel in self.Vessels for node in vessel.Nodes]</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                <span class="n">guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Pressure</span><span class="p">)</span>
        <span class="c1">#</span>

        <span class="n">solution</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">fsolve</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">guess</span><span class="p">)</span>  <span class="c1"># ,full_output=True)</span>
        <span class="c1"># print(solution[1])</span>
        <span class="c1"># solution = scipy.linalg.solve(conductancematrix, sources)</span>
        <span class="k">return</span> <span class="n">solution</span><span class="p">,</span> <span class="n">nodes</span>
</pre></div>

        </details>

    

                            </div>
                </section>
                <section id="Tree">
                                <div class="attr class">
        <a class="headerlink" href="#Tree">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Tree</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Tree</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object that defines the bifurcating trees.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfGenerations</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="sd">&quot;&quot;&quot;Number of vessel generations&quot;&quot;&quot;</span>
        <span class="n">node</span><span class="o">.</span><span class="n">SetDirectionVector</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Direction</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">DirectionVector</span><span class="p">]</span>
        <span class="sd">&quot;&quot;&quot;Direction of the bifurcating tree&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span> <span class="o">=</span> <span class="n">node</span>
        <span class="sd">&quot;&quot;&quot;Root node of the tree&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">StartingTreeNodes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;First node of the tree (bifurcation node)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EndNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>
        <span class="sd">&quot;&quot;&quot;Outlets of the tree&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;All nodes&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;Tree vessels&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;Bifurcation nodes&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LengthRadiusRatio</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="sd">&quot;&quot;&quot;Length to radius ratio&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">GenerateTree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a bifurcating tree at the endnodes of the tree.</span>
<span class="sd">        Vessels are added until a cut-off radius.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cutoff : float</span>
<span class="sd">            Cut-off radius to stop the adding of vessels at the end of the tree.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Newendnodes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">endnode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">EndNodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">endnode</span><span class="o">.</span><span class="n">Radius</span> <span class="o">&gt;</span> <span class="n">cutoff</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfGenerations</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># calculate node properties</span>
                    <span class="n">r1</span> <span class="o">=</span> <span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">murraylaw</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                    <span class="n">r2</span> <span class="o">=</span> <span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">murraylaw</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                    <span class="n">l1</span> <span class="o">=</span> <span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">RadiusToLength</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
                    <span class="n">l2</span> <span class="o">=</span> <span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">RadiusToLength</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>

                    <span class="n">direction</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">endnode</span><span class="o">.</span><span class="n">DirectionVector</span><span class="p">]</span>

                    <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">theta</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">angle</span>
                    <span class="n">theta2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">angle</span>

                    <span class="n">posvec</span> <span class="o">=</span> <span class="p">[</span><span class="n">l1</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>
                              <span class="n">l1</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>
                              <span class="mi">0</span><span class="p">]</span>
                    <span class="n">posvec2</span> <span class="o">=</span> <span class="p">[</span><span class="n">l2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta2</span><span class="p">),</span>
                               <span class="n">l2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta2</span><span class="p">),</span>
                               <span class="mi">0</span><span class="p">]</span>

                    <span class="n">pos1end</span> <span class="o">=</span> <span class="p">[</span><span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">posvec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">posvec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">posvec</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                    <span class="n">pos2end</span> <span class="o">=</span> <span class="p">[</span><span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">posvec2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">posvec2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">posvec2</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

                    <span class="n">pos1mid</span> <span class="o">=</span> <span class="p">[</span><span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">posvec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">posvec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">posvec</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                    <span class="n">pos2mid</span> <span class="o">=</span> <span class="p">[</span><span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">posvec2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">posvec2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">posvec2</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

                    <span class="c1"># create new nodes</span>
                    <span class="n">bifurcationnode</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                    <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
                    <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>

                    <span class="n">vessel1node1</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                    <span class="n">vessel1node1</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
                    <span class="n">vessel1node1</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">vessel1node1</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
                    <span class="n">vessel1node1</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>
                    <span class="n">vessel1node2</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                    <span class="n">vessel1node2</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">pos1mid</span><span class="p">)</span>
                    <span class="n">vessel1node2</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">l1</span><span class="p">)</span>
                    <span class="n">vessel1node2</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
                    <span class="n">vessel1node2</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>
                    <span class="n">vessel1node3</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                    <span class="n">vessel1node3</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">pos1end</span><span class="p">)</span>
                    <span class="n">vessel1node3</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="n">l1</span><span class="p">)</span>
                    <span class="n">vessel1node3</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
                    <span class="n">vessel1node3</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>

                    <span class="n">vessel2node1</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                    <span class="n">vessel2node1</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
                    <span class="n">vessel2node1</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">vessel2node1</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                    <span class="n">vessel2node1</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>
                    <span class="n">vessel2node2</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                    <span class="n">vessel2node2</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">pos2mid</span><span class="p">)</span>
                    <span class="n">vessel2node2</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">l2</span><span class="p">)</span>
                    <span class="n">vessel2node2</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                    <span class="n">vessel2node2</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>
                    <span class="n">vessel2node3</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                    <span class="n">vessel2node3</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">pos2end</span><span class="p">)</span>
                    <span class="n">vessel2node3</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="n">l2</span><span class="p">)</span>
                    <span class="n">vessel2node3</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                    <span class="n">vessel2node3</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>

                    <span class="n">vessel1</span> <span class="o">=</span> <span class="n">Vessel</span><span class="o">.</span><span class="n">Vessel</span><span class="p">()</span>
                    <span class="n">vessel1</span><span class="o">.</span><span class="n">SetType</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">vessel2</span> <span class="o">=</span> <span class="n">Vessel</span><span class="o">.</span><span class="n">Vessel</span><span class="p">()</span>
                    <span class="n">vessel2</span><span class="o">.</span><span class="n">SetType</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">vessel1</span><span class="o">.</span><span class="n">SetNodes</span><span class="p">([</span><span class="n">vessel1node1</span><span class="p">,</span> <span class="n">vessel1node2</span><span class="p">,</span> <span class="n">vessel1node3</span><span class="p">])</span>
                    <span class="n">vessel2</span><span class="o">.</span><span class="n">SetNodes</span><span class="p">([</span><span class="n">vessel2node1</span><span class="p">,</span> <span class="n">vessel2node2</span><span class="p">,</span> <span class="n">vessel2node3</span><span class="p">])</span>

                    <span class="n">vessel1</span><span class="o">.</span><span class="n">SetLength</span><span class="p">(</span><span class="n">l1</span><span class="p">)</span>
                    <span class="n">vessel2</span><span class="o">.</span><span class="n">SetLength</span><span class="p">(</span><span class="n">l2</span><span class="p">)</span>
                    <span class="n">vessel1</span><span class="o">.</span><span class="n">SetMeanRadius</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
                    <span class="n">vessel2</span><span class="o">.</span><span class="n">SetMeanRadius</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                    <span class="c1"># vessel1.SetGridSize(0.5 * l1)</span>
                    <span class="c1"># vessel2.SetGridSize(0.5 * l2)</span>
                    <span class="n">vessel1</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>
                    <span class="n">vessel2</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>
                    <span class="c1"># Set connections</span>
                    <span class="c1"># do not add them to the main topology for now</span>
                    <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel1node1</span><span class="p">)</span>
                    <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel2node1</span><span class="p">)</span>

                    <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">((</span><span class="n">r1</span> <span class="o">+</span> <span class="n">endnode</span><span class="o">.</span><span class="n">Radius</span> <span class="o">+</span> <span class="n">r2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>

                    <span class="n">vessel1node1</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bifurcationnode</span><span class="p">)</span>
                    <span class="n">vessel1node1</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel1node2</span><span class="p">)</span>
                    <span class="n">vessel1node2</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel1node1</span><span class="p">)</span>
                    <span class="n">vessel1node2</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel1node3</span><span class="p">)</span>
                    <span class="n">vessel1node3</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel1node2</span><span class="p">)</span>

                    <span class="n">vessel2node1</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bifurcationnode</span><span class="p">)</span>
                    <span class="n">vessel2node1</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel2node2</span><span class="p">)</span>
                    <span class="n">vessel2node2</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel2node1</span><span class="p">)</span>
                    <span class="n">vessel2node2</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel2node3</span><span class="p">)</span>
                    <span class="n">vessel2node3</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel2node2</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfGenerations</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">endnode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bifurcationnode</span><span class="p">)</span>
                        <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">endnode</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">StartingTreeNodes</span> <span class="o">=</span> <span class="n">bifurcationnode</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bifurcationnode</span><span class="p">)</span>
                    <span class="n">Newendnodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel1node3</span><span class="p">)</span>
                    <span class="n">Newendnodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel2node3</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel2</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bifurcationnode</span><span class="p">)</span>

                    <span class="c1"># self.Nodes.append(vessel1node1)</span>
                    <span class="c1"># self.Nodes.append(vessel1node2)</span>
                    <span class="c1"># self.Nodes.append(vessel1node3)</span>
                    <span class="c1"># self.Nodes.append(vessel2node1)</span>
                    <span class="c1"># self.Nodes.append(vessel2node2)</span>
                    <span class="c1"># self.Nodes.append(vessel2node3)</span>
                    <span class="n">vessel1node3</span><span class="o">.</span><span class="n">SetDirectionVector</span><span class="p">()</span>
                    <span class="n">vessel2node3</span><span class="o">.</span><span class="n">SetDirectionVector</span><span class="p">()</span>
                    <span class="n">numbernodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">vessel1</span><span class="o">.</span><span class="n">Length</span> <span class="o">/</span> <span class="n">vessel1</span><span class="o">.</span><span class="n">GridSize</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">vessel1</span><span class="o">.</span><span class="n">UpdateResolution</span><span class="p">(</span><span class="n">numbernodes</span><span class="p">)</span>
                    <span class="n">numbernodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">vessel2</span><span class="o">.</span><span class="n">Length</span> <span class="o">/</span> <span class="n">vessel2</span><span class="o">.</span><span class="n">GridSize</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">vessel2</span><span class="o">.</span><span class="n">UpdateResolution</span><span class="p">(</span><span class="n">numbernodes</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel1</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel2</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Newendnodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">EndNodes</span> <span class="o">=</span> <span class="n">Newendnodes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfGenerations</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># rotation to match the direction of the original vessel</span>

        <span class="n">Vo</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Direction</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Direction</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Direction</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">Vn</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Direction</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Direction</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">Vcross</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">Vn</span><span class="p">,</span> <span class="n">Vo</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Vn</span><span class="p">,</span> <span class="n">Vo</span><span class="p">)</span>
        <span class="n">Vx</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">Vcross</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Vcross</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
              <span class="p">[</span><span class="n">Vcross</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">Vcross</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
              <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">Vcross</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Vcross</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]]</span>

        <span class="n">R</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">Vx</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Vx</span><span class="p">,</span> <span class="n">Vx</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">C</span><span class="p">))</span>
        <span class="n">Rnew</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">Rnew</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span>

        <span class="n">Translate1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="n">Translate2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>

        <span class="n">TMatrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Translate2</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Rnew</span><span class="p">,</span> <span class="n">Translate1</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">Position</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">TMatrix</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>
            <span class="n">posnew</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">posnew</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ConnectTree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the neccessary connections between the inital node and the first node of the tree.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">StartingTreeNodes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">StartingTreeNodes</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Object that defines the bifurcating trees.</p>
</div>


                            <div id="Tree.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Tree.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Tree</span><span class="signature">(node)</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfGenerations</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="sd">&quot;&quot;&quot;Number of vessel generations&quot;&quot;&quot;</span>
        <span class="n">node</span><span class="o">.</span><span class="n">SetDirectionVector</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Direction</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">DirectionVector</span><span class="p">]</span>
        <span class="sd">&quot;&quot;&quot;Direction of the bifurcating tree&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span> <span class="o">=</span> <span class="n">node</span>
        <span class="sd">&quot;&quot;&quot;Root node of the tree&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">StartingTreeNodes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;First node of the tree (bifurcation node)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EndNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>
        <span class="sd">&quot;&quot;&quot;Outlets of the tree&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;All nodes&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;Tree vessels&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;Bifurcation nodes&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LengthRadiusRatio</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="sd">&quot;&quot;&quot;Length to radius ratio&quot;&quot;&quot;</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Tree.NumberOfGenerations" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Tree.NumberOfGenerations">#&nbsp;&nbsp</a>

        <span class="name">NumberOfGenerations</span>
    </div>

            <div class="docstring"><p>Number of vessel generations</p>
</div>


                            </div>
                            <div id="Tree.Direction" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Tree.Direction">#&nbsp;&nbsp</a>

        <span class="name">Direction</span>
    </div>

            <div class="docstring"><p>Direction of the bifurcating tree</p>
</div>


                            </div>
                            <div id="Tree.InitialNode" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Tree.InitialNode">#&nbsp;&nbsp</a>

        <span class="name">InitialNode</span>
    </div>

            <div class="docstring"><p>Root node of the tree</p>
</div>


                            </div>
                            <div id="Tree.StartingTreeNodes" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Tree.StartingTreeNodes">#&nbsp;&nbsp</a>

        <span class="name">StartingTreeNodes</span>
    </div>

            <div class="docstring"><p>First node of the tree (bifurcation node)</p>
</div>


                            </div>
                            <div id="Tree.EndNodes" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Tree.EndNodes">#&nbsp;&nbsp</a>

        <span class="name">EndNodes</span>
    </div>

            <div class="docstring"><p>Outlets of the tree</p>
</div>


                            </div>
                            <div id="Tree.Nodes" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Tree.Nodes">#&nbsp;&nbsp</a>

        <span class="name">Nodes</span>
    </div>

            <div class="docstring"><p>All nodes</p>
</div>


                            </div>
                            <div id="Tree.Vessels" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Tree.Vessels">#&nbsp;&nbsp</a>

        <span class="name">Vessels</span>
    </div>

            <div class="docstring"><p>Tree vessels</p>
</div>


                            </div>
                            <div id="Tree.BifurcationNodes" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Tree.BifurcationNodes">#&nbsp;&nbsp</a>

        <span class="name">BifurcationNodes</span>
    </div>

            <div class="docstring"><p>Bifurcation nodes</p>
</div>


                            </div>
                            <div id="Tree.LengthRadiusRatio" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Tree.LengthRadiusRatio">#&nbsp;&nbsp</a>

        <span class="name">LengthRadiusRatio</span>
    </div>

            <div class="docstring"><p>Length to radius ratio</p>
</div>


                            </div>
                            <div id="Tree.GenerateTree" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Tree.GenerateTree">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">GenerateTree</span><span class="signature">(self, cutoff)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">GenerateTree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a bifurcating tree at the endnodes of the tree.</span>
<span class="sd">        Vessels are added until a cut-off radius.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cutoff : float</span>
<span class="sd">            Cut-off radius to stop the adding of vessels at the end of the tree.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Newendnodes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">endnode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">EndNodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">endnode</span><span class="o">.</span><span class="n">Radius</span> <span class="o">&gt;</span> <span class="n">cutoff</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfGenerations</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># calculate node properties</span>
                    <span class="n">r1</span> <span class="o">=</span> <span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">murraylaw</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                    <span class="n">r2</span> <span class="o">=</span> <span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">murraylaw</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                    <span class="n">l1</span> <span class="o">=</span> <span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">RadiusToLength</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
                    <span class="n">l2</span> <span class="o">=</span> <span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">RadiusToLength</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>

                    <span class="n">direction</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">endnode</span><span class="o">.</span><span class="n">DirectionVector</span><span class="p">]</span>

                    <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">theta</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">angle</span>
                    <span class="n">theta2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">angle</span>

                    <span class="n">posvec</span> <span class="o">=</span> <span class="p">[</span><span class="n">l1</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>
                              <span class="n">l1</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>
                              <span class="mi">0</span><span class="p">]</span>
                    <span class="n">posvec2</span> <span class="o">=</span> <span class="p">[</span><span class="n">l2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta2</span><span class="p">),</span>
                               <span class="n">l2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta2</span><span class="p">),</span>
                               <span class="mi">0</span><span class="p">]</span>

                    <span class="n">pos1end</span> <span class="o">=</span> <span class="p">[</span><span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">posvec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">posvec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">posvec</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                    <span class="n">pos2end</span> <span class="o">=</span> <span class="p">[</span><span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">posvec2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">posvec2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">posvec2</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

                    <span class="n">pos1mid</span> <span class="o">=</span> <span class="p">[</span><span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">posvec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">posvec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">posvec</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                    <span class="n">pos2mid</span> <span class="o">=</span> <span class="p">[</span><span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">posvec2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">posvec2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">posvec2</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

                    <span class="c1"># create new nodes</span>
                    <span class="n">bifurcationnode</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                    <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
                    <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>

                    <span class="n">vessel1node1</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                    <span class="n">vessel1node1</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
                    <span class="n">vessel1node1</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">vessel1node1</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
                    <span class="n">vessel1node1</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>
                    <span class="n">vessel1node2</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                    <span class="n">vessel1node2</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">pos1mid</span><span class="p">)</span>
                    <span class="n">vessel1node2</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">l1</span><span class="p">)</span>
                    <span class="n">vessel1node2</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
                    <span class="n">vessel1node2</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>
                    <span class="n">vessel1node3</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                    <span class="n">vessel1node3</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">pos1end</span><span class="p">)</span>
                    <span class="n">vessel1node3</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="n">l1</span><span class="p">)</span>
                    <span class="n">vessel1node3</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
                    <span class="n">vessel1node3</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>

                    <span class="n">vessel2node1</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                    <span class="n">vessel2node1</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
                    <span class="n">vessel2node1</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">vessel2node1</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                    <span class="n">vessel2node1</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>
                    <span class="n">vessel2node2</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                    <span class="n">vessel2node2</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">pos2mid</span><span class="p">)</span>
                    <span class="n">vessel2node2</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">l2</span><span class="p">)</span>
                    <span class="n">vessel2node2</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                    <span class="n">vessel2node2</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>
                    <span class="n">vessel2node3</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
                    <span class="n">vessel2node3</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">pos2end</span><span class="p">)</span>
                    <span class="n">vessel2node3</span><span class="o">.</span><span class="n">SetLengthAlongVessel</span><span class="p">(</span><span class="n">l2</span><span class="p">)</span>
                    <span class="n">vessel2node3</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                    <span class="n">vessel2node3</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>

                    <span class="n">vessel1</span> <span class="o">=</span> <span class="n">Vessel</span><span class="o">.</span><span class="n">Vessel</span><span class="p">()</span>
                    <span class="n">vessel1</span><span class="o">.</span><span class="n">SetType</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">vessel2</span> <span class="o">=</span> <span class="n">Vessel</span><span class="o">.</span><span class="n">Vessel</span><span class="p">()</span>
                    <span class="n">vessel2</span><span class="o">.</span><span class="n">SetType</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">vessel1</span><span class="o">.</span><span class="n">SetNodes</span><span class="p">([</span><span class="n">vessel1node1</span><span class="p">,</span> <span class="n">vessel1node2</span><span class="p">,</span> <span class="n">vessel1node3</span><span class="p">])</span>
                    <span class="n">vessel2</span><span class="o">.</span><span class="n">SetNodes</span><span class="p">([</span><span class="n">vessel2node1</span><span class="p">,</span> <span class="n">vessel2node2</span><span class="p">,</span> <span class="n">vessel2node3</span><span class="p">])</span>

                    <span class="n">vessel1</span><span class="o">.</span><span class="n">SetLength</span><span class="p">(</span><span class="n">l1</span><span class="p">)</span>
                    <span class="n">vessel2</span><span class="o">.</span><span class="n">SetLength</span><span class="p">(</span><span class="n">l2</span><span class="p">)</span>
                    <span class="n">vessel1</span><span class="o">.</span><span class="n">SetMeanRadius</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
                    <span class="n">vessel2</span><span class="o">.</span><span class="n">SetMeanRadius</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
                    <span class="c1"># vessel1.SetGridSize(0.5 * l1)</span>
                    <span class="c1"># vessel2.SetGridSize(0.5 * l2)</span>
                    <span class="n">vessel1</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>
                    <span class="n">vessel2</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">endnode</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>
                    <span class="c1"># Set connections</span>
                    <span class="c1"># do not add them to the main topology for now</span>
                    <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel1node1</span><span class="p">)</span>
                    <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel2node1</span><span class="p">)</span>

                    <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">SetRadius</span><span class="p">((</span><span class="n">r1</span> <span class="o">+</span> <span class="n">endnode</span><span class="o">.</span><span class="n">Radius</span> <span class="o">+</span> <span class="n">r2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>

                    <span class="n">vessel1node1</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bifurcationnode</span><span class="p">)</span>
                    <span class="n">vessel1node1</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel1node2</span><span class="p">)</span>
                    <span class="n">vessel1node2</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel1node1</span><span class="p">)</span>
                    <span class="n">vessel1node2</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel1node3</span><span class="p">)</span>
                    <span class="n">vessel1node3</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel1node2</span><span class="p">)</span>

                    <span class="n">vessel2node1</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bifurcationnode</span><span class="p">)</span>
                    <span class="n">vessel2node1</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel2node2</span><span class="p">)</span>
                    <span class="n">vessel2node2</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel2node1</span><span class="p">)</span>
                    <span class="n">vessel2node2</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel2node3</span><span class="p">)</span>
                    <span class="n">vessel2node3</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">vessel2node2</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfGenerations</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">endnode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">bifurcationnode</span><span class="p">)</span>
                        <span class="n">bifurcationnode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="n">endnode</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">StartingTreeNodes</span> <span class="o">=</span> <span class="n">bifurcationnode</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bifurcationnode</span><span class="p">)</span>
                    <span class="n">Newendnodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel1node3</span><span class="p">)</span>
                    <span class="n">Newendnodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel2node3</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Vessels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel2</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bifurcationnode</span><span class="p">)</span>

                    <span class="c1"># self.Nodes.append(vessel1node1)</span>
                    <span class="c1"># self.Nodes.append(vessel1node2)</span>
                    <span class="c1"># self.Nodes.append(vessel1node3)</span>
                    <span class="c1"># self.Nodes.append(vessel2node1)</span>
                    <span class="c1"># self.Nodes.append(vessel2node2)</span>
                    <span class="c1"># self.Nodes.append(vessel2node3)</span>
                    <span class="n">vessel1node3</span><span class="o">.</span><span class="n">SetDirectionVector</span><span class="p">()</span>
                    <span class="n">vessel2node3</span><span class="o">.</span><span class="n">SetDirectionVector</span><span class="p">()</span>
                    <span class="n">numbernodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">vessel1</span><span class="o">.</span><span class="n">Length</span> <span class="o">/</span> <span class="n">vessel1</span><span class="o">.</span><span class="n">GridSize</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">vessel1</span><span class="o">.</span><span class="n">UpdateResolution</span><span class="p">(</span><span class="n">numbernodes</span><span class="p">)</span>
                    <span class="n">numbernodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">vessel2</span><span class="o">.</span><span class="n">Length</span> <span class="o">/</span> <span class="n">vessel2</span><span class="o">.</span><span class="n">GridSize</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">vessel2</span><span class="o">.</span><span class="n">UpdateResolution</span><span class="p">(</span><span class="n">numbernodes</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel1</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel2</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Newendnodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">EndNodes</span> <span class="o">=</span> <span class="n">Newendnodes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NumberOfGenerations</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># rotation to match the direction of the original vessel</span>

        <span class="n">Vo</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Direction</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Direction</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Direction</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">Vn</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Direction</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Direction</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">Vcross</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">Vn</span><span class="p">,</span> <span class="n">Vo</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Vn</span><span class="p">,</span> <span class="n">Vo</span><span class="p">)</span>
        <span class="n">Vx</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">Vcross</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Vcross</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
              <span class="p">[</span><span class="n">Vcross</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">Vcross</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
              <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">Vcross</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Vcross</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]]</span>

        <span class="n">R</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">Vx</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Vx</span><span class="p">,</span> <span class="n">Vx</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">C</span><span class="p">))</span>
        <span class="n">Rnew</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">Rnew</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span>

        <span class="n">Translate1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="n">Translate2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="o">.</span><span class="n">Position</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>

        <span class="n">TMatrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Translate2</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Rnew</span><span class="p">,</span> <span class="n">Translate1</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">Position</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">TMatrix</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>
            <span class="n">posnew</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">posnew</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Generate a bifurcating tree at the endnodes of the tree.
Vessels are added until a cut-off radius.</p>

<h2 id="parameters">Parameters</h2>

<p>cutoff : float
    Cut-off radius to stop the adding of vessels at the end of the tree.</p>
</div>


                            </div>
                            <div id="Tree.ConnectTree" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Tree.ConnectTree">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">ConnectTree</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">ConnectTree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the neccessary connections between the inital node and the first node of the tree.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">StartingTreeNodes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">StartingTreeNodes</span><span class="o">.</span><span class="n">AddConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">InitialNode</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Add the neccessary connections between the inital node and the first node of the tree.</p>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">(${doc.parameters.join(", ")})</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>