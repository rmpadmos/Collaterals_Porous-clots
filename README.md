# Module contents
"Blood_Flow_1D" contains the python code.
"DataFiles" contains input files needed to run the models.
"Documentation" contains the documentation.
"eventmodule" contains the submodule eventmodule, needed to run an in silico trial.
"Generated_Patients" contains some examples of patient simulations.
"Pulsatile_Model" contains the source code of the pulsatile blood flow model.

# Documentation
Code documentation: ```Documentation/index.html```
List of inout and output files: ```Documentation/Input-Output Files list.xlsx```
List of model parameters: ```Documentation/Model_parameters.xlsx```

# 1D Blood Flow
The 1-D blood flow model generates a patient from patient-specific data, literature values and high-resolution data from volunteers.

# Installation
Installing required python modules (using conda env)

Create an environment.
```conda create -n 1d-blood-flow python=3.9```

Activate the environment.
```conda activate 1d-blood-flow```

Install the blood flow module.
```pip install ./```

Compile the BF Solver in the Pulsatile_Model folder by running msbuild or using monodevelop.
```msbuild "Pulsatile_Model/Blood Flow Model.sln"```

The executable location is located in Pulsatile_Model/Blood Flow Model/bin/Debug/
(If necessary, run ```chmod +x BloodflowModel.exe```)

# Running the model
Run a bunch of examples with:
```./run_examples.sh```

Remember to run the code from within the conda env.
##	Generating simulation files
(see input files for required files)

In the script folder, run GenerateBloodflowFiles.py with patient folder location.
The example patient in Generated_Patients/patient_0/ contains a generated patient ready for the BF solver.
```python3 Blood_Flow_1D/GenerateBloodflowFiles.py Generated_Patients/patient_0/```

##	Blood flow simulations
Two models can be used to simulate blood flow.

Run BloodFlowSimulator.py with executable location, patient folder location, and an boolean argument whether the clot should be included.
Note that the Blood_flow_1D folder location is needed by the bf solver and is listed in Model_parameters.txt. The location is updated during the patient generation but can be different if the patient is generated on other machines.

```python3 Blood_Flow_1D/BloodFlowSimulator.py <executable location> <patient folder path> <include clot>```

###	For pulsatile flow simulations
The executable location is located in Pulsatile_Model/Blood Flow Model/bin/Debug/

(If necessary, run ```chmod +x BloodflowModel.exe```)

Set Model=Pulsatile in the model_parameters.txt file to use this model.

```python3 Blood_Flow_1D/BloodFlowSimulator.py "Pulsatile_Model/Blood Flow Model/bin/Debug/BloodflowModel.exe" Generated_Patients/patient_0/ False```

### For steady state flow simulations
Set Model=Steady in the model_parameters.txt file to use this model.

```python3 Blood_Flow_1D/BloodFlowSimulator.py . Generated_Patients/patient_0/ False```

##	Additional modelling
### Detailed Collateral Model
The Collateral model can be run after the patient files are generated or new files can be generated by setting GenerateNewFiles=True. The model can be run by calling CollateralsSimulation.py with the location of the patient folder.
The collateral model uses the steady state model by default.

```python3 Blood_Flow_1D/CollateralsSimulation.py Generated_Patients/patient_0/```

### Contrast Model
The Contrast model can be run after the blood flow simulation by calling ContrastModel.py, a boolean and a duration.
True if the steady model has used, False for pulsatile model (option will be removed in future update).

```python3 Blood_Flow_1D/ContrastModel.py Generated_Patients/patient_0/ False 10```

# Notes
Installing scikits.umfpack also enables using UMFPACK solver via some of the scipy.sparse.linalg functions, for SciPy >= 0.14.0.

# Reference
Please cite this paper when using this software:
- ['Padmos, R. M., Arrarte Terreros, N., Jozsa, T. I., Zavodszky, G., Marquering, H. A., Majoie, C., Payne, S. J., & Hoekstra, A. G. (2022). Modelling collateral flow and thrombus permeability during acute ischaemic stroke. J R Soc Interface, 19(195), 20220649. https://doi.org/10.1098/rsif.2022.0649'](https://doi.org/10.1098/rsif.2022.0649) 

